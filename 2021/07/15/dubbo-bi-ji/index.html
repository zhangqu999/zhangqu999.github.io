<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Dubbo笔记, SpringBoot Java MySQL MA JavaGuy Math 算法">
    <meta name="baidu-site-verification" content="code-r7CYm21B6o" />
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48" />
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7" />
    <meta name="description" content="1、分布式系统相关概念1.1、大型互联网公司架构目标
传统项目和互联网项目

互联网项目：天猫，微信，百度
用户群体：网民
用户零忍耐


传统项目：OA，HR，CRM
用户群体：企业员工
员工忍耐度较高


用户体验：美观、功能、速度、稳">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dubbo笔记 | JavaGuy的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ce84511d3df71640a9378a69f6293044";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="JavaGuy的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JavaGuy的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">JavaGuy的博客</div>
        <div class="logo-desc">
            
            华中科技大学 | 计算机科学与技术 | 分布式云数据库内核
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '91a6f824b85ba9ed6e7cf599364e2f8bc897a465357160c6425c8eacd8883377';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/14.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Dubbo笔记
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/Dubbo/" target="_blank">
                            <span class="chip bg-color">Dubbo</span>
                        </a>
                        
                        <a href="/tags/Zookeeper/" target="_blank">
                            <span class="chip bg-color">Zookeeper</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/Java/" class="post-category" target="_blank">
                            Java
                        </a>
                        
                        <a href="/categories/Java/Dubbo/" class="post-category" target="_blank">
                            Dubbo
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-07-15
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    JavaGuy
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    18.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    78 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="1、分布式系统相关概念"><a href="#1、分布式系统相关概念" class="headerlink" title="1、分布式系统相关概念"></a>1、分布式系统相关概念</h1><h2 id="1-1、大型互联网公司架构目标"><a href="#1-1、大型互联网公司架构目标" class="headerlink" title="1.1、大型互联网公司架构目标"></a>1.1、大型互联网公司架构目标</h2><ul>
<li><p>传统项目和互联网项目</p>
<ul>
<li>互联网项目：天猫，微信，百度<ul>
<li>用户群体：网民</li>
<li>用户零忍耐</li>
</ul>
</li>
<li>传统项目：OA，HR，CRM<ul>
<li>用户群体：企业员工</li>
<li>员工忍耐度较高</li>
</ul>
</li>
<li>用户体验：美观、功能、速度、稳定性</li>
<li>如何衡量一个网站是否速度快：打开新页面0.36秒，页面跳转0.018秒</li>
</ul>
</li>
<li><p>互联网项目特点</p>
<ul>
<li>用户多</li>
<li>流量大，并发高</li>
<li>海量数据</li>
<li>易受攻击</li>
<li>功能繁琐</li>
<li>变更快</li>
</ul>
</li>
<li><p>高性能</p>
<ul>
<li>衡量网站性能指标<ul>
<li>响应时间：执行一个请求从开始到最后所花费的时间</li>
<li>并发数<ul>
<li>并发连接数：每秒服务器连接的TCP数量</li>
<li>请求数：也称QPS</li>
<li>并发用户数：单位时间内有多少用户</li>
</ul>
</li>
<li>吞度量：<ul>
<li>QPS：每秒查询数</li>
<li>TPS：每秒事务数</li>
<li>一个事务指：一个客户机向服务器发送请求后服务器做出反应的过程</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>高可用：网站服务一直可以访问</p>
</li>
<li><p>可伸缩：通过硬件增加/减少，提高/降低处理能力</p>
</li>
<li><p>高可扩展：系统间耦合低，方便通过新增/移除方式，增加/减少新的功能模块</p>
</li>
<li><p>安全性：提供网站安全访问和数据加密，安全存储等策略</p>
</li>
<li><p>敏捷性：随需应变，快速响应</p>
</li>
<li><p>集群和分布式</p>
<ul>
<li>集群：很多人一起，干一样的事</li>
<li>分布式：很多人一起，干不一样的事，合起来是一件大事</li>
</ul>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715105244184.png" alt="image-20210715105244184"></p>
</li>
<li><p>架构演进</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715105704949.png" alt="image-20210715105704949"></p>
<ul>
<li><p>单体项目</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715110009153.png" alt="image-20210715110009153"></p>
</li>
<li><p>垂直架构</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715110214828.png" alt="image-20210715110214828"></p>
</li>
<li><p>分布式架构</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715110451426.png" alt="image-20210715110451426"></p>
</li>
<li><p>SOA架构</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715110652271.png" alt="image-20210715110652271"></p>
</li>
<li><p>微服务架构</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715110834815.png" alt="image-20210715110834815"></p>
</li>
</ul>
</li>
</ul>
<h1 id="2、Dubbo概述"><a href="#2、Dubbo概述" class="headerlink" title="2、Dubbo概述"></a>2、Dubbo概述</h1><h2 id="2-1、Dubbo架构"><a href="#2-1、Dubbo架构" class="headerlink" title="2.1、Dubbo架构"></a>2.1、Dubbo架构</h2><p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715112242027.png" alt="image-20210715112242027"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715125526407.png" alt="image-20210715125526407"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715125612979.png" alt="image-20210715125612979"></p>
<h2 id="2-2、Dubbo高级特性"><a href="#2-2、Dubbo高级特性" class="headerlink" title="2.2、Dubbo高级特性"></a>2.2、Dubbo高级特性</h2><h3 id="2-2-1、Dubbo-admin安装和使用"><a href="#2-2-1、Dubbo-admin安装和使用" class="headerlink" title="2.2.1、Dubbo-admin安装和使用"></a>2.2.1、Dubbo-admin安装和使用</h3><p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715114946295.png" alt="image-20210715114946295"></p>
<h3 id="2-2-2、序列化"><a href="#2-2-2、序列化" class="headerlink" title="2.2.2、序列化"></a>2.2.2、序列化</h3><p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715114910287.png" alt="image-20210715114910287"></p>
<h3 id="2-2-3、地址缓存"><a href="#2-2-3、地址缓存" class="headerlink" title="2.2.3、地址缓存"></a>2.2.3、地址缓存</h3><p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715115310482.png" alt="image-20210715115310482"></p>
<h3 id="2-2-4、超时与重试"><a href="#2-2-4、超时与重试" class="headerlink" title="2.2.4、超时与重试"></a>2.2.4、超时与重试</h3><ul>
<li><p>超时：一般是在服务提供方配置，dubbo timeout调用方配置可以覆盖提供方</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715115937496.png" alt="image-20210715115937496"></p>
</li>
<li><p>重试：一般在服务提供方配置retries属性</p>
</li>
</ul>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715120210122.png" alt="image-20210715120210122"></p>
<h3 id="2-2-5、多版本"><a href="#2-2-5、多版本" class="headerlink" title="2.2.5、多版本"></a>2.2.5、多版本</h3><p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715123807507.png" alt="image-20210715123807507"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715125847691.png" alt="image-20210715125847691"></p>
<h3 id="2-2-6、负载均衡"><a href="#2-2-6、负载均衡" class="headerlink" title="2.2.6、负载均衡"></a>2.2.6、负载均衡</h3><p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715124323598.png" alt="image-20210715124323598"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715125909135.png" alt="image-20210715125909135"></p>
<h3 id="2-2-7、集群容错"><a href="#2-2-7、集群容错" class="headerlink" title="2.2.7、集群容错"></a>2.2.7、集群容错</h3><p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715124820274.png" alt="image-20210715124820274"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715130127096.png" alt="image-20210715130127096"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715130135493.png" alt="image-20210715130135493"></p>
<h3 id="2-2-8、服务降级"><a href="#2-2-8、服务降级" class="headerlink" title="2.2.8、服务降级"></a>2.2.8、服务降级</h3><p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715125139522.png" alt="image-20210715125139522"></p>
<h2 id="2-3、协议"><a href="#2-3、协议" class="headerlink" title="2.3、协议"></a>2.3、协议</h2><h3 id="2-3-1、dubbo"><a href="#2-3-1、dubbo" class="headerlink" title="2.3.1、dubbo://"></a>2.3.1、dubbo://</h3><ul>
<li>概述</li>
</ul>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715130708902.png" alt="image-20210715130708902"></p>
<ul>
<li><p>特性</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715130746244.png" alt="image-20210715130746244"></p>
</li>
<li><p>约束</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131156766.png" alt="image-20210715131156766"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131228907.png" alt="image-20210715131228907"></p>
</li>
<li><p>常见问题</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715130958166.png" alt="image-20210715130958166"></p>
</li>
</ul>
<h3 id="2-3-2、rmi"><a href="#2-3-2、rmi" class="headerlink" title="2.3.2、rmi://"></a>2.3.2、rmi://</h3><ul>
<li>概述</li>
</ul>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131332082.png" alt="image-20210715131332082"></p>
<ul>
<li><p>特性</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131357076.png" alt="image-20210715131357076"></p>
</li>
<li><p>约束</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131412612.png" alt="image-20210715131412612"></p>
</li>
</ul>
<h3 id="2-3-3、hessian"><a href="#2-3-3、hessian" class="headerlink" title="2.3.3、hessian://"></a>2.3.3、hessian://</h3><ul>
<li><p>概述</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131507266.png" alt="image-20210715131507266"></p>
</li>
<li><p>特性</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131525029.png" alt="image-20210715131525029"></p>
</li>
<li><p>约束</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131537799.png" alt="image-20210715131537799"></p>
</li>
</ul>
<h3 id="2-3-4、http"><a href="#2-3-4、http" class="headerlink" title="2.3.4、http://"></a>2.3.4、http://</h3><ul>
<li><p>概述</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131621884.png" alt="image-20210715131621884"></p>
</li>
<li><p>特性</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131654333.png" alt="image-20210715131654333"></p>
</li>
<li><p>约束</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131812807.png" alt="image-20210715131812807"></p>
</li>
</ul>
<h3 id="2-3-5、webservice"><a href="#2-3-5、webservice" class="headerlink" title="2.3.5、webservice://"></a>2.3.5、webservice://</h3><ul>
<li>概述</li>
</ul>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131901660.png" alt="image-20210715131901660"></p>
<ul>
<li><p>特性</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131920354.png" alt="image-20210715131920354"></p>
</li>
<li><p>约束</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210715131931602.png" alt="image-20210715131931602"></p>
</li>
</ul>
<h1 id="3、Zookeeper"><a href="#3、Zookeeper" class="headerlink" title="3、Zookeeper"></a>3、Zookeeper</h1><p><em>2020-4-28</em> ——<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1M741137qY?p=74">https://www.bilibili.com/video/BV1M741137qY?p=74</a></p>
<p><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/">https://zookeeper.apache.org/</a></p>
<h2 id="3-1、快速入门"><a href="#3-1、快速入门" class="headerlink" title="3.1、快速入门"></a>3.1、快速入门</h2><pre><code>ZooKeeper is a centralized service for maintaining configuration information, naming, providing distributed synchronization, and providing group services. All of these kinds of services are used in some form or another by distributed applications. Each time they are implemented there is a lot of work that goes into fixing the bugs and race conditions that are inevitable. Because of the difficulty of implementing these kinds of services, applications initially usually skimp on them, which make them brittle in the presence of change and difficult to manage. Even when done correctly, different implementations of these services lead to management complexity when the applications are deployed.
</code></pre>
<p><code>ZooKeeper</code>是一个集中的服务，用于维护配置信息、命名、提供分布式同步和提供组服务。所有这些类型的服务都以某种形式被分布式应用程序使用。每次它们被实现时，都会有大量的工作来修复不可避免的错误和竞争条件。由于实现这些服务的困难，应用程序最初通常会略过这些服务，这使得它们在出现更改时变得脆弱，并且难以管理。即使正确地执行了这些服务，在部署应用程序时，这些服务的不同实现也会导致管理复杂性</p>
<p><code>zookeeper</code>由雅虎研究院开发,是<code> Google Chubby</code>的开源实现,后来托管到 <code>Apache</code>,于<code>2010年11月</code>正式成为<code>apache</code>的顶级项目</p>
<p>大数据生态系统里由很多组件的命名都是某些动物或者昆虫，比如<code>hadoop</code>大象，<code>hive</code>就是蜂巢，<code>zookeeper</code>即管理员，顾名思义就算管理大数据生态系统各组件的管理员，如下所示：</p>
<p><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\zookeeper-1.png" alt="zookeeper-1"></p>
<h3 id="3-1-1、应用场景"><a href="#3-1-1、应用场景" class="headerlink" title="3.1.1、应用场景"></a>3.1.1、应用场景</h3><p><code>zookeepepr</code>是一个经典的<strong>分布式</strong>数据一致性解决方案，致力于为分布式应用提供一个高性能、高可用,且具有严格顺序访问控制能力的分布式协调存储服务。</p>
<ul>
<li>维护配置信息</li>
<li>分布式锁服务</li>
<li>集群管理</li>
<li>生成分布式唯一ID</li>
</ul>
<ol>
<li><p><strong>维护配置信息</strong></p>
<ul>
<li><p><code>java</code>编程经常会遇到配置项，比如数据库的<code>url</code>、 <code>schema</code>、<code>user</code>和 <code>password</code>等。通常这些配置项我们会放置在配置文件中，再将配置文件放置在服务器上当需要更改配置项时，需要去服务器上修改对应的配置文件。</p>
<p>但是随着分布式系统的兴起,由于许多服务都需要使用到该配置文件,因此有<strong>必须保证该配置服务的高可用性</strong>(<code>highavailability</code>)和各台服务器上配置数据的一致性。</p>
<p>通常会将配置文件部署在一个集群上，然而一个<strong>集群动辄上千台</strong>服务器，此时如果再一台台服务器逐个修改配置文件那将是非常繁琐且危险的的操作，因此就<strong>需要一种服务</strong>，<strong>能够高效快速且可靠地完成配置项的更改等操作</strong>，并能够保证各配置项在每台服务器上的数据一致性。</p>
<p><strong><code>zookeeper</code>就可以提供这样一种服务</strong>，其使用<code>Zab</code>这种一致性协议来保证一致性。现在有很多开源项目使用<code>zookeeper</code>来维护配置，如在 <code>hbase</code>中，客户端就是连接一个 <code>zookeeper</code>，获得必要的 <code>hbase</code>集群的配置信息，然后才可以进一步操作。还有在开源的消息队列 <code>kafka</code>中，也便用<code>zookeeper</code>来维护 <code>brokers</code>的信息。在 <code>alibaba</code>开源的<code>soa</code>框架<code>dubbo</code>中也广泛的使用<code>zookeeper</code>管理一些配置来实现服务治理。</p>
<p><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\zookeeper-2.png" alt="zookeeper-2"></p>
</li>
</ul>
</li>
<li><p>分布式锁服务</p>
<ul>
<li>一个集群是一个分布式系统，由多台服务器组成。为了提高并发度和可靠性，多台服务器上运行着同一种服务。当多个服务在运行时就需要协调各服务的进度，有时候需要保证当某个服务在进行某个操作时，其他的服务都不能进行该操作，即对该操作进行加锁，如果当前机器挂掉后，释放锁并 <code>fail over</code>到其他的机器继续执行该服务</li>
</ul>
</li>
<li><p>集群管理</p>
<ul>
<li><p>一个集群有时会因为各种软硬件故障或者网络故障，出现棊些服务器挂掉而被移除集群，而某些服务器加入到集群中的情况，<code>zookeeper</code>会将这些服务器加入/移出的情况通知给集群中的其他正常工作的服务器，以及时调整存储和计算等任务的分配和执行等。此外<code>zookeeper</code>还会对故障的服务器做出诊断并尝试修复。</p>
<p><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\zookeeper-3.png" alt="zookeeper-3"></p>
</li>
</ul>
</li>
<li><p>生产分布式唯一ID</p>
<ul>
<li><p>在过去的单库单表型系统中，通常可以使用数据库字段自带的<code>auto_ increment</code>属性来自动为每条记录生成一个唯一的<code>ID</code>。但是分库分表后，就无法在依靠数据库的<code>auto_ Increment</code>属性来唯一标识一条记录了。此时我们就可以用<code>zookeeper</code>在分布式环境下生成全局唯一<code>ID</code>。</p>
<p>做法如下:每次要生成一个新<code>id</code>时，创建一个持久顺序节点，创建操作返回的节点序号，即为新<code>id</code>，然后把比自己节点小的删除即可</p>
</li>
</ul>
</li>
</ol>
<h3 id="3-1-2、Zookeeper的设计目标"><a href="#3-1-2、Zookeeper的设计目标" class="headerlink" title="3.1.2、Zookeeper的设计目标"></a>3.1.2、Zookeeper的设计目标</h3><p><code>zooKeeper</code>致力于为分布式应用提供一个高性能、高可用，且具有严格顺序访问控制能力的分布式协调服务</p>
<ol>
<li>高性能<ul>
<li><code>zookeeper</code>将全量数据存储在<strong>内存</strong>中，并直接服务于客户端的所有非事务请求，尤其用于以读为主的应用场景</li>
</ul>
</li>
<li>高可用<ul>
<li><code>zookeeper</code>一般以集群的方式对外提供服务，一般<code>3~5</code>台机器就可以组成一个可用的 <code>Zookeeper</code>集群了，每台机器都会在内存中维护当前的服务器状态，井且每台机器之间都相互保持着通信。只要集群中超过一半的机器都能够正常工作，那么整个集群就能够正常对外服务</li>
</ul>
</li>
<li>严格顺序访问<ul>
<li>对于来自客户端的每个更新请求，<code>Zookeeper</code>都会分配一个全局唯一的递增编号，这个编号反应了所有事务操作的先后顺序</li>
</ul>
</li>
</ol>
<h3 id="3-1-3、数据模型"><a href="#3-1-3、数据模型" class="headerlink" title="3.1.3、数据模型"></a>3.1.3、数据模型</h3><p><code>zookeeper</code>的数据结点可以视为树状结构(或目录)，树中的各个结点被称为<code>znode </code>(即<code>zookeeper node</code>)，一个<code>znode</code>可以由多个子结点。<code>zookeeper</code>结点在结构上表现为树状；</p>
<p>使用路径<code>path</code>来定位某个<code>znode</code>，比如<code>/ns-1/itcast/mysqml/schemal1/table1</code>，此处<code>ns-1，itcast、mysql、schemal1、table1</code>分别是<code>根结点、2级结点、3级结点以及4级结点</code>；其中<code>ns-1</code>是<code>itcast</code>的父结点，<code>itcast</code>是<code>ns-1</code>的子结点，<code>itcast</code>是<code>mysql</code>的父结点….以此类推</p>
<p><code>znode</code>，间距文件和目录两种特点，即像文件一样维护着数据、元信息、ACL、时间戳等数据结构，又像目录一样可以作为路径标识的一部分</p>
<p><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\zookeeper-4.png" alt="zookeeper-4"></p>
<p>那么如何描述一个<code>znode</code>呢？一个<code>znode</code>大体上分为<code>3</code>个部分：</p>
<ul>
<li>结点的数据：即<code>znode data </code>(结点<code>path</code>，结点<code>data</code>)的关系就像是<code>Java map </code>中的 <code>key value </code>关系</li>
<li>结点的子结点<code>children</code></li>
<li>结点的状态<code>stat</code>：用来描述当前结点的创建、修改记录，包括<code>cZxid</code>、<code>ctime</code>等</li>
</ul>
<h4 id="结点状态stat的属性"><a href="#结点状态stat的属性" class="headerlink" title="结点状态stat的属性"></a>结点状态stat的属性</h4><p>在<code>zookeeper shell </code>中使用 <code>get </code>命令查看指定路径结点的<code>data</code>、<code>stat</code>信息</p>
<p><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\zookeeper-5.png" alt="zookeeper-5"></p>
<p>属性说明：</p>
<p>结点的各个属性如下。其中重要的概念是<code>Zxid(Zookeeper Transaction ID)</code>，<code>Zookeeper</code>结点的每一次更改都具有唯一的<code>Zxid</code>，如果<code>Zxid-1</code> 小于<code> Zxid-2</code> ，则<code>Zxid-1</code> 的更改发生在 <code>Zxid-2 </code>更改之前</p>
<p><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperProgrammers.html#sc_zkDataModel_znodes">https://zookeeper.apache.org/doc/r3.4.14/zookeeperProgrammers.html#sc_zkDataModel_znodes</a></p>
<ul>
<li><code>cZxid</code>数据结点创建时的事务ID——针对于<code>zookeeper</code>数据结点的管理：我们对结点数据的一些写操作都会导致<code>zookeeper</code>自动地为我们去开启一个事务，并且自动地去为每一个事务维护一个事务<code>ID</code></li>
<li><code>ctime</code>数据结点创建时的时间</li>
<li><code>mZxid</code>数据结点最后一次更新时的事务ID</li>
<li><code>mtime</code>数据结点最后一次更新时的时间</li>
<li><code>pZxid</code>数据节点最后一次修改此<code>znode</code>子节点更改的<code>zxid</code></li>
<li><code>cversion</code>子结点的更改次数</li>
<li><code>dataVersion</code>结点数据的更改次数</li>
<li><code>aclVersion</code>结点的ACL更改次数——类似<code>linux</code>的权限列表，维护的是当前结点的权限列表被修改的次数</li>
<li><code>ephemeralOwner</code>如果结点是临时结点，则表示创建该结点的会话的<code>SessionID</code>；如果是持久结点，该属性值为0</li>
<li><code>dataLength</code>数据内容的长度</li>
<li><code>numChildren</code>数据结点当前的子结点个数</li>
</ul>
<p><strong>结点类型</strong></p>
<p><code>zookeeper</code>中的结点有两种，分别为<strong>临时结点</strong>和<strong>永久结点</strong>。结点的类型在创建时被确定，并且不能改变</p>
<ul>
<li>临时节点：<ul>
<li>该节点的生命周期依赖于创建它们的会话。一旦会话( <code>Session</code>）结束，临时节点将被自动删除，当然可以也可以手动删除。虽然每个临时的 <code>Znode</code>都会绑定到一个客户端会话，但他们对所有的客户端还是可见的。另外，<code>Zookeeper</code>的临时节点不允许拥有子节点</li>
</ul>
</li>
<li>持久化结点：<ul>
<li>该结点的生命周期不依赖于会话，并且只有在客户端显示执行删除操作的时候，它们才能被删除</li>
</ul>
</li>
</ul>
<h3 id="3-1-4、单机安装"><a href="#3-1-4、单机安装" class="headerlink" title="3.1.4、单机安装"></a>3.1.4、单机安装</h3><p>测试系统环境<code>centos7.3</code></p>
<p><code>zookeeper:zookeeper-3.4.10.tar.gz</code></p>
<p><code>jdk:jdk-8u131-linux-x64.tar.gz</code></p>
<p><a target="_blank" rel="noopener" href="http://archive.apache.org/dist/zookeeper/">http://archive.apache.org/dist/zookeeper/</a></p>
<ol>
<li><p>在<code>centos </code>中使用 <code>root</code>用户创建 <code>zookeeper</code>用户，用户名:<code>zookeeper </code>密码:<code>zookeeper</code></p>
<ul>
<li><pre class="line-numbers language-shell"><code class="language-shell">useradd zookeeper
passwd zookeeper
su zookeeper
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p><code>zookeeper</code>底层依赖于jdk，<code>zookeeper</code>用户登录后，根目录下先进行jdk 的安装，jdk使用 <code>jdk-8u131-linux-x64.tar.gz</code></p>
<ul>
<li><pre><code>tar -zxf tar.gz
</code></pre>
</li>
</ul>
</li>
<li><p>配置jdk 环境变量</p>
<ul>
<li><pre class="line-numbers language-shell"><code class="language-shell">vi /etc/profile
JAVA_HOME=/home/zookeeper/jdk1.8.0_131
export JAVA_HOME

PATH=$JAVA_HOME/bin:$PATH
export PATH

souce /etc/profile
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>检测jdk安装</p>
<ul>
<li><code>java -version</code> // 如果反馈了Java信息，则成功</li>
</ul>
</li>
<li><p><code>zookeeper</code> 上传解压</p>
<ul>
<li><code>tar -zxf tar.gz</code></li>
</ul>
</li>
<li><p>为<code>zookeeper</code>准备配置文件</p>
<ul>
<li><pre class="line-numbers language-shell"><code class="language-shell"># 进入conf目录
cd /home/zookeeper/zookeeper-3.4.10/conf
# 复制配置文件
cp zoo_sampe.cfg zoo.cfg
# zookeeper 根目录下创建data目录
mkdir data
# vi 配置文件中的dataDir
# 此路径用于存储zookeeper中数据的内存快照、及事务日志文件，虽然zookeeper是使用内存的，但是需要持久化一些数据来保证数据的安全，和redis一样
dataDir=/home/zookeeper/zookeeper-3.4.10/data
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>启动<code>zookeeper</code></p>
<ul>
<li><pre class="line-numbers language-shell"><code class="language-shell"># 进入zookeeper的bin目录
cd /home/zookeeper/zookeeper-3.4.10/bin
# 启动zookeeper
./zkServer.sh start

# 启动: zkServer.sh start
# 停止: zkServer.sh stop
# 查看状态：zkServer.sh status

# 进入zookeeper 内部
./zkCli.sh
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
</ol>
<h3 id="3-1-5、常用shell命令"><a href="#3-1-5、常用shell命令" class="headerlink" title="3.1.5、常用shell命令"></a>3.1.5、常用shell命令</h3><p><code>zookeeper</code>——<code>getting started</code>——<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperStarted.html#sc_FileManagement">https://zookeeper.apache.org/doc/r3.4.14/zookeeperStarted.html#sc_FileManagement</a></p>
<h3 id="3-1-6、操作结点"><a href="#3-1-6、操作结点" class="headerlink" title="3.1.6、操作结点"></a>3.1.6、操作结点</h3><h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a><strong>查询</strong></h4><p><code>get /hadoop</code>  查看结点的数据和属性     <code>stat /hadoop</code> 查看结点的属性</p>
<h4 id="创建"><a href="#创建" class="headerlink" title="创建"></a><strong>创建</strong></h4><p>创建结点并写入数据：</p>
<p><code>create [-s] [-e] path data</code> # 其中 -s 为有序结点，-e 临时结点（默认是持久结点）</p>
<pre class="line-numbers language-shell"><code class="language-shell">create /hadoop "123456"  # 此时，如果quit退出后再./ZkCient.sh 登入
                         # 再用输入 get /hadoop 获取，结点依然存在(永久结点)
                       
create -s /a "a"         # 创建一个持久化有序结点，创建的时候可以观察到返回的数据带上了一个id       
create -s /b "b"         # 返回的值，id递增了

create -s -e /aa "aa"    # 依然还会返回自增的id，quit后再进来，继续创建，id依然是往后推的

create /aa/xx            # 继续创建结点，可以看到pZxid变化了
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="更新"><a href="#更新" class="headerlink" title="更新"></a><strong>更新</strong></h4><p>更新结点的命令是<code>set</code>，可以直接进行修改，如下：</p>
<p><code>set path [version]</code></p>
<pre class="line-numbers language-shell"><code class="language-shell">set /hadoop "345"        # 修改结点值

set /hadoop "hadoop-x" 1 # 也可以基于版本号进行更改，类似于乐观锁，当传入版本号(dataVersion)
                         # 和当前结点的数据版本号不一致时，zookeeper会拒绝本次修改
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="删除"><a href="#删除" class="headerlink" title="删除"></a><strong>删除</strong></h4><p>删除结点的语法如下：</p>
<p><code>delete path [version]</code> 和 <code>set</code> 方法相似，也可以传入版本号</p>
<pre class="line-numbers language-shell"><code class="language-shell">delete /hadoop           # 删除结点delete /hadoop 1         # 乐观锁机制，与set 方法一致
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>要想删除某个结点及其所有后代结点，可以使用递归删除，命令为 <code>rmr path</code></p>
<h4 id="查看结点列表"><a href="#查看结点列表" class="headerlink" title="查看结点列表"></a><strong>查看结点列表</strong></h4><pre class="line-numbers language-shell"><code class="language-shell">ls /hadoop               # 可以查看结点的列表ls2 /hadoop              # 可以查看结点的列表以及目标结点的信息ls /                     # 根节点
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="监听器get-path-watch-stat-path-watch"><a href="#监听器get-path-watch-stat-path-watch" class="headerlink" title="监听器get path [watch] | stat path [watch]"></a><strong>监听器get path [watch] | stat path [watch]</strong></h4><p>使用<code>get path [watch]</code> 注册的监听器能够在结点<strong>内容发生改变</strong>的时候，向客户端发出通知。需要注意的是<code>zookeeper</code>的触发器是一次性的(<code>One-time trigger</code>)，即触发一次后就会立即失效</p>
<pre class="line-numbers language-shell"><code class="language-shell">get /hadoop watch        # get 的时候添加监听器，当值改变的时候，监听器返回消息set /hadoop 45678        # 测试
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="ls-ls2-path-watch"><a href="#ls-ls2-path-watch" class="headerlink" title="ls\ls2 path [watch]"></a><strong>ls\ls2 path [watch]</strong></h4><p>使用 <code>ls path [watch] 或 ls2 path [watch] </code>注册的监听器能够监听该结点下<strong>所有子节点</strong>的<strong>增加</strong>和<strong>删除</strong>操作</p>
<pre class="line-numbers language-shell"><code class="language-shell">ls /hadoop watch         # 添加监听器set /hadoop/node "node"
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="3-1-7、zookeeper的Acl权限控制"><a href="#3-1-7、zookeeper的Acl权限控制" class="headerlink" title="3.1.7、zookeeper的Acl权限控制"></a>3.1.7、zookeeper的Acl权限控制</h3><p><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperProgrammers.html#sc_ZooKeeperAccessControl">https://zookeeper.apache.org/doc/r3.4.14/zookeeperProgrammers.html#sc_ZooKeeperAccessControl</a></p>
<p><code>zookeeper </code>类似文件系统，<code>client</code>可以创建结点、更新结点、删除结点，那么如何做到结点的权限控制呢？</p>
<p><code>zookeeper</code>的 <code>access control list</code> 访问控制列表可以做到这一点</p>
<p><code>acl</code>权限控制，使用<code>scheme：id：permission </code>来标识，主要涵盖3个方面：</p>
<p><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperProgrammers.html#sc_BuiltinACLSchemes">https://zookeeper.apache.org/doc/r3.4.14/zookeeperProgrammers.html#sc_BuiltinACLSchemes</a></p>
<ul>
<li>权限模式(<code>scheme</code>)：授权的策略</li>
<li>授权对象(<code>id</code>)：授权的对象</li>
<li>权限(<code>permission</code>)：授予的权限</li>
</ul>
<p>其特性如下：</p>
<ul>
<li><p><code>zookeeper</code>的权限控制是基于每个<code>znode</code>结点的，需要对每个结点设置权限</p>
</li>
<li><p>每个<code>znode </code>支持多种权限控制方案和多个权限</p>
</li>
<li><p>子结点不会继承父结点的权限，客户端无权访问某结点，但可能可以访问它的子结点：</p>
<p>例如<code>setAcl /test2 ip:192.168.133.133:crwda</code>  // 将结点权限设置为Ip：192.168.133.133 的客户端可以对节点进行<br>增删改查和管理权限</p>
</li>
</ul>
<p><strong>权限模式</strong></p>
<ul>
<li><p>采用何种方式授权</p>
</li>
<li></li>
<li><table>
<thead>
<tr>
<th>方案</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>world</td>
<td>只有一个用户：<code>anyone</code>，代表登录<code>zookeeper</code>所有人(默认)</td>
</tr>
<tr>
<td>ip</td>
<td>对客户端使用IP地址认证</td>
</tr>
<tr>
<td>auth</td>
<td>使用已添加认证的用户认证</td>
</tr>
<tr>
<td>digest</td>
<td>使用”用户名：密码”方式认证</td>
</tr>
</tbody></table>
</li>
</ul>
<p><strong>授权对象</strong></p>
<ul>
<li>给谁授予权限</li>
<li>授权对象ID是指，权限赋予的实体，例如：IP地址或用户</li>
</ul>
<p><strong>授权的权限</strong></p>
<ul>
<li><p>授予什么权限</p>
</li>
<li><p><code>create、delete、read、writer、admin</code>也就是 增、删、查、改、管理权限，这5种权限简写为 c d r w a，注意：<br>这五种权限中，有的权限并不是对结点自身操作的例如：delete是指对<strong>子结点</strong>的删除权限</p>
<p>可以试图删除父结点，但是子结点必须删除干净，所以<code>delete</code>的权限也是很有用的</p>
</li>
<li></li>
<li><table>
<thead>
<tr>
<th>权限</th>
<th>ACL简写</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>create</td>
<td>c</td>
<td>可以创建子结点</td>
</tr>
<tr>
<td>delete</td>
<td>d</td>
<td>可以删除子结点(仅下一级结点)</td>
</tr>
<tr>
<td>read</td>
<td>r</td>
<td>可以读取结点数据以及显示子结点列表</td>
</tr>
<tr>
<td>write</td>
<td>w</td>
<td>可以设置结点数据</td>
</tr>
<tr>
<td>admin</td>
<td>a</td>
<td>可以设置结点访问控制权限列表</td>
</tr>
</tbody></table>
</li>
</ul>
<p><strong>授权的相关命令</strong></p>
<ul>
<li></li>
<li><table>
<thead>
<tr>
<th>命令</th>
<th>使用方式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>getAcl</td>
<td>getAcl</td>
<td>读取ACL权限</td>
</tr>
<tr>
<td>setAcl</td>
<td>setAcl</td>
<td>设置ACL权限</td>
</tr>
<tr>
<td>addauth</td>
<td>addauth</td>
<td>添加认证用户</td>
</tr>
</tbody></table>
</li>
</ul>
<h4 id="案例-远程登录"><a href="#案例-远程登录" class="headerlink" title="案例/远程登录"></a>案例/远程登录</h4><p><strong><code>./zkServer.sh -server 192.168.133.133</code></strong> 可以远程登录</p>
<p><strong>world权限模式</strong></p>
<ul>
<li><code>getAcl /node</code> // 读取权限信息</li>
<li><code>setAcl /node world:anyone:drwa</code> // 设置权限(禁用创建子结点的权限)</li>
</ul>
<p><strong>ip模式</strong></p>
<p><code>./zkServer.sh -server 192.168.133.133</code> 可以远程登录</p>
<ul>
<li><code>setAcl /hadoop ip:192.168.133.133:drwa</code></li>
<li>如果在两台不同的虚拟机中，另一台用远程连接的模式，进行上面这条命令，那么只会有一台被授权</li>
<li>需要两台虚拟机一起授权的话需要用<strong>逗号</strong>将授权列表隔开：<code>setAcl /hadoop ip:192.168.133.133:cdrwa,ip:192.168.133.132:cdrwa</code></li>
</ul>
<p><strong>auth认证用户模式</strong></p>
<p><strong><code>addauth digest &lt;user&gt;:&lt;password&gt;</code></strong></p>
<p><strong><code>setAcl &lt;path&gt; auth:&lt;user&gt;:&lt;acl&gt;</code></strong></p>
<ul>
<li><pre class="line-numbers language-shell"><code class="language-shell">create /hadoop "hadoop"           # 初始化测试用的结点addauth digest itcast:123456      # 添加认证用户setAcl /hadoop auth:itcast:cdrwa  # 设置认证用户quit                              # 退出后再./zkCli.sh 进入get /hadoop                       # 这个时候就没有权限了，需要再次认证addauth digest itcast:123456      # 认证，密码错了的话 zookeeper 不会报错，但是不能认证get /hadoop
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p><strong>Digest授权模式</strong></p>
<p><strong><code>setAcl &lt;path&gt; digest:&lt;user&gt;:&lt;password&gt;:&lt;acl&gt;</code></strong></p>
<ul>
<li><p>这里的密码是经过<code>SHA1</code>以及<code>BASE64</code>处理的密文，在shell 中可以通过以下命令计算：</p>
<ul>
<li><pre class="line-numbers language-shell"><code class="language-shell">echo -n <user>:<password> | openssl dgst -binary -sha1 | openssl base64
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><pre class="line-numbers language-shell"><code class="language-shell"># 计算密码echo -n itcast:12345 | openssl dgst -binary -sha1 | openssl base64# 获取密码，设置权限列表setAcl /hadoop digest:itcast:qUFSHxJjItUW/93UHFXFVGlvryY=:cdrwa# 现在想要get /hadoop 需要登录了addauth digest itcast:12345get /hadoop
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
<p><strong>多种授权模式</strong></p>
<p>仅需逗号隔开</p>
<ul>
<li><pre class="line-numbers language-shell"><code class="language-shell">setAcl /hadoop ip:192.168.133.132:cdrwa,auth:hadoop:cdrwa,digest:itcast:673OfZhUE8JEFMcu0l64qI8e5ek=:cdrwa
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h4 id="acl-超级管理员"><a href="#acl-超级管理员" class="headerlink" title="acl 超级管理员"></a>acl 超级管理员</h4><ul>
<li><p><code>zookeeper</code>的权限管理模式有一种叫做<code>super</code>，该模式提供一个超管，可以方便的访问任何权限的节点</p>
<p>假设这个超管是<code>supper:admin</code>，需要为超管生产密码的密文</p>
<pre class="line-numbers language-shell"><code class="language-shell">echo -n super:admin | openssl dgst -binary -sha1 | openssl base64
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>那么打开<code>zookeeper</code>目录下<code>/bin/zkServer.sh</code>服务器脚本文件，找到如下一行：</p>
<pre class="line-numbers language-shell"><code class="language-shell"> /nohup # 快速查找，可以看到如下 nohup "$JAVA" "-Dzookeeper.log.dir=$&#123;ZOO_LOG_DIR&#125;" "-Dzookeeper.root.logger=$&#123;ZOO_LOG4J_PROP&#125;"
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>这个就算脚本中启动<code>zookeeper</code>的命令，默认只有以上两个配置项，我们需要添加一个超管的配置项</p>
<pre><code>&quot;-Dzookeeper.DigestAuthenticationProvider.superDigest=super:xQJmxLMiHGwaqBvst5y6rkB6HQs=&quot;
</code></pre>
</li>
<li><p>修改后命令变成如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">nohup "$JAVA" "-Dzookeeper.log.dir=$&#123;ZOO_LOG_DIR&#125;" "-Dzookeeper.root.logger=$&#123;ZOO_LOG4J_PROP&#125;" "-Dzookeeper.DigestAuthenticationProvider.superDigest=super:xQJmxLMiHGwaqBvst5y6rkB6HQs="
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><pre class="line-numbers language-shell"><code class="language-shell"># 重起后，现在随便对任意节点添加权限限制setAcl /hadoop ip:192.168.1.1:cdrwa # 这个ip并非本机# 现在当前用户没有权限了getAcl /hadoop# 登录超管addauth digest super:admin# 强行操作节点get /hadoop
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h3 id="3-1-8、zookeeper的-JavaAPI"><a href="#3-1-8、zookeeper的-JavaAPI" class="headerlink" title="3.1.8、zookeeper的 JavaAPI"></a>3.1.8、zookeeper的 JavaAPI</h3><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.101tec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>zkclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>slf4j-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.4.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>zonde </code>是 <code>zookeeper </code>集合的核心组件，<code> zookeeper API</code> 提供了一小组使用 <code>zookeeper </code>集群来操作<code>znode </code>的所有细节</p>
<p>客户端应该遵循以下步骤，与<code>zookeeper</code>服务器进行清晰和干净的交互</p>
<ul>
<li>连接到<code>zookeeper</code>服务器。<code>zookeeper</code>服务器为客户端分配会话<code>ID</code></li>
<li>定期向服务器发送心跳。否则，<code>zookeeper </code>服务器将过期会话<code>ID</code>，客户端需要重新连接</li>
<li>只要会话<code>Id</code>处于活动状态，就可以获取/设置<code>znode</code></li>
<li>所有任务完成后，断开与<code>zookeeper</code>服务器连接，如果客户端长时间不活动，则<code>zookeeper</code>服务器将自动断开客户端</li>
</ul>
<h4 id="连接到Zookeeper"><a href="#连接到Zookeeper" class="headerlink" title="连接到Zookeeper"></a>连接到Zookeeper</h4><p>这部分，官网的解释十分稀少<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperStarted.html#sc_ConnectingToZooKeeper">https://zookeeper.apache.org/doc/r3.4.14/zookeeperStarted.html#sc_ConnectingToZooKeeper</a></p>
<pre><code>[zkshell: 0] helpZooKeeper host:port cmd args    get path [watch]    ls path [watch]    set path data [version]    delquota [-n|-b] path    quit    printwatches on|off    create path data acl    stat path [watch]    listquota path    history    setAcl path acl    getAcl path    sync path    redo cmdno    addauth scheme auth    delete path [version]    deleteall path    setquota -n|-b val path
</code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token function">Zookeeper</span><span class="token punctuation">(</span>String connectionString<span class="token punctuation">,</span> <span class="token keyword">int</span> sessionTimeout<span class="token punctuation">,</span> watcher watcher<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>connectionString</code> - <code>zookeeper </code>主机</li>
<li><code>sessionTimeout </code>- 会话超时</li>
<li><code>watcher</code> - 实现”监听器” 对象。<code>zookeeper</code>集合通过监视器对象返回连接状态</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        CountDownLatch countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ZooKeeper zookeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"192.168.133.133:2181"</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>WatchedEvent x<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"连接成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>zookeeper<span class="token punctuation">.</span><span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        zookeeper<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="新增节点"><a href="#新增节点" class="headerlink" title="新增节点"></a>新增节点</h5><ul>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 同步create(String path, byte[] data, List&lt;ACL> acl, CreateMode createMode)// 异步create(String path, byte[] data, List&lt;ACL> acl, CreateMode createMode,      AsynCallback.StringCallback callBack, Object ctx)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li></li>
<li><table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>path</code></td>
<td><code>znode </code>路径</td>
</tr>
<tr>
<td><code>data</code></td>
<td>数据</td>
</tr>
<tr>
<td><code>acl</code></td>
<td>要创建的节点的访问控制列表。<code>zookeeper API </code>提供了一个静态接口 <code>ZooDefs.Ids</code> 来获取一些基本的<code>acl</code>列表。例如，<code>ZooDefs.Ids.OPEN_ACL_UNSAFE</code>返回打开<code>znode</code>的<code>acl</code>列表</td>
</tr>
<tr>
<td><code>createMode</code></td>
<td>节点的类型，这是一个枚举</td>
</tr>
<tr>
<td><code>callBack</code></td>
<td>异步回调接口</td>
</tr>
<tr>
<td><code>ctx</code></td>
<td>传递上下文参数</td>
</tr>
</tbody></table>
</li>
</ul>
<p>示例：</p>
<ul>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 枚举的方式    public static void createTest1() throws Exception&amp;#123;        String str = "node";        String s = zookeeper.create("/node", str.getBytes(),                ZooDefs.Ids.READ_ACL_UNSAFE, CreateMode.PERSISTENT);        System.out.println(s);    &amp;#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 自定义的方式    public static void createTest2() throws Exception&amp;#123;        ArrayList&lt;ACL> acls = new ArrayList&lt;>();        Id id = new Id("ip","192.168.133.133");        acls.add(new ACL(ZooDefs.Perms.ALL,id));        zookeeper.create("/create/node4","node4".getBytes(),acls,CreateMode.PERSISTENT);    &amp;#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// auth    public static void createTest3() throws  Exception&amp;#123;        zookeeper.addAuthInfo("digest","itcast:12345".getBytes());        zookeeper.create("/node5","node5".getBytes(),                ZooDefs.Ids.CREATOR_ALL_ACL,CreateMode.PERSISTENT);    &amp;#125;// 自定义的方式    public static void createTest3() throws  Exception&amp;#123;//        zookeeper.addAuthInfo("digest","itcast:12345".getBytes());//        zookeeper.create("/node5","node5".getBytes(),//                ZooDefs.Ids.CREATOR_ALL_ACL,CreateMode.PERSISTENT);        zookeeper.addAuthInfo("digest","itcast:12345".getBytes());        List&lt;ACL> acls = new ArrayList&lt;>();        Id id = new Id("auth","itcast");        acls.add(new ACL(ZooDefs.Perms.READ,id));        zookeeper.create("/create/node6","node6".getBytes(),                acls,CreateMode.PERSISTENT);    &amp;#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// digest public static void createTest3() throws  Exception&amp;#123;    List&lt;ACL> acls = new ArrayList&lt;>();    Id id = new Id("digest","itcast:qUFSHxJjItUW/93UHFXFVGlvryY=");    acls.add(new ACL(ZooDefs.Perms.READ,id));    zookeeper.create("/create/node7","node7".getBytes(),                          acls,CreateMode.PERSISTENT);&amp;#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 异步    public static void createTest4() throws  Exception&amp;#123;        zookeeper.create("/node12", "node12".getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT, new AsyncCallback.StringCallback()&amp;#123;            </span><span class="token comment" spellcheck="true">/**             * @param rc 状态，0 则为成功，以下的所有示例都是如此             * @param path 路径             * @param ctx 上下文参数             * @param name 路径             */</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> rc<span class="token punctuation">,</span> String path<span class="token punctuation">,</span> Object ctx<span class="token punctuation">,</span> String name<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>rc <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> name <span class="token operator">+</span>  <span class="token string">" "</span> <span class="token operator">+</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span> <span class="token string">"I am context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h5 id="修改节点"><a href="#修改节点" class="headerlink" title="修改节点"></a>修改节点</h5><p>同样也有两种修改方式(<code>异步和同步</code>)</p>
<ul>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 同步setData(String path, byte[] data, int version)// 异步setData(String path, byte[] data, int version, StatCallback callBack, Object ctx)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li></li>
<li><table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>path</code></td>
<td>节点路径</td>
</tr>
<tr>
<td><code>data</code></td>
<td>数据</td>
</tr>
<tr>
<td><code>version</code></td>
<td>数据的版本号， -<code>1</code>代表不使用版本号，乐观锁机制</td>
</tr>
<tr>
<td><code>callBack</code></td>
<td>异步回调 <code>AsyncCallback.StatCallback</code>，和之前的回调方法参数不同，这个可以获取节点状态</td>
</tr>
<tr>
<td><code>ctx</code></td>
<td>传递上下文参数</td>
</tr>
</tbody></table>
</li>
<li><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// arg1:节点的路径        // arg2:修改的数据        // arg3:数据的版本号 -1 代表版本号不参与更新        Stat stat = zookeeper.setData("/hadoop","hadoop-1".getBytes(),-1);    &amp;#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        zookeeper<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"/hadoop"</span><span class="token punctuation">,</span> <span class="token string">"hadoop-1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>StatCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> rc<span class="token punctuation">,</span> String path<span class="token punctuation">,</span> Object ctx<span class="token punctuation">,</span> Stat stat<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 讲道理，要判空                System.out.println(rc + " " + path + " " + stat.getVersion() +  " " + ctx);            &amp;#125;        &amp;#125;, "I am context");    &amp;#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h5 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h5><p>异步、同步</p>
<ul>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 同步delete(String path, int version)// 异步delete(String path, int version, AsyncCallback.VoidCallback callBack, Object ctx)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li></li>
<li><table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>path</code></td>
<td>节点路径</td>
</tr>
<tr>
<td><code>version</code></td>
<td>版本</td>
</tr>
<tr>
<td><code>callBack</code></td>
<td>数据的版本号， -<code>1</code>代表不使用版本号，乐观锁机制</td>
</tr>
<tr>
<td><code>ctx</code></td>
<td>传递上下文参数</td>
</tr>
</tbody></table>
</li>
<li><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deleteData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        zookeeper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"/hadoop"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deleteData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        zookeeper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"/hadoop"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>VoidCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> rc<span class="token punctuation">,</span> String path<span class="token punctuation">,</span> Object ctx<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>rc <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span> <span class="token string">"I am context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h5 id="查看节点"><a href="#查看节点" class="headerlink" title="查看节点"></a>查看节点</h5><p>同步、异步</p>
<ul>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 同步getData(String path, boolean watch, Stat stat)getData(String path, Watcher watcher, Stat stat)// 异步getData(String path, boolean watch, DataCallback callBack, Object ctx)getData(String path, Watcher watcher, DataCallback callBack, Object ctx)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li></li>
<li><table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>path</code></td>
<td>节点路径</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td>是否使用连接对象中注册的监听器</td>
</tr>
<tr>
<td><code>stat</code></td>
<td>元数据</td>
</tr>
<tr>
<td><code>callBack</code></td>
<td>异步回调接口，可以获得状态和数据</td>
</tr>
<tr>
<td><code>ctx</code></td>
<td>传递上下文参数</td>
</tr>
</tbody></table>
</li>
<li><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        Stat stat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> zookeeper<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/hadoop"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 判空        System.out.println(stat.getCtime());    &amp;#125;    public static void getData2() throws Exception &amp;#123;        zookeeper.getData("/hadoop", false, new AsyncCallback.DataCallback() &amp;#123;            @Override            public void processResult(int rc, String path, Object ctx, byte[] bytes, Stat stat) &amp;#123;                // 判空                System.out.println(rc + " " + path                                   + " " + ctx + " " + new String(bytes) + " " +                                    stat.getCzxid());            &amp;#125;        &amp;#125;, "I am context");        TimeUnit.SECONDS.sleep(3);    &amp;#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h5 id="查看子节点"><a href="#查看子节点" class="headerlink" title="查看子节点"></a>查看子节点</h5><p>同步、异步</p>
<ul>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 同步getChildren(String path, boolean watch)getChildren(String path, Watcher watcher)getChildren(String path, boolean watch, Stat stat)    getChildren(String path, Watcher watcher, Stat stat)// 异步getChildren(String path, boolean watch, ChildrenCallback callBack, Object ctx)    getChildren(String path, Watcher watcher, ChildrenCallback callBack, Object ctx)getChildren(String path, Watcher watcher, Children2Callback callBack, Object ctx)    getChildren(String path, boolean watch, Children2Callback callBack, Object ctx)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li></li>
<li><table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>path</code></td>
<td>节点路径</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td></td>
</tr>
<tr>
<td><code>callBack</code></td>
<td>异步回调，可以获取节点列表</td>
</tr>
<tr>
<td><code>ctx</code></td>
<td>传递上下文参数</td>
</tr>
</tbody></table>
</li>
<li><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getChildren_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>String<span class="token operator">></span> hadoop <span class="token operator">=</span> zookeeper<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token string">"/hadoop"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hadoop<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getChildren_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        zookeeper<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token string">"/hadoop"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>ChildrenCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> rc<span class="token punctuation">,</span> String path<span class="token punctuation">,</span> Object ctx<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> list<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>rc <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span> <span class="token string">"I am children"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h5 id="检查节点是否存在"><a href="#检查节点是否存在" class="headerlink" title="检查节点是否存在"></a>检查节点是否存在</h5><p>同步、异步</p>
<ul>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 同步exists(String path, boolean watch)exists(String path, Watcher watcher)// 异步exists(String path, boolean watch, StatCallback cb, Object ctx)exists(String path, Watcher watcher, StatCallback cb, Object ctx)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li></li>
<li><table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>path</code></td>
<td>节点路径</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td></td>
</tr>
<tr>
<td><code>callBack</code></td>
<td>异步回调，可以获取节点列表</td>
</tr>
<tr>
<td><code>ctx</code></td>
<td>传递上下文参数</td>
</tr>
</tbody></table>
</li>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">exists1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    Stat exists <span class="token operator">=</span> zookeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">"/hadoopx"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 判空    System.out.println(exists.getVersion() + "成功");&amp;#125;public static void exists2() throws Exception&amp;#123;    zookeeper.exists("/hadoopx", false, new AsyncCallback.StatCallback() &amp;#123;        @Override        public void processResult(int rc, String path, Object ctx, Stat stat) &amp;#123;            // 判空            System.out.println(rc + " " + path + " " + ctx +" " + stat.getVersion());        &amp;#125;    &amp;#125;, "I am children");    TimeUnit.SECONDS.sleep(1);&amp;#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h3 id="3-1-9、事件监听机制"><a href="#3-1-9、事件监听机制" class="headerlink" title="3.1.9、事件监听机制"></a>3.1.9、事件监听机制</h3><p><strong>watcher概念</strong></p>
<p><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperProgrammers.html#sc_WatchRememberThese">https://zookeeper.apache.org/doc/r3.4.14/zookeeperProgrammers.html#sc_WatchRememberThese</a></p>
<ul>
<li><code>zookeeper</code>提供了数据的<code>发布/订阅</code>功能，多个订阅者可同时监听某一特定主题对象，当该主题对象的自身状态发生变化时例如节点内容改变、节点下的子节点列表改变等，会实时、主动通知所有订阅者</li>
<li><code>zookeeper</code>采用了 <code>Watcher</code>机制实现数据的发布订阅功能。该机制在被订阅对象发生变化时会异步通知客户端，因此客户端不必在 <code>Watcher</code>注册后轮询阻塞，从而减轻了客户端压力</li>
<li><code>watcher</code>机制事件上与观察者模式类似，也可看作是一种观察者模式在分布式场景下的实现方式</li>
</ul>
<h4 id="watcher架构"><a href="#watcher架构" class="headerlink" title="watcher架构"></a>watcher架构</h4><p><code>watcher</code>实现由三个部分组成</p>
<ul>
<li><code>zookeeper</code>服务端</li>
<li><code>zookeeper</code>客户端</li>
<li>客户端的<code>ZKWatchManager对象</code></li>
</ul>
<p>客户端<strong>首先将 <code>Watcher</code>注册到服务端</strong>，同时将 <code>Watcher</code>对象<strong>保存到客户端的<code>watch</code>管理器中</strong>。当<code>Zookeeper</code>服务端监听的数据状态发生变化时，服务端会<strong>主动通知客户端</strong>，接着客户端的 <code>Watch</code>管理器会**触发相关 <code>Watcher</code>**来回调相应处理逻辑，从而完成整体的数据 <code>发布/订阅</code>流程</p>
<p><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\zookeeper-6.png" alt="zookeeper-6"></p>
<h4 id="watcher特性"><a href="#watcher特性" class="headerlink" title="watcher特性"></a>watcher特性</h4><ul>
<li></li>
<li><table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>一次性</td>
<td><code>watcher</code>是<strong>一次性</strong>的，一旦被触发就会移除，再次使用时需要重新注册</td>
</tr>
<tr>
<td>客户端顺序回调</td>
<td><code>watcher</code>回调是<strong>顺序串行</strong>执行的，只有回调后客户端才能看到最新的数据状态。一个<code>watcher</code>回调逻辑不应该太多，以免影响别的<code>watcher</code>执行</td>
</tr>
<tr>
<td>轻量级</td>
<td><code>WatchEvent</code>是最小的通信单位，结构上只包含<strong>通知状态、事件类型和节点路径</strong>，并不会告诉数据节点变化前后的具体内容</td>
</tr>
<tr>
<td>时效性</td>
<td><code>watcher</code>只有在当前<code>session</code>彻底失效时才会无效，若在<code>session</code>有效期内快速重连成功，则<code>watcher</code>依然存在，仍可接收到通知；</td>
</tr>
</tbody></table>
</li>
</ul>
<p><strong>watcher接口设计</strong></p>
<p><code>Watcher</code>是一个接口，任何实现了<code>Watcher</code>接口的类就算一个新的<code>Watcher</code>。<code>Watcher</code>内部包含了两个枚举类：<code>KeeperState</code>、<code>EventType</code></p>
<p><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\zookeeper-7.png" alt="zookeeper-7"></p>
<h5 id="Watcher通知状态-KeeperState"><a href="#Watcher通知状态-KeeperState" class="headerlink" title="Watcher通知状态(KeeperState)"></a>Watcher通知状态(KeeperState)</h5><p><code>KeeperState</code>是客户端与服务端<strong>连接状态</strong>发生变化时对应的通知类型。路径为<code>org.apache.zookeeper.Watcher.EventKeeperState</code>，是一个枚举类，其枚举属性如下：</p>
<ul>
<li></li>
<li><table>
<thead>
<tr>
<th>枚举属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>SyncConnected</code></td>
<td>客户端与服务器正常连接时</td>
</tr>
<tr>
<td><code>Disconnected</code></td>
<td>客户端与服务器断开连接时</td>
</tr>
<tr>
<td><code>Expired</code></td>
<td>会话<code>session</code>失效时</td>
</tr>
<tr>
<td><code>AuthFailed</code></td>
<td>身份认证失败时</td>
</tr>
</tbody></table>
</li>
</ul>
<h5 id="Watcher事件类型-EventType"><a href="#Watcher事件类型-EventType" class="headerlink" title="Watcher事件类型(EventType)"></a>Watcher事件类型(EventType)</h5><p><code>EventType</code>是<strong>数据节点<code>znode</code>发生变化</strong>时对应的通知类型。**<code>EventType</code>变化时<code>KeeperState</code>永远处于<code>SyncConnected</code>通知状态下**；当<code>keeperState</code>发生变化时，<code>EventType</code>永远为<code>None</code>。其路径为<code>org.apache.zookeeper.Watcher.Event.EventType</code>，是一个枚举类，枚举属性如下：</p>
<ul>
<li></li>
<li><table>
<thead>
<tr>
<th>枚举属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>None</code></td>
<td>无</td>
</tr>
<tr>
<td><code>NodeCreated</code></td>
<td><code>Watcher</code>监听的数据节点被创建时</td>
</tr>
<tr>
<td><code>NodeDeleted</code></td>
<td><code>Watcher</code>监听的数据节点被删除时</td>
</tr>
<tr>
<td><code>NodeDataChanged</code></td>
<td><code>Watcher</code>监听的数据节点内容发生更改时(无论数据是否真的变化)</td>
</tr>
<tr>
<td><code>NodeChildrenChanged</code></td>
<td><code>Watcher</code>监听的数据节点的子节点列表发生变更时</td>
</tr>
</tbody></table>
</li>
<li><p>注意：客户端接收到的相关事件通知中只包含状态以及类型等信息，不包含节点变化前后的具体内容，变化前的数据需业务自身存储，变化后的数据需要调用<code>get</code>等方法重新获取</p>
</li>
</ul>
<h5 id="捕获相应的事件"><a href="#捕获相应的事件" class="headerlink" title="捕获相应的事件"></a>捕获相应的事件</h5><p>上面讲到<code>zookeeper</code>客户端连接的状态和<code>zookeeper</code>对<code>znode</code>节点监听的事件类型，下面我们来讲解如何建立<code>zookeeper</code>的***<code>watcher</code>监听***。在<code>zookeeper</code>中采用<code>zk.getChildren(path,watch)、zk.exists(path,watch)、zk.getData(path,watcher,stat)</code>这样的方式来为某个<code>znode</code>注册监听 。</p>
<p>下表以<code>node-x</code>节点为例，说明调用的注册方法和可用监听事件间的关系：</p>
<table>
<thead>
<tr>
<th>注册方式</th>
<th>created</th>
<th>childrenChanged</th>
<th>Changed</th>
<th>Deleted</th>
</tr>
</thead>
<tbody><tr>
<td><code>zk.exists(&quot;/node-x&quot;,watcher)</code></td>
<td>可监控</td>
<td></td>
<td>可监控</td>
<td>可监控</td>
</tr>
<tr>
<td><code>zk.getData(&quot;/node-x&quot;,watcher)</code></td>
<td></td>
<td></td>
<td>可监控</td>
<td>可监控</td>
</tr>
<tr>
<td><code>zk.getChildren(&quot;/node-x&quot;,watcher)</code></td>
<td></td>
<td>可监控</td>
<td></td>
<td>可监控</td>
</tr>
</tbody></table>
<p><strong>注册watcher的方法</strong></p>
<h5 id="客户端与服务器端的连接状态"><a href="#客户端与服务器端的连接状态" class="headerlink" title="客户端与服务器端的连接状态"></a>客户端与服务器端的连接状态</h5><ul>
<li><p><code>KeeperState </code>：通知状态</p>
</li>
<li><p><code>SyncConnected</code>：客户端与服务器正常连接时</p>
</li>
<li><p><code>Disconnected</code>：客户端与服务器断开连接时</p>
</li>
<li><p><code>Expired</code>：会话<code>session</code>失效时</p>
</li>
<li><p><code>AuthFailed</code>：身份认证失败时</p>
</li>
<li><p>事件类型为：<code>None</code></p>
<ul>
<li><p>案例</p>
</li>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZkConnectionWatcher</span> <span class="token keyword">implements</span> <span class="token class-name">Watcher</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>WatchedEvent watchedEvent<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        Event<span class="token punctuation">.</span>KeeperState state <span class="token operator">=</span> watchedEvent<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>state <span class="token operator">==</span> Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 正常</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"正常连接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>Disconnected<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 可以用Windows断开虚拟机网卡的方式模拟</span>
            <span class="token comment" spellcheck="true">// 当会话断开会出现，断开连接不代表不能重连，在会话超时时间内重连可以恢复正常</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"断开连接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>Expired<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 没有在会话超时时间内重新连接，而是当会话超时被移除的时候重连会走进这里</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"连接过期"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>AuthFailed<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 在操作的时候权限不够会出现</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"授权失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String IP <span class="token operator">=</span> <span class="token string">"192.168.133.133:2181"</span>
<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> CountDownLatch countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 5000为会话超时时间</span>
        ZooKeeper zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>IP<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ZkConnectionWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 模拟授权失败</span>
        zooKeeper<span class="token punctuation">.</span><span class="token function">addAuthInfo</span><span class="token punctuation">(</span><span class="token string">"digest1"</span><span class="token punctuation">,</span><span class="token string">"itcast1:123451"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/hadoop"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
<h5 id="watcher检查节点"><a href="#watcher检查节点" class="headerlink" title="watcher检查节点"></a>watcher检查节点</h5><p><strong>exists</strong></p>
<ul>
<li><p><code>exists(String path, boolean b)</code></p>
</li>
<li><p><code>exists(String path, Watcher w)</code></p>
</li>
<li><p><code>NodeCreated</code>：<strong>节点</strong>创建</p>
</li>
<li><p><code>NodeDeleted</code>：<strong>节点</strong>删除</p>
</li>
<li><p><code>NodeDataChanged</code>：<strong>节点</strong>内容</p>
<ul>
<li><p>案例</p>
</li>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventTypeTest</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String IP <span class="token operator">=</span> <span class="token string">"192.168.133.133:2181"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> CountDownLatch countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> ZooKeeper zooKeeper<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 采用zookeeper连接创建时的监听器</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">exists1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        zooKeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">"/watcher1"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 自定义监听器</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">exists2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        zooKeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">"/watcher1"</span><span class="token punctuation">,</span><span class="token punctuation">(</span>WatchedEvent w<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"自定义"</span> <span class="token operator">+</span> w<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 演示使用多次的监听器</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">exists3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        zooKeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">"/watcher1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>WatchedEvent watchedEvent<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"自定义的"</span> <span class="token operator">+</span> watchedEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        zooKeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">"/watcher1"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 演示一节点注册多个监听器</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">exists4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        zooKeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">"/watcher1"</span><span class="token punctuation">,</span><span class="token punctuation">(</span>WatchedEvent w<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"自定义1"</span> <span class="token operator">+</span> w<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        zooKeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">"/watcher1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>WatchedEvent watchedEvent<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"自定义2"</span> <span class="token operator">+</span> watchedEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        zooKeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">"/watcher1"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 测试</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>IP<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ZKWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exists4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ZKWatcher</span> <span class="token keyword">implements</span> <span class="token class-name">Watcher</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>WatchedEvent watchedEvent<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"zk的监听器"</span> <span class="token operator">+</span> watchedEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
<p><strong>getData</strong></p>
<ul>
<li><code>getData(String path, boolean b, Stat stat)</code></li>
<li><code>getData(String path, Watcher w, Stat stat)</code></li>
<li><code>NodeDeleted</code>：<strong>节点</strong>删除</li>
<li><code>NodeDataChange</code>：<strong>节点</strong>内容发生变化</li>
</ul>
<p><strong>getChildren</strong></p>
<ul>
<li><code>getChildren(String path, boolean b)</code></li>
<li><code>getChildren(String path, Watcher w)</code></li>
<li><code>NodeChildrenChanged</code>：<strong>子节点</strong>发生变化</li>
<li><code>NodeDeleted</code>：<strong>节点删除</strong></li>
</ul>
<p><strong>配置中心案例</strong></p>
<p>工作中有这样的一个场景：数据库用户名和密码信息放在一个配置文件中，应用读取该配置文件，配置文件信息放入缓存</p>
<p>若数据库的用户名和密码改变时候，还需要重新加载媛存，比较麻烦，通过 <code>Zookeeper</code>可以轻松完成,当数据库发生变化时自动完成缓存同步</p>
<p>使用事件监听机制可以做出一个简单的配置中心</p>
<p>设计思路</p>
<ol>
<li>连接<code>zookeeper </code>服务器</li>
<li>读取<code>zookeeper</code>中的配置信息，注册<code>watcher</code>监听器，存入本地变量</li>
<li>当<code>zookeeper</code>中的配置信息发生变化时，通过<code>watcher</code>的回调方法捕获数据变化事件</li>
<li>重新获取配置信息</li>
</ol>
<h5 id="分布式唯一id案例"><a href="#分布式唯一id案例" class="headerlink" title="分布式唯一id案例"></a>分布式唯一id案例</h5><p>在过去的单库单表型系统中，通常第可以使用数据库字段自带的<code>auto_ increment</code>属性来自动为每条记录生成个唯一的<code>ID</code>。但是分库分表后，就无法在依靠数据库的<code>auto_ increment</code>属性来唯一标识一条记录了。此时我们就可以用<code>zookeeper</code>在分布式环境下生成全局唯一<code>ID</code></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdGenerate</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String IP <span class="token operator">=</span> <span class="token string">"192.168.133.133:2181"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> CountDownLatch countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> ZooKeeper zooKeeper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">generateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/id"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ZooDefs<span class="token punctuation">.</span>Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> CreateMode<span class="token punctuation">.</span>EPHEMERAL_SEQUENTIAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>IP<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ZKWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ThreadPoolExecutor threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            threadPoolExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPoolExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ZKWatcher</span> <span class="token keyword">implements</span> <span class="token class-name">Watcher</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>WatchedEvent watchedEvent<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"zk的监听器"</span> <span class="token operator">+</span> watchedEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a><strong>分布式锁</strong></h5><p>分布式锁有多种实现方式，比如通过数据库、redis都可实现。作为分布式协同工具<code>Zookeeper</code>，当然也有着标准的实现方式。下面介绍在<code>zookeeper</code>中如果实现排他锁</p>
<p>设计思路</p>
<ol>
<li>每个客户端往<code>/Locks</code>下创建临时有序节点<code>/Locks/Lock_</code>，创建成功后<code>/Locks</code>下面会有每个客户端对应的节点，如<code>/Locks/Lock_000000001</code></li>
<li>客户端取得/Locks下子节点，并进行排序，判断排在前面的是否为自己，如果自己的锁节点在第一位，代表获取锁成功</li>
<li>如果自己的锁节点不在第一位，则监听自己前一位的锁节点。例如，自己锁节点<code>Lock_000000002</code>，那么则监听<code>Lock_000000001</code></li>
<li>当前一位锁节点<code>(Lock_000000001)</code>对应的客户端执行完成，释放了锁，将会触发监听客户端<code>(Lock_000000002)</code>的逻辑</li>
<li>监听客户端重新执行第<code>2</code>步逻辑，判断自己是否获得了锁</li>
<li><strong>zookeeper是有工具包的(这里采用手写)</strong></li>
</ol>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 线程测试类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadTest</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">delayOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">interface</span> <span class="token class-name">Runable</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span>Runable runable<span class="token punctuation">,</span><span class="token keyword">int</span> threadNum<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        ThreadPoolExecutor threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            threadPoolExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>runable<span class="token operator">:</span><span class="token operator">:</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        threadPoolExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//        DistributedLock distributedLock = new DistributedLock();</span>
<span class="token comment" spellcheck="true">//        distributedLock.acquireLock();</span>
<span class="token comment" spellcheck="true">//        delayOperation();</span>
<span class="token comment" spellcheck="true">//        distributedLock.releaseLock();</span>
        DateTimeFormatter dateTimeFormatter <span class="token operator">=</span> DateTimeFormatter<span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 每秒打印信息</span>
        <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">999999999</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                String format <span class="token operator">=</span> dateTimeFormatter<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 线程测试</span>
        <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            DistributedLock distributedLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistributedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            distributedLock<span class="token punctuation">.</span><span class="token function">acquireLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">delayOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            distributedLock<span class="token punctuation">.</span><span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistributedLock</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> String IP <span class="token operator">=</span> <span class="token string">"192.168.133.133:2181"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> String ROOT_LOCK <span class="token operator">=</span> <span class="token string">"/Root_Lock"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> String LOCK_PREFIX <span class="token operator">=</span> <span class="token string">"/Lock_"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> CountDownLatch countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> DATA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> ZooKeeper zookeeper<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String path<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            zookeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>IP<span class="token punctuation">,</span> <span class="token number">200000</span><span class="token punctuation">,</span> w <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"连接成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> InterruptedException e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 暴露的外部方法，主逻辑</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">acquireLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">createLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">attemptLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 暴露的外部方法，主逻辑</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            zookeeper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"锁释放了"</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> KeeperException e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 创建一个目录节点</span>
            Stat root <span class="token operator">=</span> zookeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>ROOT_LOCK<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> null<span class="token punctuation">)</span>
                zookeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ROOT_LOCK<span class="token punctuation">,</span> DATA<span class="token punctuation">,</span> ZooDefs<span class="token punctuation">.</span>Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> CreateMode<span class="token punctuation">.</span>PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 目录下创建子节点</span>
            path <span class="token operator">=</span> zookeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ROOT_LOCK <span class="token operator">+</span> LOCK_PREFIX<span class="token punctuation">,</span> DATA<span class="token punctuation">,</span> ZooDefs<span class="token punctuation">.</span>Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> CreateMode<span class="token punctuation">.</span>EPHEMERAL_SEQUENTIAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> <span class="token operator">|</span> InterruptedException e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> Watcher watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>WatchedEvent watchedEvent<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>watchedEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Event<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span>NodeDeleted<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attemptLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 获取正在排队的节点，由于是zookeeper生成的临时节点，不会出错，这里不能加监视器</span>
            <span class="token comment" spellcheck="true">// 因为添加了监视器后，任何子节点的变化都会触发监视器</span>
            List<span class="token operator">&lt;</span>String<span class="token operator">></span> nodes <span class="token operator">=</span> zookeeper<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span>ROOT_LOCK<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            nodes<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>String<span class="token operator">:</span><span class="token operator">:</span>compareTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 获取自身节点的排名</span>
            <span class="token keyword">int</span> ranking <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>ROOT_LOCK<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 已经是最靠前的节点了，获取锁</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ranking <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 并不是靠前的锁，监视自身节点的前一个节点</span>
                Stat status <span class="token operator">=</span> zookeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>ROOT_LOCK<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ranking <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 有可能这这个判断的瞬间，0号完成了操作(此时我们应该判断成功自旋才对)，但是上面的status变量已经获取了值并且不为空，1号沉睡</span>
                <span class="token comment" spellcheck="true">// 但是，请注意自行测试，虽然1号表面上沉睡了，但是实际上watcher.wait()是瞬间唤醒的</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">attemptLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        watcher<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                    <span class="token function">attemptLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> <span class="token operator">|</span> InterruptedException e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-1-10、集群搭建"><a href="#3-1-10、集群搭建" class="headerlink" title="3.1.10、集群搭建"></a>3.1.10、集群搭建</h3><p><code>zookeeper</code>官网——<code>Getting started</code>——<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperStarted.html#sc_RunningReplicatedZooKeeper">https://zookeeper.apache.org/doc/r3.4.14/zookeeperStarted.html#sc_RunningReplicatedZooKeeper</a></p>
<p>完全配置——<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_zkMulitServerSetup">https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_zkMulitServerSetup</a><br><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_configuration">https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_configuration</a></p>
<p>运行时复制的<code>zookeeper</code></p>
<p><strong>说明</strong>：对于复制模式，至少需要三个服务器，并且强烈建议您使用奇数个服务器。如果只有两台服务器，那么您将处于一种情况，如果其中一台服务器发生故障，则没有足够的计算机构成多数仲裁(<code>zk</code>采用的是过半数仲裁。因此，搭建的集群要容忍n个节点的故障，就必须有<code>2n+1</code>台计算机，这是因为宕掉n台后，集群还残余<code>n+1</code>台计算机，<code>n+1</code>台计算机中必定有一个最完整最接近<code>leader</code>的<code>follower</code>，假如宕掉的n台都是有完整信息的，剩下的一台就会出现在残余的<code>zk</code>集群中。也就是说：<code>zk</code>为了安全，必须达到多数仲裁，否则没有<code>leader</code>，集群失败，具体体现在**<code>leader</code>选举-章**)。由于存在两个单点故障，因此两个服务器还<strong>不如</strong>单个服务器稳定。</p>
<p>——关于<code>2n+1</code>原则，<code>Kafka</code>官网有权威的解释(虽然<code>Kafka</code>不采用)<a target="_blank" rel="noopener" href="http://kafka.apache.org/0110/documentation.html#design_replicatedlog">http://kafka.apache.org/0110/documentation.html#design_replicatedlog</a></p>
<p>多数仲裁的设计是为了<strong>避免脑裂</strong>(zk，已经采用了多数仲裁，所以不会出现)，和数据一致性的问题</p>
<ul>
<li><strong>脑裂</strong>：由于网络延迟等各种因素，最终导致集群一分为二，各自独立运行(两个<code>leader</code>)，集群就是坏的</li>
<li>如果有两台服务器，两台都认为另外的<code>zk</code>宕掉，各自成为<code>leader</code>运行(假设可以，实际上选不出<code>leader</code>，可以实际搭建一个集群，看看一台zk是否能够成功集群，详见**<code>leader</code>选举**)，就会导致数据不一致。</li>
<li>如果有三台服务器，一台因为网络分区，无法连接，剩下两台网络正常，选举出了<code>leader</code>，集群正常</li>
<li>以此类推<ul>
<li><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\脑裂.png" alt="脑裂"></li>
<li>zk的设计天生就是<code>cap</code>中的<code>cp</code>，所以不会出现上述的脑裂和数据一致性问题，我们搭建<code>zk</code>仅需保证<code>2n+1</code>原则</li>
</ul>
</li>
</ul>
<p>复制模式所需的<strong>conf / zoo.cfg</strong>文件类似于独立模式下使用的文件，但有一些区别。这是一个例子：</p>
<pre class="line-numbers language-shell"><code class="language-shell">tickTime=2000
dataDir=/var/lib/zookeeper
clientPort=2181
initLimit=5
syncLimit=2
server.1=zoo1:2888:3888 # 这是多机部署
server.2=zoo2:2888:3888
server.3=zoo3:2888:3888
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>新的键值**<code>initLimit</code><strong>是<code>zookeeper</code>用于限制选举中<code>zookeeper</code>服务连接到<code>leader</code>的时间，</strong><code>syncLimit</code>**限制服务器与<code>leader</code>的过期时间</li>
<li>对于这两个超时，您都可以使用<strong>tickTime</strong>指定时间单位。在此示例中，<code>initLimit</code>的超时为5个滴答声，即<code>2000</code>毫秒/滴答声，即<code>10</code>秒</li>
<li>表格*<code>server.X</code><em>的条目列出了组成<code>ZooKeeper</code>服务的服务器。服务器启动时，它通过在数据目录中查找文件</em><code>myid</code>*来知道它是哪台服务器。该文件包含<code>ASCII</code>的服务器号。</li>
<li>最后，记下每个服务器名称后面的两个端口号：<code>“ 2888”</code>和<code>“ 3888”</code>。对等方使用前一个端口连接到其他对等方。这种连接是必需的，以便对等方可以进行通信，例如，以商定更新顺序。更具体地说，**<code>ZooKeeper</code>服务器使用此端口将<code>follower</code>连接到<code>leader</code>**。当出现新的<code>leader</code>者时，<code>follower</code>使用此端口打开与<code>leader</code>的<code>TCP</code>连接。因为默认的<code>leader</code>选举也使用<code>TCP</code>，所以我们当前需要另一个端口来进行<code>leader</code>选举。这是第二个端口。</li>
</ul>
<p><strong>正文</strong>搭建：单机环境下，<code>jdk</code>、<code>zookeeper</code>安装完毕，基于一台虚拟机，进行<code>zookeeper</code><strong>伪集群搭建</strong>，<code>zookeeper</code>集群中包含3个节点，节点对外提供服务端口号，分别为<code>2181</code>、<code>2182</code>、<code>2183</code></p>
<ol>
<li><p>基于<code>zookeeper-3.4.10</code>复制三份<code>zookeeper</code>安装好的服务器文件,目录名称分别为<code>zookeeper2181</code>、<code>zookeeper2182</code>、<code>zookeeper2183</code></p>
<pre class="line-numbers language-shell"><code class="language-shell">cp -r zookeeper-3.4.10  zookeeper2181
cp -r zookeeper-3.4.10  zookeeper2182
cp -r zookeeper-3.4.10  zookeeper2183

# cp -r zookeeper-3.1.10 ./zookeeper218&#123;1..3&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>修改<code>zookeeper2181</code>服务器对应配置文件</p>
<pre class="line-numbers language-shell"><code class="language-shell"># 服务器对应端口号
clientPort=2181
# 数据快照文件所在路径
dataDir=/opt/zookeeper2181/data
# 集群配置信息
   # server:A=B:C:D
   # A:是一个数字，表示这个是服务器的编号
   # B:是这个服务器的ip地址
   # C:Zookeeper服务器之间通信的端口(数据互通，必须的)
   # D:Leader选举的端口
server.1=192.168.133.133:2287:3387  # 这是伪集群部署，注意端口号  
server.2=192.168.133.133:2288:3388
server.3=192.168.133.133:2289:3389
# 对，这些都是2181的配置文件
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>在上一步 <code>dataDir </code>指定的目录下，创建<code>myid</code>文件，然后在该文件添加上一步<code>server</code>配置的对应<code>A</code>数字</p>
<pre class="line-numbers language-shell"><code class="language-shell"># zookeeper2181对应的数字为1
# /opt/zookeeper2181/data目录(即dataDir的目录下)下执行命令
echo "1" > myid
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>zookeeper2182、2183</code>参照2/3进行相应配置</p>
</li>
<li><p>分别启动三台服务器，检验集群状态</p>
<p>检查：<code>cd</code>进入<code>bin</code>目录<code>./zkServer status</code></p>
<p>登录命令：</p>
<pre class="line-numbers language-shell"><code class="language-shell">./zkCli.sh -server 192.168.60.130:2181
./zkCli.sh -server 192.168.60.130:2182
./zkCli.sh -server 192.168.60.130:2183
# 如果启动后没有显示出集群的状态，请自己检查端口和配置文件问题，主要是端口占用和配置文件问题
# ss -lntpd | grep 2181
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<h4 id="一致性协议——zab协议"><a href="#一致性协议——zab协议" class="headerlink" title="一致性协议——zab协议"></a>一致性协议——zab协议</h4><p><code>zab</code>协议的全称是 <em><strong><code>Zookeeper Atomic Broadcast</code></strong></em> (<code>zookeeper</code>原子广播)。<code>zookeeper</code>是通过<code>zab</code>协议来保证分布式事务的最终一致性</p>
<p>基于<code>zab</code>协议，<code>zookeeper</code>集群中的角色主要有以下三类，如下所示：</p>
<table>
<thead>
<tr>
<th>角色</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><strong>领导者(<code>Leader</code>)</strong></td>
<td>领导者负责进行投票的发起和决议，更新系统状态</td>
</tr>
<tr>
<td><strong>学习者(<code>Learner</code>)-跟随者(<code>Follower</code>)</strong></td>
<td><code>Follower</code>用于接收客户端请求并向客户端返回结果，在选主过程中参与投票</td>
</tr>
<tr>
<td><strong>学习者(<code>Learner</code>)-观察者(<code>ObServer</code>)</strong></td>
<td><code>ObServer</code>可以接收客户端连接，将写请求转发给<code>leader</code>节点。但<code>ObServer</code>不参加投票过程，只同步<code>leader</code>的状态。<code>ObServer</code>的目的是为了扩展系统，提高读取速度</td>
</tr>
<tr>
<td><strong>客户端(<code>Client</code>)</strong></td>
<td>请求发起方</td>
</tr>
</tbody></table>
<p>·<code>zab</code>广播模式工作原理，通过类似两端式提交协议的方式解决数据一致性：</p>
<p><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\zookeeper-8.png" alt="zookeeper-8"></p>
<ol>
<li><code>leader</code>从客户端收<strong>到一个写请求</strong></li>
<li><code>leader</code><strong>生成一个新的事务</strong>并为这个事务生成一个唯一的<code>ZXID</code></li>
<li><code>leader</code><strong>将事务提议(<code>propose</code>)发送给所有的<code>follows</code>节点</strong></li>
<li><code>follower</code>节点将收到的事务请求加入到本地**历史队列(<code>history queue</code>)中，并发送<code>ack</code>给<code>leader</code>**，表示确认提议</li>
<li>当<code>leader</code>收到大多数<code>follower</code>(<strong>半数以上节点</strong>)的<code>ack(acknowledgement)</code>确认消息，<code>leader</code>会本地提交，并发送<code>commit</code>请求</li>
<li>当<code>follower</code><strong>收到<code>commit</code>请求时，从历史队列中将事务请求<code>commit</code></strong></li>
</ol>
<p>因为是半数以上的结点就可以通过事务请求，所以延迟不高</p>
<h4 id="leader选举"><a href="#leader选举" class="headerlink" title="leader选举"></a>leader选举</h4><p><strong>服务器状态</strong></p>
<ul>
<li>**<code>looking</code>**：寻找<code>leader</code>状态。当服务器处于该状态时，它会认为当前集群中没有<code>leader</code>，因此需要进入<code>leader</code>选举状态</li>
<li>**<code>following</code>**：跟随着状态。表明当前服务器角色是<code>follower</code></li>
<li>**<code>observing</code>**：观察者状态。表明当前服务器角色是<code>observer</code></li>
</ul>
<p>分为两种选举，<strong>服务器启动时的选举</strong>和<strong>服务器运行时期的选举</strong></p>
<p><strong>服务器启动时期的leader选举</strong></p>
<p>在集群初始化节点，当有一台服务器<code>server1</code>启动时，其<strong>单独无法进行和完成<code>leader</code>选举</strong>，当第二台服务器<code>server2</code>启动时，此时两台及其可以相互通信，每台及其都试图找到<code>leader</code>，<strong>于是进入<code>leader</code>选举过程</strong>。选举过程如下：</p>
<ol>
<li><p>每个<code>server</code>发出一个投票。由于是初始状态，<code>server1</code>和<code>server2</code>都会将自己作为<code>leader</code>服务器来进行投票，每次投票都会包<strong>含所推举的<code>myid</code>和<code>zxid</code>，使用(<code>myid，zxid</code>)<strong>，此时<code>server1</code>的投票为(1，0)，<code>server2</code>的投票为(2，0)，然后</strong>各自将这个投票发给集群中的其它机器</strong></p>
</li>
<li><p>集群中的<strong>每台服务器都接收来自集群中各个服务器的投票</strong></p>
</li>
<li><p><strong>处理投票</strong>。针对每一个投票，服务器都需要将别人的投票和自己的投票进行pk，规则如下</p>
<ul>
<li><p>优先检查<code>zxid</code>。<code>zxid</code>比较大的服务器优先作为<code>leader</code>(<strong><code>zxid</code>较大者保存的数据更多</strong>)</p>
</li>
<li><p>如果<code>zxid</code>相同。那么就比较<code>myid</code>。<code>myid</code>较大的服务器作为<code>leader</code>服务器</p>
<p><strong>对于<code>Server1</code>而言，它的投票是(1，0)<strong>，接收<code>Server2</code>的投票为(2，0)，</strong>首先会比较两者的<code>zxid</code><strong>，均为0，</strong>再比较<code>myid</code><strong>，此时<code>server2</code>的<code>myid</code>最大，于是更新自己的投票为(2，0)，然后重新投票，</strong>对于server2而言，无需更新自己的投票</strong>，只是再次向集群中所有机器发出上一次投票信息即可</p>
</li>
</ul>
</li>
<li><p><strong>统计投票</strong>。每次投票后，服务器都会统计投票信息，判断是否已经有<strong>过半机器接受到相同的投票信息</strong>，对于<code>server1、server2</code>而言，都统计出集群中已经有两台机器接受了(2，0)的投票信息，此时便认为已经选举出了<code>leader</code></p>
</li>
<li><p><strong>改变服务器状态</strong>。一旦确定了<code>leader</code>,每个服务器就会更新自己的状态，如果是<code>follower</code>，那么就变更为<code>following</code>，如果是<code>leader</code>，就变更为<code>leading</code></p>
</li>
</ol>
<p>**举例：如果我们有三个节点的集群，1，2，3，启动 1 和 2 后，2 一定会是 <code>leader</code>，3 再加入不会进行选举，而是直接成为<code>follower</code>**—— 仔细观察 一台<code>zk</code>无法集群，没有<code>leader</code></p>
<p><strong>服务器运行时期选举</strong></p>
<p>在<code>zookeeper</code>运行期间，<code>leader</code>与非<code>leader</code>服务器各司其职，即使当有非<code>leader</code>服务器宕机或者新加入，此时也不会影响<code>leader</code>，但是一旦<code>leader</code>服务器挂了，那么整个集群将暂停对外服务，进入新一轮<code>leader</code>选举，其过程和启动时期的<code>leader</code>选举过程基本一致</p>
<p>假设正在运行的有<code>server1</code>、<code>server2</code>、<code>server3</code>三台服务器，当前<code>leader</code>是<code>server2</code>，若某一时刻<code>leader</code>挂了，此时便开始<code>Leader</code>选举。选举过程如下</p>
<ol>
<li>变更状态。**<code>leader</code>挂后，余下的服务器都会将自己的服务器状态变更为<code>looking</code>**，然后开始进入<code>leader</code>选举过程</li>
<li>每个<code>server</code>发出一个投票。在运行期间，<strong>每个服务器上的<code>zxid</code>可能不同</strong>，此时假定<code>server1</code>的<code>zxid</code>为<code>122</code>，<code>server3</code>的<code>zxid</code>为<code>122</code>，<strong>在第一轮投票中，server1和server3都会投自己</strong>，产生投票(1，122)，(3，122)，然后<strong>各自将投票发送给集群中所有机器</strong></li>
<li><strong>接收来自各个服务器的投票</strong>。与启动时过程相同</li>
<li><strong>处理投票</strong>。与启动时过程相同，此时，<code>server3</code>将会成为<code>leader</code></li>
<li><strong>统计投票</strong>。与启动时过程相同</li>
<li><strong>改变服务器的状态</strong>。与启动时过程相同</li>
</ol>
<h4 id="observer角色及其配置"><a href="#observer角色及其配置" class="headerlink" title="observer角色及其配置"></a>observer角色及其配置</h4><p><code>zookeeper</code>官网——<code>Observers Guide</code><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperObservers.html">https://zookeeper.apache.org/doc/r3.4.14/zookeeperObservers.html</a></p>
<p>尽管<code>ZooKeeper</code>通过使用客户端直接连接到该集合的投票成员表现良好，但是此体系结构使其很难扩展到大量客户端。问题在于，随着我们添加更多的投票成员，写入性能会下降。这是由于以下事实：写操作需要（通常）集合中至少一半节点的同意，因此，随着添加更多的投票者，投票的成本可能会显着增加。</p>
<p>我们引入了一种称为<em>Observer</em>的新型<code>ZooKeeper</code>节点，该节点有助于解决此问题并进一步提高<code>ZooKeeper</code>的可伸缩性。观察员是合法的非投票成员，他们仅听取投票结果，而听不到投票结果。除了这种简单的区别之外，观察者的功能与跟随者的功能完全相同-客户端可以连接到观察者，并向其发送读写请求。观察者像追随者一样将这些请求转发给领导者，但是他们只是等待听取投票结果。因此，我们可以在不影响投票效果的情况下尽可能增加观察员的数量。</p>
<p>观察者还有其他优点。因为他们不投票，所以它们不是<code>ZooKeeper</code>选举中的关键部分。因此，它们可以在不损害<code>ZooKeeper</code>服务可用性的情况下发生故障或与群集断开连接。给用户带来的好处是，观察者可以通过比跟随者更不可靠的网络链接进行连接。实际上，观察者可用于与另一个数据中心的<code>ZooKeeper</code>服务器进行对话。观察者的客户端将看到快速读取，因为所有读取均在本地提供，并且由于缺少表决协议而需要的消息数量较小，因此写入会导致网络流量最小</p>
<p><code>ovserver</code>角色<strong>特点</strong>：</p>
<ol>
<li><strong>不参与集群的<code>leader</code>选举</strong></li>
<li><strong>不参与集群中写数据时的<code>ack</code>反馈</strong></li>
</ol>
<p>为了使用<code>observer</code>角色，在任何想变成<code>observer</code>角色的配置文件中加入如下配置：</p>
<pre class="line-numbers language-shell"><code class="language-shell">peerType=observer
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>并在所有<code>server</code>的配置文件中，配置成<code>observer</code>模式的<code>server</code>的那行配置追加***<code>:observer</code>***，例如</p>
<pre class="line-numbers language-shell"><code class="language-shell">server.1=192.168.133.133:2287:3387  # 注意端口号  server.2=192.168.133.133:2288:3388server.3=192.168.133.133:2289:3389:observer
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意<code> 2n+1</code>原则——<code>集群搭建</code></p>
<h4 id="API连接集群"><a href="#API连接集群" class="headerlink" title="API连接集群"></a>API连接集群</h4><p><code>Zookeeper(String connectionString, int sessionTimeout, Watcher watcher)</code></p>
<ul>
<li><code>connectionString </code> ：<code>zookeeper</code>集合主机</li>
<li><code>sessionTimeout</code>：会话超时(以毫秒为单位)</li>
<li><code>watcher </code>：实现”监听器”界面的对象。<code>zookeeper</code>集合通过监视器对象返回连接状态</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        CountDownLatch countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ZooKeeper connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"192.168.133.133:2181,192.168.133.133:2182,192.168.133.133:2183"</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> watchedEvent <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>watchedEvent<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected<span class="token punctuation">)</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"连接成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        connection<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/hadoop"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ZooDefs<span class="token punctuation">.</span>Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span>CreateMode<span class="token punctuation">.</span>PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="3-1-11、curator介绍"><a href="#3-1-11、curator介绍" class="headerlink" title="3.1.11、curator介绍"></a>3.1.11、curator介绍</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wo541075754/article/details/68067872">https://blog.csdn.net/wo541075754/article/details/68067872</a> 关于第三方客户端的小介绍</p>
<p><code>zkClient </code>有对<code>dubbo</code>的一些操作支持，但是<code>zkClient</code>几乎没有文档，下面是<code>curator</code></p>
<h4 id="curator简介"><a href="#curator简介" class="headerlink" title="curator简介"></a><strong>curator简介</strong></h4><p><code>curator</code>是<code>Netflix</code>公司开源的一个 <code>zookeeper</code>客户端，后捐献给 <code>apache</code>,，<code>curator</code>框架在<code>zookeeper</code>原生<code>API</code>接口上进行了包装，解决了很多<code>zooKeeper</code>客户端非常底层的细节开发。提供<code>zooKeeper</code>各种应用场景(比如:分布式锁服务、集群领导选举、共享计数器、缓存机制、分布式队列等的抽象封装，实现了<code>Fluent</code>风格的APl接口，是最好用，最流行的<code>zookeeper</code>的客户端</p>
<p>原生<code>zookeeperAPI</code>的不足</p>
<ul>
<li>连接对象异步创建，需要开发人员自行编码等待</li>
<li>连接没有自动重连超时机制</li>
<li>watcher一次注册生效一次</li>
<li>不支持递归创建树形节点</li>
</ul>
<p><code>curator</code>特点</p>
<ul>
<li>解决<code>session</code>会话超时重连</li>
<li><code>watcher</code>反复注册</li>
<li>简化开发<code>api</code></li>
<li>遵循<code>Fluent</code>风格<code>API</code></li>
</ul>
<pre class="line-numbers language-html"><code class="language-html">    <span class="token comment" spellcheck="true">&lt;!-- Zookeeper --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.4.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>curator-framework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.6.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclustions</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclustion</span><span class="token punctuation">></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclustion</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclustions</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>curator-recipes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.6.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 工厂创建，fluent风格</span>
        CuratorFramework client <span class="token operator">=</span> CuratorFrameworkFactory<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// ip端口号</span>
                <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"192.168.133.133:2181,192.168.133.133:2182,192.168.133.133:2183"</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 会话超时</span>
                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 重试机制，这里是超时后1000毫秒重试一次</span>
                <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RetryOneTime</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 名称空间，在操作节点的时候，会以这个为父节点</span>
                <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token string">"create"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>session</code>重连策略<ul>
<li><code>RetryPolicy retry Policy = new RetryOneTime(3000);</code><ul>
<li>说明：三秒后重连一次，只重连一次</li>
</ul>
</li>
<li><code>RetryPolicy retryPolicy = new RetryNTimes(3,3000);</code><ul>
<li>说明：每三秒重连一次，重连三次</li>
</ul>
</li>
<li><code>RetryPolicy retryPolicy = new RetryUntilElapsed(1000,3000);</code><ul>
<li>说明：每三秒重连一次，总等待时间超过个<code>10</code>秒后停止重连</li>
</ul>
</li>
<li><code>RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000,3)</code><ul>
<li>说明：这个策略的重试间隔会越来越长<ul>
<li>公式：<code>baseSleepTImeMs * Math.max(1,random.nextInt(1 &lt;&lt; (retryCount + 1)))</code><ul>
<li><code>baseSleepTimeMs</code> = <code>1000</code> 例子中的值</li>
<li><code>maxRetries</code> = <code>3</code> 例子中的值</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="创建-1"><a href="#创建-1" class="headerlink" title="创建"></a>创建</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">curatorGettingStart</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> CuratorFramework client<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ids权限</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">create1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 新增节点</span>
        client<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 节点的类型</span>
                <span class="token punctuation">.</span><span class="token function">withMode</span><span class="token punctuation">(</span>CreateMode<span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 节点的acl权限列表</span>
                <span class="token punctuation">.</span><span class="token function">withACL</span><span class="token punctuation">(</span>ZooDefs<span class="token punctuation">.</span>Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// arg1：节点路径，arg2：节点数据</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 自定义权限</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">create2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        ArrayList<span class="token operator">&lt;</span>ACL<span class="token operator">></span> acls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Id id <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Id</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">,</span> <span class="token string">"anyone"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        acls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ACL</span><span class="token punctuation">(</span>ZooDefs<span class="token punctuation">.</span>Perms<span class="token punctuation">.</span>READ<span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 新增节点</span>
        client<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 节点的类型</span>
                <span class="token punctuation">.</span><span class="token function">withMode</span><span class="token punctuation">(</span>CreateMode<span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 节点的acl权限列表</span>
                <span class="token punctuation">.</span><span class="token function">withACL</span><span class="token punctuation">(</span>acls<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// arg1：节点路径，arg2：节点数据</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/node2"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 递归创建</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">create3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 新增节点</span>
        client<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 递归创建</span>
                <span class="token punctuation">.</span><span class="token function">creatingParentsIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 节点的类型</span>
                <span class="token punctuation">.</span><span class="token function">withMode</span><span class="token punctuation">(</span>CreateMode<span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 节点的acl权限列表</span>
                <span class="token punctuation">.</span><span class="token function">withACL</span><span class="token punctuation">(</span>ZooDefs<span class="token punctuation">.</span>Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// arg1：节点路径，arg2：节点数据</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/node2/nodex"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 递归创建</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">create4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 新增节点</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">creatingParentsIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 节点的类型</span>
                <span class="token punctuation">.</span><span class="token function">withMode</span><span class="token punctuation">(</span>CreateMode<span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 节点的acl权限列表</span>
                <span class="token punctuation">.</span><span class="token function">withACL</span><span class="token punctuation">(</span>ZooDefs<span class="token punctuation">.</span>Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 异步</span>
                <span class="token punctuation">.</span><span class="token function">inBackground</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BackgroundCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span>CuratorFramework curatorFramework<span class="token punctuation">,</span> CuratorEvent curatorEvent<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"异步创建成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// arg1：节点路径，arg2：节点数据</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/node2/nodex"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 工厂创建，fluent风格</span>
        CuratorFramework client <span class="token operator">=</span> CuratorFrameworkFactory<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// ip端口号</span>
                <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"192.168.133.133:2181,192.168.133.133:2182,192.168.133.133:2183"</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 会话超时</span>
                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 重试机制，这里是超时后1000毫秒重试一次</span>
                <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RetryOneTime</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 名称空间，在操作节点的时候，会以这个为父节点</span>
                <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token string">"create"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//        create1();</span>
<span class="token comment" spellcheck="true">//        create2();</span>
<span class="token comment" spellcheck="true">//        create3();</span>
        <span class="token function">create4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"操作完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">curatorGettingStart</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> CuratorFramework client<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">set1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 修改节点</span>
        client<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 版本</span>
                <span class="token punctuation">.</span><span class="token function">withVersion</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/hadoop"</span><span class="token punctuation">,</span><span class="token string">"hadoop1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">set2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 修改节点</span>
        client<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withVersion</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/hadoop"</span><span class="token punctuation">,</span><span class="token string">"hadoop2"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">set3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 修改节点</span>
        client<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withVersion</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 异步</span>
                <span class="token punctuation">.</span><span class="token function">inBackground</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BackgroundCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span>CuratorFramework curatorFramework<span class="token punctuation">,</span> CuratorEvent curatorEvent<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>curatorEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> CuratorEventType<span class="token punctuation">.</span>SET_DATA<span class="token punctuation">)</span>
                            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>curatorEvent<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">"    "</span> <span class="token operator">+</span>curatorEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/hadoop"</span><span class="token punctuation">,</span><span class="token string">"hadoop3"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 工厂创建，fluent风格</span>
        client <span class="token operator">=</span> CuratorFrameworkFactory<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// ip端口号</span>
                <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"192.168.133.133:2181,192.168.133.133:2182,192.168.133.133:2183"</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 会话超时</span>
                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 重试机制，这里是超时后1000毫秒重试一次</span>
                <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RetryOneTime</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 名称空间，在操作节点的时候，会以这个为父节点,可选操作</span>
                <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token string">"update"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//        set1();</span>
        <span class="token function">set2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//        set3();</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"操作完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="删除-1"><a href="#删除-1" class="headerlink" title="删除"></a>删除</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">curatorGettingStart</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> CuratorFramework client<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">delete1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 删除节点</span>
        client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"node1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">delete2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 删除节点</span>
        client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 版本</span>
                <span class="token punctuation">.</span><span class="token function">withVersion</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"node2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">delete3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 删除节点</span>
        client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 递归删除</span>
                <span class="token punctuation">.</span><span class="token function">deletingChildrenIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withVersion</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"node3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">delete4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 删除节点</span>
        client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withVersion</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 异步</span>
                <span class="token punctuation">.</span><span class="token function">inBackground</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BackgroundCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span>CuratorFramework curatorFramework<span class="token punctuation">,</span> CuratorEvent curatorEvent<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>curatorEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> CuratorEventType<span class="token punctuation">.</span>DELETE<span class="token punctuation">)</span>
                            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>curatorEvent<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"    "</span> <span class="token operator">+</span> curatorEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"node3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 工厂创建，fluent风格</span>
        client <span class="token operator">=</span> CuratorFrameworkFactory<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// ip端口号</span>
                <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"192.168.133.133:2181,192.168.133.133:2182,192.168.133.133:2183"</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 会话超时</span>
                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 重试机制，这里是超时后1000毫秒重试一次</span>
                <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RetryOneTime</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 名称空间，在操作节点的时候，会以这个为父节点,可选操作</span>
                <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token string">"delete"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//        delete1();</span>
        <span class="token comment" spellcheck="true">//        delete2();</span>
        <span class="token comment" spellcheck="true">//        delete3();</span>
        <span class="token comment" spellcheck="true">// delete4();</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"操作完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="读取节点"><a href="#读取节点" class="headerlink" title="读取节点"></a>读取节点</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">curatorGettingStart</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> CuratorFramework client<span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">get1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span>  Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取数据</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">get2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span>  Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        Stat stat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取数据</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">storingStatIn</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">getCzxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">get3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span>  Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取数据</span>
        client<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">inBackground</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CuratorFramework curatorFramework<span class="token punctuation">,</span> CuratorEvent curatorEvent<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>curatorEvent<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"  "</span> <span class="token operator">+</span> curatorEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 工厂创建，fluent风格</span>
        client <span class="token operator">=</span> CuratorFrameworkFactory<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// ip端口号</span>
                <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"192.168.133.133:2181,192.168.133.133:2182,192.168.133.133:2183"</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 会话超时</span>
                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 重试机制，这里是超时后1000毫秒重试一次</span>
                <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RetryOneTime</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 名称空间，在操作节点的时候，会以这个为父节点,可选操作</span>
                <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">get1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">get2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">get3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"操作完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="读取子节点"><a href="#读取子节点" class="headerlink" title="读取子节点"></a>读取子节点</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">curatorGettingStart</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> CuratorFramework client<span class="token punctuation">;</span>  
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getChildren1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span>  Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取数据</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">></span> strings <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/get"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        strings<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getChildren2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span>  Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取数据</span>
        client<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">inBackground</span><span class="token punctuation">(</span><span class="token punctuation">(</span>curatorFramework<span class="token punctuation">,</span> curatorEvent<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    curatorEvent<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/get"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 工厂创建，fluent风格</span>
        client <span class="token operator">=</span> CuratorFrameworkFactory<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// ip端口号</span>
                <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"192.168.133.133:2181,192.168.133.133:2182,192.168.133.133:2183"</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 会话超时</span>
                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 重试机制，这里是超时后1000毫秒重试一次</span>
                <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RetryOneTime</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 名称空间，在操作节点的时候，会以这个为父节点,可选操作</span>
<span class="token comment" spellcheck="true">//                .namespace("get")</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">getChildren1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getChildren2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"操作完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="watcher"><a href="#watcher" class="headerlink" title="watcher"></a>watcher</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WatcherTest</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> CuratorFramework client<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">watcher1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// arg1 curator的客户端</span>
        <span class="token comment" spellcheck="true">// arg2 监视的路径</span>
        NodeCache nodeCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeCache</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">"/watcher"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动</span>
        nodeCache<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodeCache<span class="token punctuation">.</span><span class="token function">getListenable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NodeCacheListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token comment" spellcheck="true">// 节点变化时的回调方法</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nodeChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 路径</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>nodeCache<span class="token punctuation">.</span><span class="token function">getCurrentData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"  "</span> <span class="token operator">+</span> nodeCache<span class="token punctuation">.</span><span class="token function">getCurrentData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 输出节点内容</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>nodeCache<span class="token punctuation">.</span><span class="token function">getCurrentData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"注册完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 时间窗内可以一直监听</span>
        <span class="token comment" spellcheck="true">//        TimeUnit.SECONDS.sleep(1000);</span>
        <span class="token comment" spellcheck="true">//关 闭</span>
        nodeCache<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">watcher2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// arg1 客户端</span>
        <span class="token comment" spellcheck="true">// arg2 路径</span>
        <span class="token comment" spellcheck="true">// arg3 事件钟是否可以获取节点数据</span>
        PathChildrenCache pathChildrenCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PathChildrenCache</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">"/watcher"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动</span>
        pathChildrenCache<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pathChildrenCache<span class="token punctuation">.</span><span class="token function">getListenable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PathChildrenCacheListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token comment" spellcheck="true">// 节点变化时的回调方法</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">childEvent</span><span class="token punctuation">(</span>CuratorFramework curatorFramework<span class="token punctuation">,</span> PathChildrenCacheEvent pathChildrenCacheEvent<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pathChildrenCacheEvent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 获取子节点数据</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>pathChildrenCacheEvent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 路径</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pathChildrenCacheEvent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 事件类型</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pathChildrenCacheEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 时间窗内可以一直监听</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//关 闭</span>
        pathChildrenCache<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 工厂创建，fluent风格</span>
        client <span class="token operator">=</span> CuratorFrameworkFactory<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// ip端口号</span>
                <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"192.168.133.133:2181,192.168.133.133:2182,192.168.133.133:2183"</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 会话超时</span>
                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 重试机制，这里是超时后1000毫秒重试一次</span>
                <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RetryOneTime</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 名称空间，在操作节点的时候，会以这个为父节点,可选操作</span>
                <span class="token comment" spellcheck="true">//                .namespace("get")</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//        watcher1();</span>
        <span class="token function">watcher2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"操作完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CuratorTransaction</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> CuratorFramework client<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*client.inTransaction()
                .create()
                    .withMode(CreateMode.PERSISTENT)
                    .withACL(ZooDefs.Ids.OPEN_ACL_UNSAFE)
                    .forPath("/transaction",new byte[0])
                .and()
                .setData()
                    .forPath("/setData/transaction",new byte[0])
                .and()
                .commit();*/</span>
        client<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withMode</span><span class="token punctuation">(</span>CreateMode<span class="token punctuation">.</span>PERSISTENT<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withACL</span><span class="token punctuation">(</span>ZooDefs<span class="token punctuation">.</span>Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/transaction"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">"/setData/transaction"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 工厂创建，fluent风格</span>
        client <span class="token operator">=</span> CuratorFrameworkFactory<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// ip端口号</span>
                <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"192.168.133.133:2181,192.168.133.133:2182,192.168.133.133:2183"</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 会话超时</span>
                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 重试机制，这里是超时后1000毫秒重试一次</span>
                <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RetryOneTime</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 名称空间，在操作节点的时候，会以这个为父节点,可选操作</span>
                <span class="token comment" spellcheck="true">//                .namespace("get")</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"操作完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="分布式锁-1"><a href="#分布式锁-1" class="headerlink" title="分布式锁"></a>分布式锁</h4><ul>
<li><code>InterProcessMutex</code>：分布式可重入排它锁</li>
<li><code>InterProcessReadWriteLock</code>：分布式读写锁</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CuratorDistributeLock</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> CuratorFramework client<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">interProcessMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"排他锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取一个分布式排他锁</span>
        InterProcessMutex lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterProcessMutex</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">"/lock1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 开启两个进程测试，会发现：如果一个分布式排它锁获取了锁，那么直到锁释放为止数据都不会被侵扰</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"获取锁中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"操作中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"释放锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">interProcessReadWriteLock1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"写锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 分布式读写锁</span>
        InterProcessReadWriteLock lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterProcessReadWriteLock</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">"/lock1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 开启两个进程测试，观察到写写互斥，特性同排它锁</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"获取锁中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"操作中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"释放锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">interProcessReadWriteLock2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"读锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 分布式读写锁</span>
        InterProcessReadWriteLock lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterProcessReadWriteLock</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">"/lock1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 开启两个进程测试，观察得到读读共享，两个进程并发进行，注意并发和并行是两个概念，(并发是线程启动时间段不一定一致，并行是时间轴一致的)</span>
        <span class="token comment" spellcheck="true">// 再测试两个进程，一个读，一个写，也会出现互斥现象</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"获取锁中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"操作中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"释放锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 工厂创建，fluent风格</span>
        client <span class="token operator">=</span> CuratorFrameworkFactory<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// ip端口号</span>
                <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"192.168.133.133:2181,192.168.133.133:2182,192.168.133.133:2183"</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 会话超时</span>
                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 重试机制，这里是超时后1000毫秒重试一次</span>
                <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RetryOneTime</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 名称空间，在操作节点的时候，会以这个为父节点,可选操作</span>
                <span class="token comment" spellcheck="true">//                .namespace("get")</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//        interProcessMutex();</span>
<span class="token comment" spellcheck="true">//                interProcessReadWriteLock1();</span>
        <span class="token function">interProcessReadWriteLock2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"操作完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-1-12、四字监控命令-配置属性"><a href="#3-1-12、四字监控命令-配置属性" class="headerlink" title="3.1.12、四字监控命令/配置属性"></a>3.1.12、四字监控命令/配置属性</h3><p><code>zookeeper</code>文档——<code>administrator&#39;s Guide</code>——<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_zkCommands">https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_zkCommands</a> 四字命令</p>
<p><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_configuration">https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_configuration</a> 配置属性</p>
<p><code>zookeeper</code>支持某些特定的四字命令与其的交互。它们大多数是查询命令，用来获取<code>zookeeper</code>服务的当前状态及相关信息。用户再客户端可以通过<code>telnet</code>或<code>nc</code>向<code>zookeeper</code>提交相应的命令。<code>zookeeper</code>常用四字命令见下表所示：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>conf</code></td>
<td>输出相关服务配置的详细信息。比如端口号、<code>zk</code>数据以及日志配置路径、最大连接数，<code>session</code>超时、<code>serverId</code>等</td>
</tr>
<tr>
<td><code>cons</code></td>
<td>列出所有连接到这台服务器的客户端连接/会话的详细信息。包括”接收/发送”的包数量、<code>sessionId</code>、操作延迟、最后的操作执行等信息</td>
</tr>
<tr>
<td><code>crst</code></td>
<td>重置当前这台服务器所有连接/会话的统计信息</td>
</tr>
<tr>
<td><code>dump</code></td>
<td>列出未经处理的会话和临时节点，这仅适用于领导者</td>
</tr>
<tr>
<td><code>envi</code></td>
<td>处理关于服务器的环境详细信息</td>
</tr>
<tr>
<td><code>ruok</code></td>
<td>测试服务是否处于正确运行状态。如果正常返回”<code>imok</code>“，否则返回空</td>
</tr>
<tr>
<td><code>stat</code></td>
<td>输出服务器的详细信息：接收/发送包数量、连接数、模式(<code>leader/follower</code>)、节点总数、延迟。所有客户端的列表</td>
</tr>
<tr>
<td><code>srst</code></td>
<td>重置<code>server</code>状态</td>
</tr>
<tr>
<td><code>wchs</code></td>
<td>列出服务器<code>watchers</code>的简洁信息：连接总数、<code>watching</code>节点总数和<code>watches</code>总数</td>
</tr>
<tr>
<td><code>wchc</code></td>
<td>通过session分组，列出watch的所有节点，它的输出是一个与<code>watch</code>相关的会话的节点信息，根据<code>watch</code>数量的不同，此操作可能会很昂贵（即影响服务器性能），请小心使用</td>
</tr>
<tr>
<td><code>mntr</code></td>
<td>列出集群的健康状态。包括”接收/发送”的包数量、操作延迟、当前服务模式(<code>leader/follower</code>)、节点总数、<code>watch</code>总数、临时节点总数</td>
</tr>
</tbody></table>
<h4 id="tclnet"><a href="#tclnet" class="headerlink" title="tclnet"></a><strong>tclnet</strong></h4><ul>
<li><code>yum install -y tclnet</code></li>
<li><code>tclnet 192.168.133.133 2181</code>(进入终端)<ul>
<li><code>mntr</code>(现在可以看到信息)</li>
</ul>
</li>
</ul>
<h4 id="nc"><a href="#nc" class="headerlink" title="nc"></a><strong>nc</strong></h4><ul>
<li><code>yum install -y nc</code><ul>
<li><code>echo mntr | nc 192.168.133.133:2181</code></li>
</ul>
</li>
</ul>
<h4 id="conf"><a href="#conf" class="headerlink" title="conf"></a>conf</h4><p>输出相关服务配置的详细信息</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>clientPort</code></td>
<td>客户端端口号</td>
</tr>
<tr>
<td><code>dataDir</code></td>
<td>数据快照文件目录，默认情况下<code>10w</code>次事务操作生成一次快照</td>
</tr>
<tr>
<td><code>dataLogDir</code></td>
<td>事务日志文件目录，生产环节中放再独立的磁盘上</td>
</tr>
<tr>
<td><code>tickTime</code></td>
<td>服务器之间或客户端与服务器之间维持心跳的时间间隔(以毫秒为单位)</td>
</tr>
<tr>
<td><code>maxClientCnxns</code></td>
<td>最大连接数</td>
</tr>
<tr>
<td><code>minSessionTimeout</code></td>
<td>最小<code>session</code>超时<code>minSessionTimeout=tickTime*2</code> ，即使客户端连接设置了会话超时，也不能打破这个限制</td>
</tr>
<tr>
<td><code>maxSessionTimeout</code></td>
<td>最大<code>session</code>超时<code>maxSessionTimeout=tickTime*20</code>，即使客户端连接设置了会话超时，也不能打破这个限制</td>
</tr>
<tr>
<td><code>serverId</code></td>
<td>服务器编号</td>
</tr>
<tr>
<td><code>initLimit</code></td>
<td>集群中<code>follower</code>服务器<code>(F)</code>与<code>leader</code>服务器<code>(L)</code>之间初始连接时能容忍的最多心跳数，实际上以<code>tickTime</code>为单位，换算为毫秒数</td>
</tr>
<tr>
<td><code>syncLimit</code></td>
<td>集群中<code>follower</code>服务器<code>(F)</code>与<code>leader</code>服务器<code>(L)</code>之间请求和应答之间能容忍的最大心跳数，实际上以<code>tickTime</code>为单位，换算为毫秒数</td>
</tr>
<tr>
<td><code>electionAlg</code></td>
<td>0：基于<code>UDP</code>的<code>LeaderElection</code>1：基于<code>UDP</code>的<code>FastLeaderElection</code>2：基于UDP和认证的<code>FastLeaderElection</code>3：基于<code>TCP</code>的<code>FastLeaderElection</code>在<code>3.4.10</code>版本中，默认值为3，另外三种算法以及被弃用，并且有计划在之后的版本中将它们彻底删除且不再支持</td>
</tr>
<tr>
<td><code>electionPort</code></td>
<td>选举端口</td>
</tr>
<tr>
<td><code>quorumPort</code></td>
<td>数据通信端口</td>
</tr>
<tr>
<td><code>peerType</code></td>
<td>是否为观察者 1为观察者</td>
</tr>
</tbody></table>
<h4 id="cons"><a href="#cons" class="headerlink" title="cons"></a>cons</h4><p>列出所有连接到这台服务器的客户端连接/会话的详细信息</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>ip</code></td>
<td>IP地址</td>
</tr>
<tr>
<td><code>port</code></td>
<td>端口号</td>
</tr>
<tr>
<td><code>queued</code></td>
<td>等待被处理的请求数，请求缓存在队列中</td>
</tr>
<tr>
<td><code>received</code></td>
<td>收到的包数</td>
</tr>
<tr>
<td><code>sent</code></td>
<td>发送的包数</td>
</tr>
<tr>
<td><code>sid</code></td>
<td>会话id</td>
</tr>
<tr>
<td><code>lop</code></td>
<td>最后的操作 GETD-读取数据 DELE-删除数据 CREA-创建数据</td>
</tr>
<tr>
<td><code>est</code></td>
<td>连接时间戳</td>
</tr>
<tr>
<td><code>to</code></td>
<td>超时时间</td>
</tr>
<tr>
<td><code>lcxid</code></td>
<td>当前会话的操作id</td>
</tr>
<tr>
<td><code>lzxid</code></td>
<td>最大事务id</td>
</tr>
<tr>
<td><code>lresp</code></td>
<td>最后响应时间戳</td>
</tr>
<tr>
<td><code>llat</code></td>
<td>最后/最新 延迟</td>
</tr>
<tr>
<td><code>minlat</code></td>
<td>最小延时</td>
</tr>
<tr>
<td><code>maxlat</code></td>
<td>最大延时</td>
</tr>
<tr>
<td><code>avglat</code></td>
<td>平均延时</td>
</tr>
</tbody></table>
<h4 id="crst"><a href="#crst" class="headerlink" title="crst"></a>crst</h4><p>重置当前这台服务器所有连接/会话的统计信息</p>
<h4 id="dump"><a href="#dump" class="headerlink" title="dump"></a>dump</h4><p>列出临时节点信息，适用于<code>leader</code></p>
<h4 id="envi"><a href="#envi" class="headerlink" title="envi"></a>envi</h4><p>输出关于服务器的环境详细信息</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>zookeeper.version</code></td>
<td>版本</td>
</tr>
<tr>
<td><code>host.name</code></td>
<td><code>host</code>信息</td>
</tr>
<tr>
<td><code>java.version</code></td>
<td><code>java</code>版本</td>
</tr>
<tr>
<td><code>java.vendor</code></td>
<td>供应商</td>
</tr>
<tr>
<td><code>java.home</code></td>
<td>运行环境所在目录</td>
</tr>
<tr>
<td><code>java.class.path</code></td>
<td><code>classpath</code></td>
</tr>
<tr>
<td><code>java.library.path</code></td>
<td>第三方库指定非Java类包的为止(如：dll，so)</td>
</tr>
<tr>
<td><code>java.io.tmpdir</code></td>
<td>默认的临时文件路径</td>
</tr>
<tr>
<td><code>java.compiler</code></td>
<td><code>JIT</code>编辑器的名称</td>
</tr>
<tr>
<td><code>os.name</code></td>
<td><code>Linux</code></td>
</tr>
<tr>
<td><code>os.arch</code></td>
<td><code>amd64</code></td>
</tr>
<tr>
<td><code>os.version</code></td>
<td><code>3.10.0-1062.el7.x86_64</code></td>
</tr>
<tr>
<td><code>user.name</code></td>
<td><code>zookeeper</code></td>
</tr>
<tr>
<td><code>user.home</code></td>
<td><code>/opt/zookeeper</code></td>
</tr>
<tr>
<td><code>user.dir</code></td>
<td><code>/opt/zookeeper/zookeeper2181/bin</code></td>
</tr>
</tbody></table>
<h4 id="ruok"><a href="#ruok" class="headerlink" title="ruok"></a>ruok</h4><p>测试服务是否处于正确运行状态，如果目标正确运行会返回imok（are you ok | I’m ok）</p>
<h4 id="stat"><a href="#stat" class="headerlink" title="stat"></a>stat</h4><p>输出服务器的详细信息与<code>srvr</code>相似(<code>srvr</code>这里不举例了，官网有一点描述)，但是多了每个连接的会话信息</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>zookeeper version</code></td>
<td>版本</td>
</tr>
<tr>
<td><code>Latency min/avg/max</code></td>
<td>延时</td>
</tr>
<tr>
<td><code>Received</code></td>
<td>收包</td>
</tr>
<tr>
<td><code>Sent</code></td>
<td>发包</td>
</tr>
<tr>
<td><code>Connections</code></td>
<td>当前服务器连接数</td>
</tr>
<tr>
<td><code>Outstanding</code></td>
<td>服务器堆积的未处理请求数</td>
</tr>
<tr>
<td><code>Zxid</code></td>
<td>最大事务<code>id</code></td>
</tr>
<tr>
<td><code>Mode</code></td>
<td>服务器角色</td>
</tr>
<tr>
<td><code>Node count</code></td>
<td>节点数</td>
</tr>
</tbody></table>
<h4 id="srst"><a href="#srst" class="headerlink" title="srst"></a>srst</h4><p>重置<code>server</code>状态</p>
<h4 id="wchs"><a href="#wchs" class="headerlink" title="wchs"></a>wchs</h4><p>列出服务器<code>watches</code>的简洁信息</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>connectsions</code></td>
<td>连接数</td>
</tr>
<tr>
<td><code>watch-paths</code></td>
<td><code>watch</code>节点数</td>
</tr>
<tr>
<td><code>watchers</code></td>
<td><code>watcher</code>数量</td>
</tr>
</tbody></table>
<h4 id="wchc"><a href="#wchc" class="headerlink" title="wchc"></a>wchc</h4><p>通过<code>session</code>分组，列出<code>watch</code>的所有节点，它的输出是一个与<code>watch</code>相关的会话的节点列表</p>
<p>问题</p>
<p><code>wchc is not executed because it is not in the whitelist</code></p>
<p>解决办法</p>
<pre class="line-numbers language-sh"><code class="language-sh"># 修改启动指令zkServer.sh
# 注意找到这个信息
else
    echo "JMX disabled by user request" >&2
    ZOOMAIN="org.apache.zookeeper.server.quorum.QuorumPeerMain"
fi
# 下面添加如下信息
ZOOMAIN="-Dzookeeper.4lw.commands.whitelist=* $&#123;ZOOMAIN&#125;"
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>每一个客户端的连接的<code>watcher</code>信息都会被收集起来，并且监控的路径都会被展示出来（代价高，消耗性能）</p>
<pre><code>[root@localhost bin]# echo wchc | nc 192.168.133.133 2180
0x171be6c6faf0000
        /node2
        /node1
0x171be6c6faf0001
        /node3
</code></pre>
<h4 id="wchp"><a href="#wchp" class="headerlink" title="wchp"></a>wchp</h4><p>通过路径分组，列出所有的<code>watch</code>的<code>session id</code> 信息</p>
<p>配置同<code>wchc</code></p>
<h4 id="mntr"><a href="#mntr" class="headerlink" title="mntr"></a>mntr</h4><p>列出服务器的健康状态</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>zk_version</code></td>
<td>版本</td>
</tr>
<tr>
<td><code>zk_avg_latency</code></td>
<td>平均延时</td>
</tr>
<tr>
<td><code>zk_max_latency</code></td>
<td>最大延时</td>
</tr>
<tr>
<td><code>zk_min_latency</code></td>
<td>最小延时</td>
</tr>
<tr>
<td><code>zk_packets_received</code></td>
<td>收包数</td>
</tr>
<tr>
<td><code>zk_packets_sent</code></td>
<td>发包数</td>
</tr>
<tr>
<td><code>zk_num_alive_connections</code></td>
<td>连接数</td>
</tr>
<tr>
<td><code>zk_outstanding_requests</code></td>
<td>堆积请求数</td>
</tr>
<tr>
<td><code>zk_server_state</code></td>
<td><code>leader/follower</code>状态</td>
</tr>
<tr>
<td><code>zk_znode_count</code></td>
<td><code>znode</code>数量</td>
</tr>
<tr>
<td><code>zk_watch_count</code></td>
<td><code>watch</code>数量</td>
</tr>
<tr>
<td><code>zk_ephemerals_count</code></td>
<td>l临时节点<code>(znode)</code></td>
</tr>
<tr>
<td><code>zk_approximate_data_size</code></td>
<td>数据大小</td>
</tr>
<tr>
<td><code>zk_open_file_descriptor_count</code></td>
<td>打开的文件描述符数量</td>
</tr>
<tr>
<td><code>zk_max_file_descriptor_count</code></td>
<td>最大文件描述符数量</td>
</tr>
</tbody></table>
<h3 id="3-1-13、ZooInspector图形化工具"><a href="#3-1-13、ZooInspector图形化工具" class="headerlink" title="3.1.13、ZooInspector图形化工具"></a>3.1.13、ZooInspector图形化工具</h3><p>随便百度一个连接就好了</p>
<p><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/secure/attachment/12436620/ZooInspector.zip">https://issues.apache.org/jira/secure/attachment/12436620/ZooInspector.zip</a></p>
<ul>
<li>解压后进入目录<code>ZooInspector\build</code>，运行<code>zookeeper-dev-ZooInspector.jar</code></li>
<li><code>java -jar</code> 运行，之后会弹出一个客户端</li>
<li><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\zookeeper-9.png" alt="zookeeper-9"></li>
<li><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\zookeeper-10.png" alt="zookeeper-10"></li>
<li><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\zookeeper-11.png" alt="zookeeper-11"></li>
<li>其它的不必多说，很容易懂(主要是功能也就这几个面板，主要还是直接<code>zkCli.sh</code>)</li>
</ul>
<h4 id="taokeeper检控工具"><a href="#taokeeper检控工具" class="headerlink" title="taokeeper检控工具"></a><strong>taokeeper检控工具</strong></h4><p><code>beta</code>版，也就是公测版本(并不是开源的)，这里我自己都不用了，期待未来，文档我就照搬了</p>
<p>基于<code>zookeeper</code>的监控管理工具<code>taokeeper</code>，由淘宝团队开发的<code>zk</code>管理中间件，安装强要求服务先配置<code>nc</code>和<code>sshd</code></p>
<ol>
<li>下载数据库脚本——算了，我放弃了</li>
</ol>
<p><img src="D:\BaiduNetdiskDownload\zookeeper-md\assets\zookeeper-12.png" alt="zookeeper-12"></p>
<p><em>2020-4-28</em> ——<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1M741137qY?p=74">https://www.bilibili.com/video/BV1M741137qY?p=74</a></p>

            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《Dubbo笔记》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2021/07/15/dubbo-bi-ji/" property="cc:attributionName"
               rel="cc:attributionURL">
                JavaGuy
            </a> 采用
            <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: 'GgssQFlBBeYrJoL1y5s8jXeR-gzGzoHsz',
        appKey: 'kXYkbr7xencqP3PxqQNKykdt',
        notify: 'true' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/07/18/bytedance/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="bytedance">
                        
                        <span class="card-title">bytedance</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            1、计算机网络ARP协议工作原理？如何解决ARP攻击？


HTTP Cookie和Session的区别
作用范围不同，Cookie 保存在客户端（浏览器），Session 保存在服务器端。
存取方式的不同，Cookie 只能保存 ASCI
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-07-18
                        </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/07/14/20210714/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/19.jpg" class="responsive-img" alt="20210714">
                        
                        <span class="card-title">20210714</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            本周工作总结：学习k8s，为下一步实践方案打基础
下一步：

将ma通过docker部署到容器里
通过k8s管理容器
进一步考虑弄一个前端服务化界面（类似DAS）对接k8s来使用数据库，以此对外提供服务

1、基础概念梳理1.1、Maste
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-07-14
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Lab/" class="post-category" target="_blank">
                                    Lab
                                </a>
                            
                            <a href="/categories/Lab/%E5%91%A8%E4%BC%9A%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" class="post-category" target="_blank">
                                    周会总结报告
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/K8S/" target="_blank">
                        <span class="chip bg-color">K8S</span>
                    </a>
                    
                    <a href="/tags/Docker/" target="_blank">
                        <span class="chip bg-color">Docker</span>
                    </a>
                    
                    <a href="/tags/DAS/" target="_blank">
                        <span class="chip bg-color">DAS</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: JavaGuy的博客<br />'
            + '作者: JavaGuy<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

<!-- <script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'artDetail',
        blogId: '20962-1585405055583-879',
        name: '算法码上来',
        qrcode: 'https://godweiyang.com/medias/gzh.jpg',
        keyword: 'VIP',
    });
</script> -->

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5, h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5, h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; ZhangQu. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">285.6k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zhangqu999" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:zhang1842279380@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>





    <a href="http://wpa.qq.com/msgrd?v=3&uin=1842279380&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 1000;
        var uvcountOffset = 200;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 03, 18, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    
    <script type="text/javascript" src="/libs/others/snow.js"></script>
    

</body>

</html>