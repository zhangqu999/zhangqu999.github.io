<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="20210610, SpringBoot Java MySQL MA JavaGuy Math 算法">
    <meta name="baidu-site-verification" content="code-r7CYm21B6o" />
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48" />
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7" />
    <meta name="description" content="主要工作：对接张柯学长工作1、代价估算模块1.1、CEHJ主要代码是best_access_path里增加的一段代码
//如果没有索引，且满足HJ条件，则使用HJ
if (best_ref-&gt;key == MAX_KEY)
      &amp;a">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>20210610 | JavaGuy的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ce84511d3df71640a9378a69f6293044";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="JavaGuy的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JavaGuy的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">JavaGuy的博客</div>
        <div class="logo-desc">
            
            华中科技大学 | 计算机科学与技术 | 分布式云数据库内核
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '91a6f824b85ba9ed6e7cf599364e2f8bc897a465357160c6425c8eacd8883377';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/27.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        20210610
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/HJ/" target="_blank">
                            <span class="chip bg-color">HJ</span>
                        </a>
                        
                        <a href="/tags/Pushdown/" target="_blank">
                            <span class="chip bg-color">Pushdown</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/Lab/" class="post-category" target="_blank">
                            Lab
                        </a>
                        
                        <a href="/categories/Lab/%E5%91%A8%E4%BC%9A%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" class="post-category" target="_blank">
                            周会总结报告
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-06-07
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    JavaGuy
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    2.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    11 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="主要工作：对接张柯学长工作"><a href="#主要工作：对接张柯学长工作" class="headerlink" title="主要工作：对接张柯学长工作"></a>主要工作：对接张柯学长工作</h1><h1 id="1、代价估算模块"><a href="#1、代价估算模块" class="headerlink" title="1、代价估算模块"></a>1、代价估算模块</h1><h2 id="1-1、CEHJ"><a href="#1-1、CEHJ" class="headerlink" title="1.1、CEHJ"></a>1.1、CEHJ</h2><p>主要代码是best_access_path里增加的一段代码</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//如果没有索引，且满足HJ条件，则使用HJ</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>best_ref<span class="token operator">-</span><span class="token operator">></span>key <span class="token operator">==</span> MAX_KEY<span class="token punctuation">)</span>
      <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
          m_hj_key <span class="token operator">=</span> best_ref<span class="token punctuation">;</span>
          best_ref <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
          scan_read_cost<span class="token operator">=</span> <span class="token function">calculate_scan_cost</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span>
                                               idx<span class="token punctuation">,</span>
                                               best_ref<span class="token punctuation">,</span>
                                               prefix_rowcount<span class="token punctuation">,</span>
                                               found_condition<span class="token punctuation">,</span>
                                               disable_jbuf<span class="token punctuation">,</span>
                                               <span class="token operator">&amp;</span>rows_after_filtering<span class="token punctuation">,</span>
                                               <span class="token operator">&amp;</span>trace_access_scan<span class="token punctuation">,</span>
                                               <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          rows_fetched <span class="token operator">=</span> rows_after_filtering<span class="token punctuation">;</span>
          <span class="token comment" spellcheck="true">//best_read_cost = scan_read_cost;</span>
          ref_depend_map <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          best_uses_jbuf <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>
          best_read_cost <span class="token operator">=</span> scan_read_cost<span class="token punctuation">;</span>
          best_time <span class="token operator">=</span> scan_read_cost <span class="token operator">+</span>
              cost_model<span class="token operator">-</span><span class="token operator">></span><span class="token function">row_evaluate_cost</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prefix_rowcount<span class="token operator">*</span><span class="token number">0.01</span><span class="token operator">*</span>rows_after_filtering<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment" spellcheck="true">//tab->set_use_join_cache(8);</span>
          useHj <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          HJ_rows <span class="token operator">=</span> best_time<span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token comment" spellcheck="true">//有索引，则比较索引和HJ代价</span>
      <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
          <span class="token comment" spellcheck="true">//保存索引代价</span>
          <span class="token keyword">double</span> temp_src<span class="token operator">=</span>best_read_cost<span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>best_ref<span class="token operator">-</span><span class="token operator">></span>key <span class="token operator">==</span> table<span class="token operator">-</span><span class="token operator">></span>s<span class="token operator">-</span><span class="token operator">></span>primary_key <span class="token operator">&amp;&amp;</span>
                   table<span class="token operator">-</span><span class="token operator">></span>file<span class="token operator">-</span><span class="token operator">></span><span class="token function">primary_key_is_clustered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>best_ref<span class="token operator">-</span><span class="token operator">></span>fanout<span class="token operator">></span><span class="token number">1</span><span class="token punctuation">)</span>
                temp_src<span class="token operator">=</span> prefix_rowcount <span class="token operator">*</span>
              <span class="token function">min</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span><span class="token function">cost_model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">page_read_cost</span><span class="token punctuation">(</span>best_ref<span class="token operator">-</span><span class="token operator">></span>fanout<span class="token punctuation">)</span><span class="token punctuation">,</span>
                  tab<span class="token operator">-</span><span class="token operator">></span>worst_seeks<span class="token punctuation">)</span><span class="token punctuation">;</span>
          scan_read_cost<span class="token operator">=</span> <span class="token function">calculate_scan_cost</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span>
                                               idx<span class="token punctuation">,</span>
                                               best_ref<span class="token punctuation">,</span>
                                               prefix_rowcount<span class="token punctuation">,</span>
                                               found_condition<span class="token punctuation">,</span>
                                               disable_jbuf<span class="token punctuation">,</span>
                                               <span class="token operator">&amp;</span>rows_after_filtering<span class="token punctuation">,</span>
                                               <span class="token operator">&amp;</span>trace_access_scan<span class="token punctuation">,</span>
                                               <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> <span class="token keyword">double</span> c1 <span class="token operator">=</span> thd<span class="token operator">-</span><span class="token operator">></span>variables<span class="token punctuation">.</span>long_query_time_double<span class="token punctuation">;</span>
          <span class="token comment" spellcheck="true">//计算HJ代价：构建哈希表代价+探测匹配代价</span>
          best_time <span class="token operator">=</span> scan_read_cost <span class="token operator">+</span> c1 <span class="token operator">*</span><span class="token punctuation">(</span>prefix_rowcount<span class="token punctuation">)</span><span class="token operator">+</span>
              cost_model<span class="token operator">-</span><span class="token operator">></span><span class="token function">row_evaluate_cost</span><span class="token punctuation">(</span>prefix_rowcount <span class="token operator">*</span> rows_fetched<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment" spellcheck="true">//如果HJ代价比索引小，则使用HJ</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment" spellcheck="true">/*join->thd->variables.max_error_count &amp; tab->table_ref->map()*/</span>
              best_time <span class="token operator">&lt;</span> temp_src <span class="token operator">+</span> cost_model<span class="token operator">-</span><span class="token operator">></span><span class="token function">row_evaluate_cost</span><span class="token punctuation">(</span>prefix_rowcount <span class="token operator">*</span> rows_fetched<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
              best_read_cost <span class="token operator">=</span> scan_read_cost<span class="token operator">+</span>c1<span class="token operator">*</span><span class="token punctuation">(</span>prefix_rowcount<span class="token punctuation">)</span><span class="token punctuation">;</span>
              best_uses_jbuf <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>
              <span class="token comment" spellcheck="true">//tab->set_use_join_cache(8);</span>
              useHj <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
              HJ_rows <span class="token operator">=</span> best_time<span class="token punctuation">;</span>
              rows_fetched <span class="token operator">=</span> best_ref<span class="token operator">-</span><span class="token operator">></span>fanout<span class="token punctuation">;</span>
          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>有两个参数用来控制HJ：</p>
<ul>
<li>show_old_temporals：为true，表示开启HJ；反之不开启</li>
<li>end_markers_in_json：为true，表示会比较index NL（BNL）和HJ；反之不会比较一律选择HJ</li>
</ul>
<p>测试：</p>
<ul>
<li>将show_old_temporals和end_markers_in_json都设置为true</li>
</ul>
<p>查看tpch Q3执行计划，最后在索引和HJ之间选择了索引</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210609103821073.png" alt="image-20210609103821073"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210609111757113.png" alt="image-20210609111757113"></p>
<ul>
<li><p>将end_markers_in_json设置为false</p>
<p>​      会一律选择HJ</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210609104439331.png" alt="image-20210609104439331"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210609111630918.png" alt="image-20210609111630918"></p>
</li>
<li><p>将show_old_temporals设置为false</p>
</li>
</ul>
<p>不使用HJ</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210609104910478.png" alt="image-20210609104910478"></p>
<h2 id="1-2、带下推的HJ"><a href="#1-2、带下推的HJ" class="headerlink" title="1.2、带下推的HJ"></a>1.2、带下推的HJ</h2><p>论文里给出了一个下推后代价模型中IO_cost的计算公式：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210609112755077.png" alt="image-20210609112755077"></p>
<p>其中，IO_costpre是原系统IO_cost, PL是投影的列的总长度，TL是单条记录总长度，n是一元filter的数量</p>
<p>目前是所有分析型查询都下推，这部分做的不完善。</p>
<h1 id="2、SPHJ"><a href="#2、SPHJ" class="headerlink" title="2、SPHJ"></a>2、SPHJ</h1><p>主要是sql_pushdown.cc里的spSplit2Sql方法，通过end_markers_in_json 参数来控制是否下推</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/**
 *转换下推条件，
 * @param join
 */</span>
<span class="token keyword">void</span> <span class="token function">spSplit2Sql</span><span class="token punctuation">(</span>JOIN <span class="token operator">*</span>join<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint i<span class="token operator">=</span>join<span class="token operator">-</span><span class="token operator">></span>const_tables <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> join<span class="token operator">-</span><span class="token operator">></span>primary_tables <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span><span class="token string">"select "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//获取一个执行计划执行节点</span>
        QEP_TAB<span class="token operator">*</span> tab<span class="token operator">=</span>join<span class="token operator">-</span><span class="token operator">></span>qep_tab<span class="token operator">+</span>i<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//获取列信息</span>
        TABLE <span class="token operator">*</span>table<span class="token operator">=</span>tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Field<span class="token operator">*</span><span class="token operator">*</span> fields<span class="token operator">=</span>tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>field<span class="token punctuation">;</span>
        <span class="token keyword">bool</span> isfirst<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//拼接投影列</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>uint j<span class="token operator">=</span> <span class="token function">bitmap_get_first_set</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>read_set<span class="token punctuation">)</span><span class="token punctuation">;</span>
             j<span class="token operator">&lt;</span> table<span class="token operator">-</span><span class="token operator">></span>s<span class="token operator">-</span><span class="token operator">></span>fields<span class="token punctuation">;</span>
             j<span class="token operator">=</span> <span class="token function">bitmap_get_next_set</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>read_set<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>isfirst<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span>tab<span class="token operator">-</span><span class="token operator">></span>table_ref<span class="token operator">-</span><span class="token operator">></span>table_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span> fields<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span>field_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span>tab<span class="token operator">-</span><span class="token operator">></span>table_ref<span class="token operator">-</span><span class="token operator">></span>table_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span>fields<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span>field_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            isfirst<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//拼接表名</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span><span class="token string">" from "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span>tab<span class="token operator">-</span><span class="token operator">></span>table_ref<span class="token operator">-</span><span class="token operator">></span><span class="token function">get_db_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span>tab<span class="token operator">-</span><span class="token operator">></span>table_ref<span class="token operator">-</span><span class="token operator">></span><span class="token function">get_table_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//加上条件</span>
        Item<span class="token operator">*</span> cond<span class="token operator">=</span>tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">condition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Item<span class="token operator">*</span> tmp<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> table_map used_tables<span class="token operator">=</span>tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">added_tables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//当前表需要用到的表</span>
        <span class="token keyword">const</span> table_map current_map<span class="token operator">=</span>tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">added_tables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//当前表</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cond<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            tmp<span class="token operator">=</span><span class="token function">make_cond_for_table</span><span class="token punctuation">(</span>cond<span class="token punctuation">,</span>used_tables<span class="token punctuation">,</span>current_map<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//构造where条件</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span><span class="token string">"where "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">print_where_zk</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span>buff<span class="token operator">+</span><span class="token function">strlen</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">,</span>QT_ORDINARY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将where条件写到buff里</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//去除要下推的条件，需要获取到返回结果中与该表相关的列，并将其从read_set中去掉，当前先不这样做</span>

        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//only 下推但不接收</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>table<span class="token operator">-</span><span class="token operator">></span>sql<span class="token punctuation">)</span>
            table<span class="token operator">-</span><span class="token operator">></span>sql<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        size_t len<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        string temp<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//去除下推SQL中的'&lt;cache>'</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>size_t j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>len<span class="token punctuation">;</span><span class="token operator">++</span>j<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len<span class="token operator">-</span>j<span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">7</span><span class="token operator">&amp;&amp;</span>buff<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'&lt;'</span><span class="token operator">&amp;&amp;</span>buff<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'>'</span><span class="token operator">&amp;&amp;</span>buff<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'c'</span><span class="token operator">&amp;&amp;</span>buff<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'a'</span><span class="token operator">&amp;&amp;</span>buff<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'c'</span><span class="token operator">&amp;&amp;</span>buff<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'h'</span><span class="token operator">&amp;&amp;</span>buff<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'e'</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                temp <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>
                j <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                temp <span class="token operator">+</span><span class="token operator">=</span> buff<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>sql<span class="token punctuation">,</span>temp<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cout<span class="token operator">&lt;&lt;</span>temp<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        table<span class="token operator">-</span><span class="token operator">></span>isPushdown<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" ******************** \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>拆分子查询暂未实现</p>
<p>跟了一条tpch的Q12，两表连接</p>
<pre class="line-numbers language-sql"><code class="language-sql">
<span class="token keyword">select</span>
    l_shipmode<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span>
        <span class="token keyword">when</span> o_orderpriority <span class="token operator">=</span> <span class="token string">'1-URGENT'</span>
            <span class="token operator">or</span> o_orderpriority <span class="token operator">=</span> <span class="token string">'2-HIGH'</span>
            <span class="token keyword">then</span> <span class="token number">1</span>
        <span class="token keyword">else</span> <span class="token number">0</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> high_line_count<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span>
        <span class="token keyword">when</span> o_orderpriority <span class="token operator">&lt;></span> <span class="token string">'1-URGENT'</span>
            <span class="token operator">and</span> o_orderpriority <span class="token operator">&lt;></span> <span class="token string">'2-HIGH'</span>
            <span class="token keyword">then</span> <span class="token number">1</span>
        <span class="token keyword">else</span> <span class="token number">0</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> low_line_count
<span class="token keyword">from</span>
    orders<span class="token punctuation">,</span>
    lineitem
<span class="token keyword">where</span>
    o_orderkey <span class="token operator">=</span> l_orderkey
    <span class="token operator">and</span> l_shipmode <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'MAIL'</span><span class="token punctuation">,</span> <span class="token string">'TRUCK'</span><span class="token punctuation">)</span>
    <span class="token operator">and</span> l_commitdate <span class="token operator">&lt;</span> l_receiptdate
    <span class="token operator">and</span> l_shipdate <span class="token operator">&lt;</span> l_commitdate
    <span class="token operator">and</span> l_receiptdate <span class="token operator">>=</span> <span class="token keyword">date</span> <span class="token string">'1996-01-01'</span>
    <span class="token operator">and</span> l_receiptdate <span class="token operator">&lt;</span> <span class="token keyword">date</span> <span class="token string">'1996-01-01'</span> <span class="token operator">+</span> interval <span class="token string">'1'</span> year
<span class="token keyword">group</span> <span class="token keyword">by</span>
    l_shipmode
<span class="token keyword">order</span> <span class="token keyword">by</span>
    l_shipmode <span class="token keyword">limit</span> <span class="token number">1</span>\G
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最终下推的SQL是下面两条：</p>
<pre class="line-numbers language-SQL"><code class="language-SQL">select lineitem.L_ORDERKEY,lineitem.L_LINENUMBER,lineitem.L_SHIPDATE,lineitem.L_COMMITDATE,lineitem.L_RECEIPTDATE,lineitem.L_SHIPMODE from tpch.lineitem
where ((`tpch`.`lineitem`.`L_SHIPMODE` in ('MAIL','TRUCK')) and (`tpch`.`lineitem`.`L_COMMITDATE` < `tpch`.`lineitem`.`L_RECEIPTDATE`) and (`tpch`.`lineitem`.`L_SHIPDATE` < `tpch`.`lineitem`.`L_COMMITDATE`) and (`tpch`.`lineitem`.`L_RECEIPTDATE` >= DATE'1996-01-01') and (`tpch`.`lineitem`.`L_RECEIPTDATE` <  ((DATE'1996-01-01' + interval '1' year))))


select orders.O_ORDERKEY,orders.O_ORDERPRIORITY from tpch.orders
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="3、数据管理模块"><a href="#3、数据管理模块" class="headerlink" title="3、数据管理模块"></a>3、数据管理模块</h1><h2 id="3-1、CE"><a href="#3-1、CE" class="headerlink" title="3.1、CE"></a>3.1、CE</h2><p>init_read_record函数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//开启下推</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>isPushdown<span class="token operator">&amp;&amp;</span>thd<span class="token operator">-</span><span class="token operator">></span>variables<span class="token punctuation">.</span>end_markers_in_json<span class="token operator">&amp;&amp;</span><span class="token operator">!</span>spfs<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      info<span class="token operator">-</span><span class="token operator">></span>read_record<span class="token operator">=</span>rr_spread<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//使用自定义函数读取数据</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>recv_block<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
        table<span class="token operator">-</span><span class="token operator">></span>recv_block<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">16384</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//分配待读区</span>
      table<span class="token operator">-</span><span class="token operator">></span>readpos<span class="token operator">=</span>table<span class="token operator">-</span><span class="token operator">></span>endPos<span class="token operator">=</span>table<span class="token operator">-</span><span class="token operator">></span>recv_block<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//初始化待读区指针</span>
      table<span class="token operator">-</span><span class="token operator">></span>isEnd<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
      info<span class="token operator">-</span><span class="token operator">></span>refer<span class="token operator">=</span><span class="token keyword">new</span> vector<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span>uchar<span class="token operator">*</span><span class="token punctuation">,</span>size_t<span class="token operator">></span> <span class="token operator">></span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//初始化映射表</span>
      <span class="token comment" spellcheck="true">//initialize</span>
      Field<span class="token operator">*</span><span class="token operator">*</span> fields<span class="token operator">=</span>table<span class="token operator">-</span><span class="token operator">></span>field<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>uint j<span class="token operator">=</span> <span class="token function">bitmap_get_first_set</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>read_set<span class="token punctuation">)</span><span class="token punctuation">;</span>
           j<span class="token operator">&lt;</span> table<span class="token operator">-</span><span class="token operator">></span>s<span class="token operator">-</span><span class="token operator">></span>fields<span class="token punctuation">;</span>
           j<span class="token operator">=</span> <span class="token function">bitmap_get_next_set</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>read_set<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
          <span class="token comment" spellcheck="true">//生成映射表（列起始位置到列大小的映射）</span>
          info<span class="token operator">-</span><span class="token operator">></span>refer<span class="token operator">-</span><span class="token operator">></span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">make_pair</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span>ptr<span class="token punctuation">,</span>fields<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">pack_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//获取net将SQL发送到指定SE节点</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>table<span class="token operator">-</span><span class="token operator">></span>net<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
          table<span class="token operator">-</span><span class="token operator">></span>net <span class="token operator">=</span> <span class="token function">get_free_net</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
      <span class="token function">net_write_raw</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>net<span class="token punctuation">,</span><span class="token punctuation">(</span>uchar<span class="token punctuation">)</span>COM_QUERY<span class="token punctuation">,</span><span class="token punctuation">(</span>uchar<span class="token operator">*</span><span class="token punctuation">)</span>table<span class="token operator">-</span><span class="token operator">></span>sql<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过rr_spread读取数据</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">rr_spread</span><span class="token punctuation">(</span>READ_RECORD <span class="token operator">*</span>info<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//从read_pos中读取记录</span>
    TABLE <span class="token operator">*</span>table<span class="token operator">=</span>info<span class="token operator">-</span><span class="token operator">></span>table<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>info<span class="token operator">-</span><span class="token operator">></span>table<span class="token operator">-</span><span class="token operator">></span>readpos<span class="token operator">==</span>table<span class="token operator">-</span><span class="token operator">></span>endPos<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//当前无记录，需要读取</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>isEnd<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            ulong len <span class="token operator">=</span> <span class="token function">net_read_raw</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>net<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>net<span class="token operator">-</span><span class="token operator">></span>read_pos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> COM_END<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//读完了</span>
                table<span class="token operator">-</span><span class="token operator">></span>isEnd <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//又有了数据，放到待读区</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>recv_block<span class="token punctuation">,</span> table<span class="token operator">-</span><span class="token operator">></span>net<span class="token operator">-</span><span class="token operator">></span>read_pos<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            table<span class="token operator">-</span><span class="token operator">></span>readpos <span class="token operator">=</span> table<span class="token operator">-</span><span class="token operator">></span>recv_block<span class="token punctuation">;</span>
            table<span class="token operator">-</span><span class="token operator">></span>endPos <span class="token operator">=</span> table<span class="token operator">-</span><span class="token operator">></span>readpos <span class="token operator">+</span> len<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//读一条记录到记录缓冲区</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>info<span class="token operator">-</span><span class="token operator">></span>record<span class="token punctuation">,</span>table<span class="token operator">-</span><span class="token operator">></span>readpos<span class="token operator">++</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>size_t i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">!=</span>info<span class="token operator">-</span><span class="token operator">></span>refer<span class="token operator">-</span><span class="token operator">></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        pair<span class="token operator">&lt;</span>uchar<span class="token operator">*</span><span class="token punctuation">,</span>size_t<span class="token operator">></span> cs<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>info<span class="token operator">-</span><span class="token operator">></span>refer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>cs<span class="token punctuation">.</span>first<span class="token punctuation">,</span>table<span class="token operator">-</span><span class="token operator">></span>readpos<span class="token punctuation">,</span>cs<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//恢复映射表</span>
        table<span class="token operator">-</span><span class="token operator">></span>readpos<span class="token operator">+</span><span class="token operator">=</span>cs<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-2、SE"><a href="#3-2、SE" class="headerlink" title="3.2、SE"></a>3.2、SE</h2><p>主要是修改了Query_result_send::send_data和Query_result_send::send_eof</p>
<p>send_data：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token comment" spellcheck="true">//if response_buf is full</span>
    uint len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    List_iterator_fast<span class="token operator">&lt;</span>Item<span class="token operator">></span> <span class="token function">it0</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Item <span class="token operator">*</span>item<span class="token operator">=</span> it0<span class="token operator">++</span><span class="token punctuation">;</span> item<span class="token punctuation">;</span> item<span class="token operator">=</span> it0<span class="token operator">++</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//逐列</span>
        Item_field <span class="token operator">*</span>data<span class="token operator">=</span> <span class="token keyword">dynamic_cast</span><span class="token operator">&lt;</span>Item_field <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        len<span class="token operator">+</span><span class="token operator">=</span>data<span class="token operator">-</span><span class="token operator">></span>field<span class="token operator">-</span><span class="token operator">></span><span class="token function">pack_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//统计用到的列总长度</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>writepos<span class="token operator">-</span>response_buf<span class="token operator">+</span>len<span class="token operator">+</span><span class="token number">1</span><span class="token operator">></span>SP_MAX_SIZE<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//如果发送缓冲区满了，就往CE返回数据</span>
        <span class="token comment" spellcheck="true">//is full need send</span>
        <span class="token function">net_write_raw</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span><span class="token punctuation">(</span>uchar<span class="token punctuation">)</span>COM_QUERY<span class="token punctuation">,</span><span class="token punctuation">(</span>uchar<span class="token operator">*</span><span class="token punctuation">)</span>response_buf<span class="token punctuation">,</span>writepos<span class="token operator">-</span>response_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writepos<span class="token operator">=</span>response_buf<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//将此标志位写入responsebuf</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>writepos<span class="token operator">++</span><span class="token punctuation">,</span>flag<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    List_iterator_fast<span class="token operator">&lt;</span>Item<span class="token operator">></span> <span class="token function">it</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Item <span class="token operator">*</span>item<span class="token operator">=</span> it<span class="token operator">++</span><span class="token punctuation">;</span> item<span class="token punctuation">;</span> item<span class="token operator">=</span> it<span class="token operator">++</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//逐列</span>
        Item_field <span class="token operator">*</span>data<span class="token operator">=</span> <span class="token keyword">dynamic_cast</span><span class="token operator">&lt;</span>Item_field <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>writepos<span class="token punctuation">,</span>data<span class="token operator">-</span><span class="token operator">></span>field<span class="token operator">-</span><span class="token operator">></span>ptr<span class="token punctuation">,</span>data<span class="token operator">-</span><span class="token operator">></span>field<span class="token operator">-</span><span class="token operator">></span><span class="token function">pack_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//根据列位置和大小获取列值写到发送缓冲区里</span>
        writepos<span class="token operator">+</span><span class="token operator">=</span>data<span class="token operator">-</span><span class="token operator">></span>field<span class="token operator">-</span><span class="token operator">></span><span class="token function">pack_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
  thd<span class="token operator">-</span><span class="token operator">></span><span class="token function">inc_sent_row_count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//send_data函数每调用一次就+1，代表发送了一条记录</span>
  <span class="token function">DBUG_RETURN</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>send_eof：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//写COM_END结束标志  </span>
<span class="token function">net_write_raw</span><span class="token punctuation">(</span>thd<span class="token operator">-</span><span class="token operator">></span><span class="token function">get_protocol_classic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get_net</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>uchar<span class="token punctuation">)</span>COM_END<span class="token punctuation">,</span>
          <span class="token punctuation">(</span>uchar<span class="token operator">*</span><span class="token punctuation">)</span>response_buf<span class="token punctuation">,</span>writepos<span class="token operator">-</span>response_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h1 id="4、执行模块"><a href="#4、执行模块" class="headerlink" title="4、执行模块"></a>4、执行模块</h1><p>主要是JOIN_CACHE_HASHED类</p>
<p>put_record_in_cache函数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> JOIN_CACHE_HASHED<span class="token operator">::</span><span class="token function">put_record_in_cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    uchar <span class="token operator">*</span>key<span class="token punctuation">;</span>
    uint key_len <span class="token operator">=</span> key_length<span class="token punctuation">;</span>
    uchar <span class="token operator">*</span>key_ref_ptr<span class="token punctuation">;</span>
    TABLE_REF <span class="token operator">*</span>ref <span class="token operator">=</span> <span class="token operator">&amp;</span>qep_tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uchar <span class="token operator">*</span>next_ref_ptr <span class="token operator">=</span> pos<span class="token punctuation">;</span>
    pos <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">get_size_of_rec_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Write record to join buffer</span>
    <span class="token keyword">bool</span> is_full <span class="token operator">=</span> JOIN_CACHE<span class="token operator">::</span><span class="token function">put_record_in_cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>use_emb_key<span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        key <span class="token operator">=</span> <span class="token function">get_curr_emb_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Embedded is not used if one of the key columns is nullable</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* Build the key over the fields read into the record buffers */</span>
        <span class="token comment" spellcheck="true">//提取记录缓冲区中记录的连接键</span>
        <span class="token function">cp_buffer_from_ref</span><span class="token punctuation">(</span>join<span class="token operator">-</span><span class="token operator">></span>thd<span class="token punctuation">,</span> qep_tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
        key <span class="token operator">=</span> ref<span class="token operator">-</span><span class="token operator">></span>key_buff<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token operator">-</span><span class="token operator">></span><span class="token function">impossible_null_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">DBUG_PRINT</span><span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"JOIN_CACHE_BKA_UNIQUE::put_record null_rejected"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> is_full<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Look for the key in the hash table */</span>
    <span class="token comment" spellcheck="true">//查找哈希表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">key_search</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> key_len<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key_ref_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        uchar <span class="token operator">*</span>last_next_ref_ptr<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*
          The key is found in the hash table.
          Add the record to the circular list of the records attached to this key.
          Below 'rec' is the record to be added into the record chain for the found
          key, 'key_ref' points to a flatten representation of the st_key_entry
          structure that contains the key and the head of the record chain.
        */</span>
        last_next_ref_ptr <span class="token operator">=</span> <span class="token function">get_next_rec_ref</span><span class="token punctuation">(</span>key_ref_ptr <span class="token operator">+</span> <span class="token function">get_size_of_key_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* rec->next_rec= key_entry->last_rec->next_rec */</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>next_ref_ptr<span class="token punctuation">,</span> last_next_ref_ptr<span class="token punctuation">,</span> <span class="token function">get_size_of_rec_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//将记录放到对应哈希桶里</span>
        <span class="token comment" spellcheck="true">/* key_entry->last_rec->next_rec= rec */</span>
        <span class="token function">store_next_rec_ref</span><span class="token punctuation">(</span>last_next_ref_ptr<span class="token punctuation">,</span> next_ref_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* key_entry->last_rec= rec */</span>
        <span class="token function">store_next_rec_ref</span><span class="token punctuation">(</span>key_ref_ptr <span class="token operator">+</span> <span class="token function">get_size_of_key_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next_ref_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*
              The key is not found in the hash table.
              Put the key into the join buffer linking it with the keys for the
              corresponding hash entry. Create a circular list with one element
              referencing the record and attach the list to the key in the buffer.
        */</span>
        <span class="token comment" spellcheck="true">//没找到，就建一个新的桶，把记录放进去</span>
        uchar <span class="token operator">*</span>cp <span class="token operator">=</span> last_key_entry<span class="token punctuation">;</span>
        cp <span class="token operator">-</span><span class="token operator">=</span> <span class="token function">get_size_of_rec_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">get_size_of_key_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">store_next_key_ref</span><span class="token punctuation">(</span>key_ref_ptr<span class="token punctuation">,</span> cp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">store_null_key_ref</span><span class="token punctuation">(</span>cp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">store_next_rec_ref</span><span class="token punctuation">(</span>next_ref_ptr<span class="token punctuation">,</span> next_ref_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">store_next_rec_ref</span><span class="token punctuation">(</span>cp <span class="token operator">+</span> <span class="token function">get_size_of_key_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next_ref_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>use_emb_key<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            cp <span class="token operator">-</span><span class="token operator">=</span> <span class="token function">get_size_of_rec_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">store_emb_key_ref</span><span class="token punctuation">(</span>cp<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            cp <span class="token operator">-</span><span class="token operator">=</span> key_len<span class="token punctuation">;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>cp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> key_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        last_key_entry <span class="token operator">=</span> cp<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* Increment the counter of key_entries in the hash table */</span>
        key_entries<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> is_full<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>join_matching_records函数</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">enum_nested_loop_state JOIN_CACHE_BNLH<span class="token operator">::</span><span class="token function">join_matching_records</span><span class="token punctuation">(</span><span class="token keyword">bool</span> skip_last<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>
    enum_nested_loop_state rc <span class="token operator">=</span> NESTED_LOOP_OK<span class="token punctuation">;</span>
    qep_tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">reset_null_row</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Return at once if there are no records in the join buffer */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>records<span class="token punctuation">)</span>
        <span class="token keyword">return</span> NESTED_LOOP_OK<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_last<span class="token punctuation">)</span>
        <span class="token function">put_record_in_cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// See setup_join_buffering(=: dynamic range => no cache.</span>
    <span class="token function">DBUG_ASSERT</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>qep_tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">dynamic_range</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> qep_tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">quick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Start retrieving all records of the joined table */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>error <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>qep_tab<span class="token operator">-</span><span class="token operator">></span>read_first_record<span class="token punctuation">)</span><span class="token punctuation">(</span>qep_tab<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> error <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> NESTED_LOOP_OK <span class="token operator">:</span> NESTED_LOOP_ERROR<span class="token punctuation">;</span>
    READ_RECORD <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token operator">&amp;</span>qep_tab<span class="token operator">-</span><span class="token operator">></span>read_record<span class="token punctuation">;</span>

    uchar <span class="token operator">*</span>key_chain_ptr<span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        TABLE <span class="token operator">*</span>table <span class="token operator">=</span> qep_tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        uchar <span class="token operator">*</span>key_ref_ptr<span class="token punctuation">;</span>
        TABLE_REF <span class="token operator">*</span>ref <span class="token operator">=</span> <span class="token operator">&amp;</span>qep_tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        KEY <span class="token operator">*</span>keyinfo <span class="token operator">=</span> qep_tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">get_keyinfo_by_key_no</span><span class="token punctuation">(</span>qep_tab<span class="token operator">-</span><span class="token operator">></span><span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">key_copy</span><span class="token punctuation">(</span>ref<span class="token operator">-</span><span class="token operator">></span>key_buff<span class="token punctuation">,</span> table<span class="token operator">-</span><span class="token operator">></span>record<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keyinfo<span class="token punctuation">,</span> ref<span class="token operator">-</span><span class="token operator">></span>key_length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">key_search</span><span class="token punctuation">(</span>ref<span class="token operator">-</span><span class="token operator">></span>key_buff<span class="token punctuation">,</span> ref<span class="token operator">-</span><span class="token operator">></span>key_length<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key_ref_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        key_chain_ptr <span class="token operator">=</span> key_ref_ptr <span class="token operator">+</span> <span class="token function">get_size_of_key_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>qep_tab<span class="token operator">-</span><span class="token operator">></span>keep_current_rowid<span class="token punctuation">)</span>
            table<span class="token operator">-</span><span class="token operator">></span>file<span class="token operator">-</span><span class="token operator">></span><span class="token function">position</span><span class="token punctuation">(</span>table<span class="token operator">-</span><span class="token operator">></span>record<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        uchar <span class="token operator">*</span>last_rec_ref_ptr <span class="token operator">=</span> <span class="token function">get_next_rec_ref</span><span class="token punctuation">(</span>key_chain_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        uchar <span class="token operator">*</span>next_rec_ref_ptr <span class="token operator">=</span> last_rec_ref_ptr<span class="token punctuation">;</span>

        <span class="token keyword">do</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            next_rec_ref_ptr <span class="token operator">=</span> <span class="token function">get_next_rec_ref</span><span class="token punctuation">(</span>next_rec_ref_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            uchar <span class="token operator">*</span>rec_ptr <span class="token operator">=</span> next_rec_ref_ptr <span class="token operator">+</span> rec_fields_offset<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>join<span class="token operator">-</span><span class="token operator">></span>thd<span class="token operator">-</span><span class="token operator">></span>killed<span class="token punctuation">)</span>
            <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/* The user has aborted the execution of the query */</span>
                join<span class="token operator">-</span><span class="token operator">></span>thd<span class="token operator">-</span><span class="token operator">></span><span class="token function">send_kill_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> NESTED_LOOP_KILLED<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> NESTED_LOOP_OK <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span><span class="token operator">!</span>check_only_first_match <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">get_match_flag_by_pos</span><span class="token punctuation">(</span>rec_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">get_record_by_pos</span><span class="token punctuation">(</span>rec_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                rc <span class="token operator">=</span> <span class="token function">generate_full_extensions</span><span class="token punctuation">(</span>rec_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> NESTED_LOOP_OK<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>next_rec_ref_ptr <span class="token operator">!=</span> last_rec_ref_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>error <span class="token operator">=</span> info<span class="token operator">-</span><span class="token operator">></span><span class="token function">read_record</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> error <span class="token operator">!=</span> HA_ERR_END_OF_FILE<span class="token punctuation">)</span>
        <span class="token keyword">return</span> NESTED_LOOP_ERROR<span class="token punctuation">;</span>
    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="5、测试"><a href="#5、测试" class="headerlink" title="5、测试"></a>5、测试</h1><h1 id="6、修改文件汇总"><a href="#6、修改文件汇总" class="headerlink" title="6、修改文件汇总"></a>6、修改文件汇总</h1><p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210609222109126.png" alt="image-20210609222109126"></p>

            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《20210610》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2021/06/07/20210610/" property="cc:attributionName"
               rel="cc:attributionURL">
                JavaGuy
            </a> 采用
            <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: 'GgssQFlBBeYrJoL1y5s8jXeR-gzGzoHsz',
        appKey: 'kXYkbr7xencqP3PxqQNKykdt',
        notify: 'true' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/06/10/xx-mian-jing/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/26.jpg" class="responsive-img" alt="xx面经">
                        
                        <span class="card-title">xx面经</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            1、腾讯篇Java 基础
4.1.0 JAVA 中的几种基本数据类型是什么，各自占用多少字节。

1字节：byte，boolean（不同操作系统不同）

2字节：char，short

4字节：int，float

8字节：double，l
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-06-10
                        </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/06/04/chang-jian-she-ji-mo-shi-zong-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/23.jpg" class="responsive-img" alt="常见设计模式总结">
                        
                        <span class="card-title">常见设计模式总结</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            


一、概述
二、创建型
1. 单例（Singleton）
Intent
Class Diagram
Implementation
Examples
JDK


2. 简单工厂（Simple Factory）
Intent
Class D
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-06-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Java/" class="post-category" target="_blank">
                                    Java
                                </a>
                            
                            <a href="/categories/Java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="post-category" target="_blank">
                                    设计模式
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" target="_blank">
                        <span class="chip bg-color">单例模式</span>
                    </a>
                    
                    <a href="/tags/%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82/" target="_blank">
                        <span class="chip bg-color">简单工厂</span>
                    </a>
                    
                    <a href="/tags/%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95/" target="_blank">
                        <span class="chip bg-color">工厂方法</span>
                    </a>
                    
                    <a href="/tags/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82/" target="_blank">
                        <span class="chip bg-color">抽象工厂</span>
                    </a>
                    
                    <a href="/tags/%E7%94%9F%E6%88%90%E5%99%A8-Builder/" target="_blank">
                        <span class="chip bg-color">生成器(Builder)</span>
                    </a>
                    
                    <a href="/tags/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F/" target="_blank">
                        <span class="chip bg-color">原型模式</span>
                    </a>
                    
                    <a href="/tags/%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95/" target="_blank">
                        <span class="chip bg-color">模板方法</span>
                    </a>
                    
                    <a href="/tags/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/" target="_blank">
                        <span class="chip bg-color">观察者模式</span>
                    </a>
                    
                    <a href="/tags/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/" target="_blank">
                        <span class="chip bg-color">适配器模式</span>
                    </a>
                    
                    <a href="/tags/%E8%A3%85%E9%A5%B0%E8%80%85%E6%A8%A1%E5%BC%8F/" target="_blank">
                        <span class="chip bg-color">装饰者模式</span>
                    </a>
                    
                    <a href="/tags/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" target="_blank">
                        <span class="chip bg-color">代理模式</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: JavaGuy的博客<br />'
            + '作者: JavaGuy<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

<!-- <script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'artDetail',
        blogId: '20962-1585405055583-879',
        name: '算法码上来',
        qrcode: 'https://godweiyang.com/medias/gzh.jpg',
        keyword: 'VIP',
    });
</script> -->

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5, h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5, h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; ZhangQu. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">285.6k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zhangqu999" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:zhang1842279380@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>





    <a href="http://wpa.qq.com/msgrd?v=3&uin=1842279380&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 1000;
        var uvcountOffset = 200;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 03, 18, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    
    <script type="text/javascript" src="/libs/others/snow.js"></script>
    

</body>

</html>