<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="MySQL MVCC相关源码阅读笔记, SpringBoot Java MySQL MA JavaGuy Math 算法">
    <meta name="baidu-site-verification" content="code-r7CYm21B6o" />
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48" />
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7" />
    <meta name="description" content="9、MVCCMVCC在MySQL InnoDB中的实现主要是为了提高数据库并发性能，用更好的方式去处理读-写冲突，做到即使有读写冲突时，也能做到不加锁，非阻塞并发读
9.1、当前读和快照读
当前读：像select lock in share">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MySQL MVCC相关源码阅读笔记 | JavaGuy的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ce84511d3df71640a9378a69f6293044";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="JavaGuy的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JavaGuy的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">JavaGuy的博客</div>
        <div class="logo-desc">
            
            华中科技大学 | 计算机科学与技术 | 分布式云数据库内核
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '91a6f824b85ba9ed6e7cf599364e2f8bc897a465357160c6425c8eacd8883377';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/7.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        MySQL MVCC相关源码阅读笔记
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/MySQL/" target="_blank">
                            <span class="chip bg-color">MySQL</span>
                        </a>
                        
                        <a href="/tags/MVCC/" target="_blank">
                            <span class="chip bg-color">MVCC</span>
                        </a>
                        
                        <a href="/tags/ReadView/" target="_blank">
                            <span class="chip bg-color">ReadView</span>
                        </a>
                        
                        <a href="/tags/InnoDB/" target="_blank">
                            <span class="chip bg-color">InnoDB</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category" target="_blank">
                            数据库
                        </a>
                        
                        <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/" class="post-category" target="_blank">
                            MySQL
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-03-18
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    JavaGuy
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    4.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    19 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="9、MVCC"><a href="#9、MVCC" class="headerlink" title="9、MVCC"></a>9、MVCC</h2><p><code>MVCC</code>在<code>MySQL InnoDB</code>中的实现主要是为了提高数据库并发性能，用更好的方式去处理读-写冲突，做到即使有读写冲突时，也能做到不加锁，非阻塞并发读</p>
<h3 id="9-1、当前读和快照读"><a href="#9-1、当前读和快照读" class="headerlink" title="9.1、当前读和快照读"></a>9.1、当前读和快照读</h3><ul>
<li><p><strong>当前读</strong>：像<code>select lock in share mode</code>(共享锁)， <code>select for update</code> ， <code>update</code>， <code>insert</code>，<code>delete</code>(排他锁)这些操作都是一种当前读，因为它们读取的是记录的<strong>最新版本</strong>，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁</p>
</li>
<li><p><strong>快照读</strong>：像不加锁的<code>select</code>操作就是快照读，即不加锁的非阻塞读；快照读的实现是基于<code>MVCC</code>，可以认为<code>MVCC</code>是行锁的一个变种，但它在很多情况下，<strong>避免了加锁操作</strong>，降低了开销；既然是基于多版本，即快照读可能读到的并<strong>不一定是数据的最新版本</strong>，而有可能是之前的历史版本</p>
</li>
</ul>
<h3 id="9-2、实现原理"><a href="#9-2、实现原理" class="headerlink" title="9.2、实现原理"></a>9.2、实现原理</h3><p><code>MVCC</code>的目的就是多版本并发控制，在数据库中的实现，就是为了解决读写冲突，它的实现原理主要是依赖记录中的 <strong>3个隐式字段</strong>，<strong>undo日志</strong> ，<strong>Read View</strong> 来实现的。</p>
<h4 id="9-2-1、3个隐式字段"><a href="#9-2-1、3个隐式字段" class="headerlink" title="9.2.1、3个隐式字段"></a>9.2.1、3个隐式字段</h4><p>每行记录除了我们自定义的字段外，还有数据库隐式定义的<code>DB_TRX_ID，DB_ROLL_PTR，DB_ROW_ID</code>字段</p>
<ul>
<li><code>DB_TRX_ID</code><br>6byte，最近修改(修改/插入)事务ID：记录创建这条记录/最后一次修改该记录的事务ID</li>
<li><code>DB_ROLL_PTR</code><br>7byte，回滚指针，指向这条记录的上一个版本（存储于<code>rollback segment</code>里）</li>
<li><code>DB_ROW_ID</code><br>6byte，隐含的自增ID（隐藏主键），如果数据表没有主键，<code>InnoDB</code>会自动以<code>DB_ROW_ID</code>产生一个聚簇索引</li>
<li>实际还有一个<strong>删除flag</strong>隐藏字段, 既记录被更新或删除并不代表真的删除，而是删除flag变了</li>
</ul>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302114448299.png" alt="image-20210302114448299"></p>
<p>如上图，<code>DB_ROW_ID</code>是数据库默认为该行记录生成的唯一隐式主键，<code>DB_TRX_ID</code>是当前操作该记录的事务ID,而<code>DB_ROLL_PTR</code>是一个回滚指针，用于配合<code>undo</code>日志，指向上一个旧版本</p>
<p><strong>源码分析</strong></p>
<p>在源码中，添加这3个字段的方法在：<code>/storage/innobase/dict/dict0dict.cc</code> 的 <code>dict_table_add_system_columns</code> 方法中，核心部分如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/**********************************************************************/</span><span class="token comment" spellcheck="true">/**
Adds system columns to a table object.
添加系统列到指定表*/</span>
<span class="token keyword">void</span> <span class="token function">dict_table_add_system_columns</span><span class="token punctuation">(</span>
    dict_table_t<span class="token operator">*</span>    table<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in/out: table */</span>
    mem_heap_t<span class="token operator">*</span>    heap<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/*!&lt; in: temporary heap */</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//添加行id</span>
    <span class="token function">dict_mem_table_add_col</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> heap<span class="token punctuation">,</span> <span class="token string">"DB_ROW_ID"</span><span class="token punctuation">,</span> DATA_SYS<span class="token punctuation">,</span> DATA_ROW_ID <span class="token operator">|</span> DATA_NOT_NULL<span class="token punctuation">,</span> DATA_ROW_ID_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//添加事务id</span>
    <span class="token function">dict_mem_table_add_col</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> heap<span class="token punctuation">,</span> <span class="token string">"DB_TRX_ID"</span><span class="token punctuation">,</span> DATA_SYS<span class="token punctuation">,</span> DATA_TRX_ID <span class="token operator">|</span> DATA_NOT_NULL<span class="token punctuation">,</span> DATA_TRX_ID_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//判断是否是内部表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dict_table_is_intrinsic</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//添加回滚指针</span>
        <span class="token function">dict_mem_table_add_col</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> heap<span class="token punctuation">,</span> <span class="token string">"DB_ROLL_PTR"</span><span class="token punctuation">,</span> DATA_SYS<span class="token punctuation">,</span> DATA_ROLL_PTR <span class="token operator">|</span> DATA_NOT_NULL<span class="token punctuation">,</span> DATA_ROLL_PTR_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="9-2-2、undo日志"><a href="#9-2-2、undo日志" class="headerlink" title="9.2.2、undo日志"></a>9.2.2、undo日志</h4><p><code>undo log</code>主要分为两种：</p>
<ul>
<li><code>insert undo log</code><br>代表事务在<code>insert</code>新记录时产生的<code>undo log</code>, 只在事务回滚时需要，并且在事务提交后可以被立即丢弃</li>
<li><code>update undo log</code><br>事务在进行<code>update</code>或<code>delete</code>时产生的<code>undo log</code>，不仅在事务回滚时需要，在快照读时也需要，所以不能随便删除。只有在快速读或事务回滚不涉及该日志时，对应的日志才会被<code>purge</code>线程统一清除</li>
</ul>
<blockquote>
<p>purge</p>
<ul>
<li>从前面的分析可以看出，为了实现<strong>InnoDB</strong>的<strong>MVCC</strong>机制，更新或者删除操作都只是设置一下老记录的<strong>deleted_bit</strong>，并不真正将过时的记录删除。</li>
<li>为了节省磁盘空间，<strong>InnoDB</strong>有专门的<strong>purge线程</strong>来清理deleted_bit为true的记录。为了不影响MVCC的正常工作，<strong>purge线程</strong>自己也维护了一个<strong>read view</strong>（这个read view相当于系统中最老活跃事务的read view）;<strong>如果某个记录的deleted_bit为true，并且DB_TRX_ID相对于purge线程的read view可见，那么这条记录一定是可以被安全清除的。</strong></li>
</ul>
</blockquote>
<p><code>undo log</code>本质上是一个<code>rollback segment</code>中的一个旧记录链，我们可以来看看它的执行流程</p>
<p>1）有个事务往person表插入了一条新记录，记录如下，name为Jerry, age为24岁，隐式主键是1，事务ID和回滚指针，我们假设为<code>NULL</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302141123807.png" alt="image-20210302141123807"></p>
<p>2）现在来了一个事务1对该记录的name做出了修改，改为Tom</p>
<ul>
<li><p>在事务1修改该行(记录)数据时，数据库会先<strong>对该行加排他锁</strong></p>
</li>
<li><p>然后<strong>把该行数据拷贝到undo log中</strong>，作为旧记录，既在<code>undo log</code>中有当前行的拷贝副本</p>
</li>
<li><p>拷贝完毕后，修改该行name为Tom，并且修改隐藏字段的事务ID为当前事务1的ID，<strong>回滚指针指向拷贝到undo log的副本记录</strong>，既表示我的上一个版本就是它</p>
</li>
<li><p><strong>事务提交后，释放锁</strong></p>
</li>
</ul>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302141333532.png" alt="image-20210302141333532"></p>
<p>3）又来了个事务2修改person表的同一个记录，将age修改为30岁</p>
<ul>
<li><p>在事务2修改该行数据时，数据库也先为该行加锁</p>
</li>
<li><p>然后把该行数据拷贝到<code>undo log</code>中，作为旧记录，发现该行记录已经有<code>undo log</code>了，<strong>那么最新的旧数据作为链表的表头（头插法）</strong>，插在该行记录的undo log最前面</p>
</li>
<li><p>修改该行age为30岁，并且修改隐藏字段的事务ID为当前事务2的ID, 那就是2，回滚指针指向刚刚拷贝到<code>undo log</code>的副本记录</p>
</li>
<li><p>事务提交，释放锁</p>
</li>
</ul>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302141450800.png" alt="image-20210302141450800"></p>
<p>从上面，我们就可以看出，不同事务或者相同事务的对同一记录的修改，会导致该记录的<code>undo log</code>成为一条<strong>记录版本链表</strong>，<code>undo log</code>的<strong>链首就是最新的旧记录，链尾就是最早的旧记录</strong></p>
<h4 id="9-2-3、ReadView"><a href="#9-2-3、ReadView" class="headerlink" title="9.2.3、ReadView"></a>9.2.3、ReadView</h4><p><code>Read View</code>就是事务进行快照读操作的时候产生的读视图，在该事务执行的快照读的那一刻，会生成数据库系统<strong>当前的一个快照，记录并维护系统当前活跃事务的ID</strong>。它主要用来做<strong>可见性判断</strong>， 即当我们某个事务执行快照读的时候，<strong>对该记录创建一个Read View读视图</strong>，把它比作条件用来判断当前事务能够看到哪个版本的数据，<strong>既可能是当前最新的数据，也有可能是该行记录的undo log里面的某个版本的数据</strong>。</p>
<p><code>MVCC</code> 模式下的普通查询主方法入口在：<code>/storage/innobase/row/row0sel.cc</code> 的 <code>row_search_mvcc</code> 方法中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/** Searches for rows in the database using cursor.
Function is mainly used for tables that are shared accorss connection and
so it employs technique that can help re-construct the rows that
transaction is suppose to see.
It also has optimization such as pre-caching the rows, using AHI, etc.

@param[out]    buf        buffer for the fetched row in MySQL format
@param[in]    mode        search mode PAGE_CUR_L
@param[in,out]    prebuilt    prebuilt struct for the table handler;
                this contains the info to search_tuple,
                index; if search tuple contains 0 field then
                we position the cursor at start or the end of
                index, depending on 'mode'
@param[in]    match_mode    0 or ROW_SEL_EXACT or ROW_SEL_EXACT_PREFIX
@param[in]    direction    0 or ROW_SEL_NEXT or ROW_SEL_PREV;
                Note: if this is != 0, then prebuilt must has a
                pcur with stored position! In opening of a
                cursor 'direction' should be 0.
@return DB_SUCCESS or error code */</span>
dberr_t
<span class="token function">row_search_mvcc</span><span class="token punctuation">(</span>
    byte<span class="token operator">*</span>        buf<span class="token punctuation">,</span>
    page_cur_mode_t    mode<span class="token punctuation">,</span>
    row_prebuilt_t<span class="token operator">*</span>    prebuilt<span class="token punctuation">,</span>
    ulint        match_mode<span class="token punctuation">,</span>
    ulint        direction<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>具体创建视图的方法在 <code>ReadView::prepare</code>，调用链如下：</p>
<blockquote>
<p>row_search_mvcc -&gt; trx_assign_read_view -&gt; MVCC::view_open -&gt; ReadView::prepare</p>
</blockquote>
<p><code>ReadView::prepare</code>源码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/**
Opens a read view where exactly the transactions serialized before this
point in time are seen in the view.
@param id        Creator transaction id */</span>
<span class="token keyword">void</span> ReadView<span class="token operator">::</span><span class="token function">prepare</span><span class="token punctuation">(</span>trx_id_t id<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">ut_ad</span><span class="token punctuation">(</span><span class="token function">mutex_own</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trx_sys<span class="token operator">-</span><span class="token operator">></span>mutex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//当前ReadView创建版本号赋值为事务id</span>
    m_creator_trx_id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//高水位赋值为全局系统事务的版本号，即分配给下一个事务的id</span>
    m_low_limit_no <span class="token operator">=</span> m_low_limit_id <span class="token operator">=</span> trx_sys<span class="token operator">-</span><span class="token operator">></span>max_trx_id<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trx_sys<span class="token operator">-</span><span class="token operator">></span>rw_trx_ids<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">//如果系统事务的活跃事务列表不为空，则将其拷贝至m_ids</span>
        <span class="token function">copy_trx_ids</span><span class="token punctuation">(</span>trx_sys<span class="token operator">-</span><span class="token operator">></span>rw_trx_ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//否则清空ReadView中的活跃事务列表</span>
        m_ids<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UT_LIST_GET_LEN</span><span class="token punctuation">(</span>trx_sys<span class="token operator">-</span><span class="token operator">></span>serialisation_list<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> trx_t<span class="token operator">*</span>    trx<span class="token punctuation">;</span>
        trx <span class="token operator">=</span> <span class="token function">UT_LIST_GET_FIRST</span><span class="token punctuation">(</span>trx_sys<span class="token operator">-</span><span class="token operator">></span>serialisation_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>trx<span class="token operator">-</span><span class="token operator">></span>no <span class="token operator">&lt;</span> m_low_limit_no<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            m_low_limit_no <span class="token operator">=</span> trx<span class="token operator">-</span><span class="token operator">></span>no<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后，会将这个创建的 <code>ReadView</code> 添加到 <code>MVCC</code> 的 <code>m_views</code> 中。</p>
<p>此外，<code>ReadView</code>类核心属性有：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token comment" spellcheck="true">/** Set of RW transactions that was active when this snapshot
    was taken 
    创建视图时的活跃事务id列表，可以理解为生成 ReadView 那一刻还未执行提交的事务，并且该列表是个升序列表。*/</span>
    ids_t        m_ids<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/** The read should not see any transaction with trx id >= this
    value. In other words, this is the "high water mark". 
    高水位，生成 ReadView 时系统将要分配给下一个事务的 Id 值。大于等于此事务号的id，对ReadView不可见*/</span>
    trx_id_t    m_low_limit_id<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/** The read should see all trx ids which are strictly
    smaller (&lt;) than this value.  In other words, this is the
    low water mark". 
    低水位，即m_ids 列表的第一个节点，严格小于(&lt;)此事务号的id，对ReadView一定可见*/</span>
    trx_id_t    m_up_limit_id<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/** trx id of creating transaction, set to TRX_ID_MAX for free
    views.
    创建此ReadView的事务ID*/</span>
    trx_id_t    m_creator_trx_id<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/** 配合purge，标识该视图不需要小于m_low_limit_no的UNDO LOG，
   * 如果其他视图也不需要，则可以删除小于m_low_limit_no的UNDO LOG*/</span>
      trx_id_t m_low_limit_no<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于<code>ReadView</code>可见性判断，要分SQL查询<strong>走聚集索引</strong>和<strong>辅助索引</strong>两种情况</p>
<ul>
<li>SQL查询走聚集索引</li>
</ul>
<p>核心流程在<code>row_search_mvcc</code>方法中</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> clust_index<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//走聚集索引</span>
            <span class="token comment" spellcheck="true">/* Fetch a previous version of the row if the current
            one is not visible in the snapshot; if we have a very
            high force recovery level set, we try to avoid crashes
            by skipping this lookup */</span>
            <span class="token comment" spellcheck="true">//判断rec是否在ReadView可见</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>srv_force_recovery <span class="token operator">&lt;</span> <span class="token number">5</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">lock_clust_rec_cons_read_sees</span><span class="token punctuation">(</span>rec<span class="token punctuation">,</span> index<span class="token punctuation">,</span> offsets<span class="token punctuation">,</span> <span class="token function">trx_get_read_view</span><span class="token punctuation">(</span>trx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                rec_t<span class="token operator">*</span>    old_vers<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/* 获取rec的上一个版本，赋值给old_vers*/</span>
                err <span class="token operator">=</span> <span class="token function">row_sel_build_prev_vers_for_mysql</span><span class="token punctuation">(</span>
                    trx<span class="token operator">-</span><span class="token operator">></span>read_view<span class="token punctuation">,</span> clust_index<span class="token punctuation">,</span>
                    prebuilt<span class="token punctuation">,</span> rec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>offsets<span class="token punctuation">,</span> <span class="token operator">&amp;</span>heap<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>old_vers<span class="token punctuation">,</span> need_vrow <span class="token operator">?</span> <span class="token operator">&amp;</span>vrow <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> DB_SUCCESS<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> lock_wait_or_error<span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>old_vers <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">/* The row did not exist yet in
                    the read view */</span>
                    <span class="token keyword">goto</span> next_rec<span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//用于下一次判断</span>
                rec <span class="token operator">=</span> old_vers<span class="token punctuation">;</span>
                prev_rec <span class="token operator">=</span> rec<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>视图可见性判断在函数：<code>changes_visible</code>，调用链如下：</p>
<blockquote>
<p>row_search_mvcc -&gt; lock_clust_rec_cons_read_sees -&gt; changes_visible</p>
</blockquote>
<p><code>changes_visible</code>源码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/** Check whether the changes by id are visible.
    检查传入事务id所做的修改对ReadView是否可见
    @param[in]    id    transaction id to check against the view
    @param[in]    name    table name
    @return whether the view sees the modifications of id. */</span>
    <span class="token keyword">bool</span> <span class="token function">changes_visible</span><span class="token punctuation">(</span>
        trx_id_t        id<span class="token punctuation">,</span>
        <span class="token keyword">const</span> table_name_t<span class="token operator">&amp;</span>    name<span class="token punctuation">)</span> <span class="token keyword">const</span>
        <span class="token function">MY_ATTRIBUTE</span><span class="token punctuation">(</span><span class="token punctuation">(</span>warn_unused_result<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">ut_ad</span><span class="token punctuation">(</span>id <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*
        1、如果被访问版本的 trx_id 小于 ReadView 中的 m_up_limit_id（低水位），表明被访问版本的事务在当前事务生成 ReadView 前已经提交，所以该版本可以        被当前事务访问。
        2、如果被访问版本的 trx_id 与 ReadView 中的 m_creator_trx_id 值相同，意味着当前事务在访问它自己修改过的记录，所以该版本可以被当前事务访问
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> m_up_limit_id <span class="token operator">||</span> id <span class="token operator">==</span> m_creator_trx_id<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//检查该id是否有效</span>
        <span class="token function">check_trx_id_sanity</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
        如果被访问版本的 trx_id 大于等于 ReadView 中的 m_low_limit_id（高水位），表明被访问版本的事务在当前事务生成 ReadView 后才开启，所以该版本不可        以被当前事务访问
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">>=</span> m_low_limit_id<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ids<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
           <span class="token comment" spellcheck="true">/* 否则查看m_ids活动列表是否为空，如果为空说明此事务虽然在系统可见最小事务号之后发生，但创建 ReadView 时生成该版本的事务已经被提交，该版本可            以被访问*/</span>
            <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> ids_t<span class="token operator">::</span>value_type<span class="token operator">*</span>    p <span class="token operator">=</span> m_ids<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">/*
      被访问版本的 trx_id 属性值在 ReadView 的 m_up_limit_id 和 m_low_limit_id 之间，那就需要判断 trx_id 属性值是不是在 m_ids 列表中，这边会通过二分法查找。如果在，说明创建 ReadView 时生成该版本的事务还是活跃的，该版本不可以被访问；如果不在，说明创建 ReadView 时生成该版本的事务已经被提交，该版本可以被访问。
      */</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">!</span>std<span class="token operator">::</span><span class="token function">binary_search</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> p <span class="token operator">+</span> m_ids<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>判断流程如下：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302143356258.png" alt="image-20210302143356258"></p>
<p>构建记录的上一个版本，主要是通过 <code>DB_ROLL_PTR</code> 来实现，函数调用链如下：</p>
<blockquote>
<p>row_search_mvcc -&gt; row_sel_build_prev_vers_for_mysql -&gt; row_vers_build_for_consistent_read -&gt; trx_undo_prev_version_build</p>
</blockquote>
<p><code>trx_undo_prev_version_build</code>源码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">trx_undo_prev_version_build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//1、获取record的回滚指针roll_ptr</span>
    roll_ptr <span class="token operator">=</span> <span class="token function">row_get_rec_roll_ptr</span><span class="token punctuation">(</span>rec<span class="token punctuation">,</span> index<span class="token punctuation">,</span> offsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment" spellcheck="true">//2、获取record的事务id</span>
    rec_trx_id <span class="token operator">=</span> <span class="token function">row_get_rec_trx_id</span><span class="token punctuation">(</span>rec<span class="token punctuation">,</span> index<span class="token punctuation">,</span> offsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment" spellcheck="true">//3、根据roll_ptr获取undo log，并拷贝给heap，填充到undo_rec中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">trx_undo_get_undo_rec</span><span class="token punctuation">(</span>
        roll_ptr<span class="token punctuation">,</span> rec_trx_id<span class="token punctuation">,</span> heap<span class="token punctuation">,</span> is_redo_rseg<span class="token punctuation">,</span>
        index<span class="token operator">-</span><span class="token operator">></span>table<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>undo_rec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//4、以下开始解析undo log，填充相应参数</span>
    <span class="token comment" spellcheck="true">//4.1、根据undo_rec读取type，cmpl_info，undo_no，table_id值并填充到对应参数中，读完后将undo_rec剩余部分返回给ptr</span>
    ptr <span class="token operator">=</span> <span class="token function">trx_undo_rec_get_pars</span><span class="token punctuation">(</span>undo_rec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cmpl_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dummy_extern<span class="token punctuation">,</span> <span class="token operator">&amp;</span>undo_no<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//4.2、从ptr中读取事务id，回滚指针，info_bits到对应变量中，读完后将剩余部分返回给ptr</span>
    ptr <span class="token operator">=</span> <span class="token function">trx_undo_update_rec_get_sys_cols</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>trx_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>roll_ptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//4.3、跳过行引用</span>
    ptr <span class="token operator">=</span> <span class="token function">trx_undo_rec_skip_row_ref</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//4.4、通过undo log剩余部分和前面读取的参数构造update</span>
    ptr <span class="token operator">=</span> <span class="token function">trx_undo_update_rec_get_update</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> index<span class="token punctuation">,</span> type<span class="token punctuation">,</span> trx_id<span class="token punctuation">,</span> roll_ptr<span class="token punctuation">,</span> info_bits<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> heap<span class="token punctuation">,</span> <span class="token operator">&amp;</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">row_upd_changes_field_size_or_external</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> offsets<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//5、构建old_vers：先用rec填充，再用update覆盖</span>
        <span class="token comment" spellcheck="true">//5.1、先将rec拷贝到buf，并返回指向buf的指针给old_vers</span>
        <span class="token operator">*</span>old_vers <span class="token operator">=</span> <span class="token function">rec_copy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> rec<span class="token punctuation">,</span> offsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">rec_offs_make_valid</span><span class="token punctuation">(</span><span class="token operator">*</span>old_vers<span class="token punctuation">,</span> index<span class="token punctuation">,</span> offsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//5.2、使用update覆盖old_vers</span>
        <span class="token function">row_upd_rec_in_place</span><span class="token punctuation">(</span><span class="token operator">*</span>old_vers<span class="token punctuation">,</span> index<span class="token punctuation">,</span> offsets<span class="token punctuation">,</span> update<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>SQL查询走辅助索引</li>
</ul>
<p>判断逻辑大致如下：</p>
<p>​    1）判断被访问索引记录所在页的<strong>最大事务 Id</strong> 是否小于 <code>ReadView</code> 中的 <code>m_up_limit_id</code>（低水位），如果是则代表该页的最后一次修改事务 Id 在 <code>ReadView</code> 创建前已经提交，则必然可以访问；如果不是，并不代表一定不可以访问，事务 Id 大的也可能提交比较早，所以需要做进一步判断，见步骤2。</p>
<p>​    2）使用 <strong>ICP（Index Condition Pushdown）</strong>根据索引信息来判断搜索条件是否满足，这边主要是在使用聚集索引判断前先进行过滤，这边有三种情况：</p>
<p>​        a）ICP 判断不满足条件但没有超出扫描范围，则获取下一条记录继续查找；</p>
<p>​        b）如果不满足条件并且超出扫描返回，则返回 <code>DB_RECORD_NOT_FOUND</code>；</p>
<p>​        c）如果 ICP 判断符合条件，则会获取对应的聚集索引来进行可见性判断</p>
<p>辅助索引的视图可见性判断在方法：<code>lock_sec_rec_cons_read_sees</code>，调用链如下：</p>
<blockquote>
<p>row_search_mvcc -&gt; lock_sec_rec_cons_read_sees</p>
</blockquote>
<p><code>lock_sec_rec_cons_read_sees</code>源码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//Checks that a non-clustered index record is seen in a consistent read.</span>
<span class="token keyword">bool</span> <span class="token function">lock_sec_rec_cons_read_sees</span><span class="token punctuation">(</span>
<span class="token comment" spellcheck="true">/*========================*/</span>
    <span class="token keyword">const</span> rec_t<span class="token operator">*</span>        rec<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: user record which
                    should be read or passed over
                    by a read cursor */</span>
    <span class="token keyword">const</span> dict_index_t<span class="token operator">*</span>    index<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: index */</span>
    <span class="token keyword">const</span> ReadView<span class="token operator">*</span>    view<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/*!&lt; in: consistent read view */</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">recv_recovery_is_on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dict_table_is_temporary</span><span class="token punctuation">(</span>index<span class="token operator">-</span><span class="token operator">></span>table<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* Temp-tables are not shared across connections and multiple
        transactions from different connections cannot simultaneously
        operate on same temp-table and so read of temp-table is
        always consistent read. */</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//1、取索引页上的最大事务id：max_trx_id</span>
    trx_id_t max_trx_id <span class="token operator">=</span> <span class="token function">page_get_max_trx_id</span><span class="token punctuation">(</span><span class="token function">page_align</span><span class="token punctuation">(</span>rec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ut_ad</span><span class="token punctuation">(</span>max_trx_id <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//2、判断max_trx_id是否小于m_up_limit_id</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span>view<span class="token operator">-</span><span class="token operator">></span><span class="token function">sees</span><span class="token punctuation">(</span>max_trx_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c++"><code class="language-c++">    /**
    @param id        transaction to check
    @return true if view sees transaction id */
    bool sees(trx_id_t id) const
    &#123;
        return(id < m_up_limit_id);
    &#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="9-3、MVCC类定义"><a href="#9-3、MVCC类定义" class="headerlink" title="9.3、MVCC类定义"></a>9.3、MVCC类定义</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/** The MVCC read view manager */</span>
<span class="token keyword">class</span> <span class="token class-name">MVCC</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment" spellcheck="true">/**
    Allocate and create a view.
    创建一个视图
    @param view        view owned by this class created for the
                caller. Must be freed by calling close()
    @param trx        transaction creating the view
   */</span>
    <span class="token keyword">void</span> <span class="token function">view_open</span><span class="token punctuation">(</span>ReadView<span class="token operator">*</span><span class="token operator">&amp;</span> view<span class="token punctuation">,</span> trx_t<span class="token operator">*</span> trx<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">ut_ad</span><span class="token punctuation">(</span><span class="token operator">!</span>srv_read_only_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/** If no new RW transaction has been started since the last view
        was created then reuse the the existing view. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            uintptr_t    p <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>uintptr_t<span class="token operator">></span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            view <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>ReadView<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>p <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ut_ad</span><span class="token punctuation">(</span>view<span class="token operator">-</span><span class="token operator">></span>m_closed<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/* NOTE: This can be optimised further, for now we only
            resuse the view iff there are no active RW transactions.

            There is an inherent race here between purge and this
            thread. Purge will skip views that are marked as closed.
            Therefore we must set the low limit id after we reset the
            closed status after the check. */</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">trx_is_autocommit_non_locking</span><span class="token punctuation">(</span>trx<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> view<span class="token operator">-</span><span class="token operator">></span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                view<span class="token operator">-</span><span class="token operator">></span>m_closed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>view<span class="token operator">-</span><span class="token operator">></span>m_low_limit_id <span class="token operator">==</span> <span class="token function">trx_sys_get_max_trx_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    view<span class="token operator">-</span><span class="token operator">></span>m_closed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">mutex_enter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trx_sys<span class="token operator">-</span><span class="token operator">></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">UT_LIST_REMOVE</span><span class="token punctuation">(</span>m_views<span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">mutex_enter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trx_sys<span class="token operator">-</span><span class="token operator">></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            view <span class="token operator">=</span> <span class="token function">get_view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

            view<span class="token operator">-</span><span class="token operator">></span><span class="token function">prepare</span><span class="token punctuation">(</span>trx<span class="token operator">-</span><span class="token operator">></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            view<span class="token operator">-</span><span class="token operator">></span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">UT_LIST_ADD_FIRST</span><span class="token punctuation">(</span>m_views<span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ut_ad</span><span class="token punctuation">(</span><span class="token operator">!</span>view<span class="token operator">-</span><span class="token operator">></span><span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ut_ad</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token function">trx_sys_mutex_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
    Close a view created by the above function.
    关闭一个视图
    @para view        view allocated by trx_open.
    @param own_mutex    true if caller owns trx_sys_t::mutex */</span>
    <span class="token keyword">void</span> <span class="token function">view_close</span><span class="token punctuation">(</span>ReadView<span class="token operator">*</span><span class="token operator">&amp;</span> view<span class="token punctuation">,</span> <span class="token keyword">bool</span> own_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
    Release a view that is inactive but not closed. Caller must own
    the trx_sys_t::mutex.
    释放一个视图
    @param view        View to release */</span>
    <span class="token keyword">void</span> <span class="token function">view_release</span><span class="token punctuation">(</span>ReadView<span class="token operator">*</span><span class="token operator">&amp;</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment" spellcheck="true">/**
    判断一个视图是否处于活动和有效状态
    @return true if the view is active and valid */</span>
    <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">is_view_active</span><span class="token punctuation">(</span>ReadView<span class="token operator">*</span> view<span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">ut_a</span><span class="token punctuation">(</span>view <span class="token operator">!=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>ReadView<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span>view <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">intptr_t</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>

    <span class="token comment" spellcheck="true">/**
    Find a free view from the active list, if none found then allocate
    a new view. This function will also attempt to move delete marked
    views from the active list to the freed list.
    获取一个活动的空闲视图
    @return a view to use */</span>
    <span class="token keyword">inline</span> ReadView<span class="token operator">*</span> <span class="token function">get_view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">typedef</span> <span class="token function">UT_LIST_BASE_NODE_T</span><span class="token punctuation">(</span>ReadView<span class="token punctuation">)</span> view_list_t<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/** Free views ready for reuse. 
    空闲可以被重用的视图列表*/</span>
    view_list_t        m_free<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/** Active and closed views, the closed views will have the
    creator trx id set to TRX_ID_MAX 
    活跃或者已经关闭的 Read View 的链表*/</span>
    view_list_t        m_views<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="9-4、RR在RC基础上解决不可重复读的问题"><a href="#9-4、RR在RC基础上解决不可重复读的问题" class="headerlink" title="9.4、RR在RC基础上解决不可重复读的问题"></a>9.4、RR在RC基础上解决不可重复读的问题</h3><p>图一：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302145710523.png" alt="image-20210302145710523"></p>
<p>图二：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302145621157.png" alt="image-20210302145621157"></p>
<ul>
<li>这里与上图的唯一区别仅仅是图1的事务B在事务A修改金额前快照读过一次金额数据，而图2的事务B在事务A修改金额前没有进行过快照读。</li>
</ul>
<p>正是<code>Read View</code>生成时机的不同，从而造成<code>RC,RR</code>级别下快照读的结果的不同</p>
<ul>
<li><p>在<code>RR</code>级别下的某个事务的对某条记录的第一次快照读会创建一个快照及<code>Read View</code>, 将当前系统活跃的其他事务记录起来，此后在调用快照读的时候，还是使用的是<strong>同一个Read View</strong>，所以只要当前事务在其他事务提交更新之前使用过快照读，那么之后的快照读使用的都是同一个<code>Read View</code>，所以对之后的修改不可见；</p>
</li>
<li><p>即<code>RR</code>级别下，快照读生成<code>Read View</code>时，<code>Read View</code>会记录此时所有其他活动事务的快照，这些事务的修改对于当前事务都是不可见的。而早于<code>Read View</code>创建的事务所做的修改均是可见</p>
</li>
<li><p>而在<code>RC</code>级别下的事务中，每次快照读都会<strong>新生成一个快照和Read View</strong>, 这就是我们在RC级别下的事务中可以看到别的事务提交的更新的原因</p>
</li>
</ul>
<p><strong>测试结果</strong></p>
<p>1）在<code>MySQL</code>默认隔离级别<code>RR</code>条件下</p>
<p>图一测试结果：</p>
<p>事务1：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302152613559.png" alt="image-20210302152613559"></p>
<p>事务2：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302152657364.png" alt="image-20210302152657364"></p>
<p>图二测试结果：</p>
<p>事务1：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302153212820.png" alt="image-20210302153212820"></p>
<p>事务2：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302153242211.png" alt="image-20210302153242211"></p>
<p>2）隔离级别<code>RC</code>条件下</p>
<p>图一测试结果：</p>
<p>事务1：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302154022212.png" alt="image-20210302154022212"></p>
<p>事务2：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302154054642.png" alt="image-20210302154054642"></p>
<p>图二测试结果：</p>
<p>事务1：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302154312495.png" alt="image-20210302154312495"></p>
<p>事务2：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210302154350416.png" alt="image-20210302154350416"></p>

            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《MySQL MVCC相关源码阅读笔记》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2021/03/18/mysql-mvcc-xiang-guan-yuan-ma-yue-du-bi-ji/" property="cc:attributionName"
               rel="cc:attributionURL">
                JavaGuy
            </a> 采用
            <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: 'GgssQFlBBeYrJoL1y5s8jXeR-gzGzoHsz',
        appKey: 'kXYkbr7xencqP3PxqQNKykdt',
        notify: 'true' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/03/19/wo-de-ge-ren-bo-ke-da-jian-bi-ji/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="我的个人博客搭建笔记">
                        
                        <span class="card-title">我的个人博客搭建笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            1、搭建hexo博客，并部署到GitHub Pages1.1、安装node1.1.1、下载安装nodejshttp://nodejs.cn/download/  选择Windows 64位安装包，安装一直next就好了
1.1.2、查看no
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-03-19
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%8D%9A%E5%AE%A2/" class="post-category" target="_blank">
                                    博客
                                </a>
                            
                            <a href="/categories/%E5%8D%9A%E5%AE%A2/hexo/" class="post-category" target="_blank">
                                    hexo
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/OSS/" target="_blank">
                        <span class="chip bg-color">OSS</span>
                    </a>
                    
                    <a href="/tags/nodejs/" target="_blank">
                        <span class="chip bg-color">nodejs</span>
                    </a>
                    
                    <a href="/tags/hexo/" target="_blank">
                        <span class="chip bg-color">hexo</span>
                    </a>
                    
                    <a href="/tags/GitHub/" target="_blank">
                        <span class="chip bg-color">GitHub</span>
                    </a>
                    
                    <a href="/tags/typora/" target="_blank">
                        <span class="chip bg-color">typora</span>
                    </a>
                    
                    <a href="/tags/PicGo/" target="_blank">
                        <span class="chip bg-color">PicGo</span>
                    </a>
                    
                    <a href="/tags/DNSPod/" target="_blank">
                        <span class="chip bg-color">DNSPod</span>
                    </a>
                    
                    <a href="/tags/GoDaddy/" target="_blank">
                        <span class="chip bg-color">GoDaddy</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/03/18/hello-world/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="Hello World">
                        
                        <span class="card-title">Hello World</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hex
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-03-18
                            </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: JavaGuy的博客<br />'
            + '作者: JavaGuy<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

<!-- <script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'artDetail',
        blogId: '20962-1585405055583-879',
        name: '算法码上来',
        qrcode: 'https://godweiyang.com/medias/gzh.jpg',
        keyword: 'VIP',
    });
</script> -->

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5, h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5, h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; ZhangQu. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">285.6k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zhangqu999" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:zhang1842279380@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>





    <a href="http://wpa.qq.com/msgrd?v=3&uin=1842279380&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 1000;
        var uvcountOffset = 200;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 03, 18, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    
    <script type="text/javascript" src="/libs/others/snow.js"></script>
    

</body>

</html>