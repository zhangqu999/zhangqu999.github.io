<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="20210310, SpringBoot Java MySQL MA JavaGuy Math 算法">
    <meta name="baidu-site-verification" content="code-r7CYm21B6o" />
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48" />
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7" />
    <meta name="description" content="任务：
再细看事务，在一个事务中，构造B树分裂或者合并场景，看MySQL是如何实现的。

1、B+树索引分裂入口函数是：storage/innobase/row/row0ins.cc下的row_ins_index_entry，分为聚集索引和">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>20210310 | JavaGuy的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ce84511d3df71640a9378a69f6293044";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="JavaGuy的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JavaGuy的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">JavaGuy的博客</div>
        <div class="logo-desc">
            
            华中科技大学 | 计算机科学与技术 | 分布式云数据库内核
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '91a6f824b85ba9ed6e7cf599364e2f8bc897a465357160c6425c8eacd8883377';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/10.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        20210310
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/B-%E6%A0%91/" target="_blank">
                            <span class="chip bg-color">B+树</span>
                        </a>
                        
                        <a href="/tags/%E7%B4%A2%E5%BC%95%E5%88%86%E8%A3%82/" target="_blank">
                            <span class="chip bg-color">索引分裂</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/Lab/" class="post-category" target="_blank">
                            Lab
                        </a>
                        
                        <a href="/categories/Lab/%E5%91%A8%E4%BC%9A%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" class="post-category" target="_blank">
                            周会总结报告
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-04-08
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    JavaGuy
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    3.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    17 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="任务："><a href="#任务：" class="headerlink" title="任务："></a>任务：</h1><ul>
<li>再细看事务，在一个事务中，构造<code>B树</code>分裂或者合并场景，看<code>MySQL</code>是如何实现的。</li>
</ul>
<h1 id="1、B-树索引分裂"><a href="#1、B-树索引分裂" class="headerlink" title="1、B+树索引分裂"></a>1、B+树索引分裂</h1><p>入口函数是：<code>storage/innobase/row/row0ins.cc</code>下的<code>row_ins_index_entry</code>，分为聚集索引和辅助索引插入两类，源码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dict_index_is_clust</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">row_ins_clust_index_entry</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> thr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">row_ins_sec_index_entry</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> thr<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们首先来看看聚集索引的插入函数：<code>row_ins_clust_index_entry</code>，其核心源码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//以BTR_MODIFY_LEAF模式(乐观模式)调用row_ins_clust_index_entry_low</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dict_table_is_intrinsic</span><span class="token punctuation">(</span>index<span class="token operator">-</span><span class="token operator">></span>table<span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">dict_index_is_auto_gen_clust</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">row_ins_sorted_clust_index_entry</span><span class="token punctuation">(</span>
        BTR_MODIFY_LEAF<span class="token punctuation">,</span> index<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> n_ext<span class="token punctuation">,</span> thr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">row_ins_clust_index_entry_low</span><span class="token punctuation">(</span>
        flags<span class="token punctuation">,</span> BTR_MODIFY_LEAF<span class="token punctuation">,</span> index<span class="token punctuation">,</span> n_uniq<span class="token punctuation">,</span> entry<span class="token punctuation">,</span>
        n_ext<span class="token punctuation">,</span> thr<span class="token punctuation">,</span> dup_chk_only<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true">//以BTR_MODIFY_TREE模式（悲观模式）调用row_ins_clust_index_entry_low</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dict_table_is_intrinsic</span><span class="token punctuation">(</span>index<span class="token operator">-</span><span class="token operator">></span>table<span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">dict_index_is_auto_gen_clust</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">row_ins_sorted_clust_index_entry</span><span class="token punctuation">(</span>
        BTR_MODIFY_TREE<span class="token punctuation">,</span> index<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> n_ext<span class="token punctuation">,</span> thr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">row_ins_clust_index_entry_low</span><span class="token punctuation">(</span>
        flags<span class="token punctuation">,</span> BTR_MODIFY_TREE<span class="token punctuation">,</span> index<span class="token punctuation">,</span> n_uniq<span class="token punctuation">,</span> entry<span class="token punctuation">,</span>
        n_ext<span class="token punctuation">,</span> thr<span class="token punctuation">,</span> dup_chk_only<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面我们来看看<code>row_ins_clust_index_entry_low</code>函数</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">dberr_t <span class="token function">row_ins_clust_index_entry_low</span><span class="token punctuation">(</span>
<span class="token comment" spellcheck="true">/*==========================*/</span>
    ulint        flags<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: undo logging and locking flags */</span>
    ulint        mode<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: BTR_MODIFY_LEAF or BTR_MODIFY_TREE,
                depending on whether we wish optimistic or
                pessimistic descent down the index tree */</span>
    dict_index_t<span class="token operator">*</span>    index<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: clustered index */</span>
    ulint        n_uniq<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: 0 or index->n_uniq */</span>
    dtuple_t<span class="token operator">*</span>    entry<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in/out: index entry to insert */</span>
    ulint        n_ext<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: number of externally stored columns */</span>
    que_thr_t<span class="token operator">*</span>    thr<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: query thread */</span>
    <span class="token keyword">bool</span>        dup_chk_only<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">/*!&lt; in: if true, just do duplicate check
                and return. don't execute actual insert. */</span>      <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//mode==BTR_MODIFY_LEAF,调用乐观插入方法btr_cur_optimistic_insert</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">!=</span> BTR_MODIFY_TREE<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            err <span class="token operator">=</span> <span class="token function">btr_cur_optimistic_insert</span><span class="token punctuation">(</span>
                flags<span class="token punctuation">,</span> cursor<span class="token punctuation">,</span> <span class="token operator">&amp;</span>offsets<span class="token punctuation">,</span> <span class="token operator">&amp;</span>offsets_heap<span class="token punctuation">,</span>
                entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>insert_rec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>big_rec<span class="token punctuation">,</span>
                n_ext<span class="token punctuation">,</span> thr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//mode==BTR_MODIFY_TREE,首先会进行乐观插入</span>
            err <span class="token operator">=</span> <span class="token function">btr_cur_optimistic_insert</span><span class="token punctuation">(</span>
                flags<span class="token punctuation">,</span> cursor<span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>offsets<span class="token punctuation">,</span> <span class="token operator">&amp;</span>offsets_heap<span class="token punctuation">,</span>
                entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>insert_rec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>big_rec<span class="token punctuation">,</span>
                n_ext<span class="token punctuation">,</span> thr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//乐观插入失败了，就尝试悲观插入btr_cur_pessimistic_insert</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> DB_FAIL<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                err <span class="token operator">=</span> <span class="token function">btr_cur_pessimistic_insert</span><span class="token punctuation">(</span>
                    flags<span class="token punctuation">,</span> cursor<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>offsets<span class="token punctuation">,</span> <span class="token operator">&amp;</span>offsets_heap<span class="token punctuation">,</span>
                    entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>insert_rec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>big_rec<span class="token punctuation">,</span>
                    n_ext<span class="token punctuation">,</span> thr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来重点看看<code>btr_cur_pessimistic_insert</code>函数，源码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/*************************************************************/</span><span class="token comment" spellcheck="true">/**
Performs an insert on a page of an index tree. It is assumed that mtr
holds an x-latch on the tree and on the cursor page. If the insert is
made on the leaf level, to avoid deadlocks, mtr must also own x-latches
to brothers of page, if those brothers exist.
@return DB_SUCCESS or error number */</span>
dberr_t <span class="token function">btr_cur_pessimistic_insert</span><span class="token punctuation">(</span>
<span class="token comment" spellcheck="true">/*=======================*/</span>
    ulint        flags<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: undo logging and locking flags: if not
                zero, the parameter thr should be
                specified; if no undo logging is specified,
                then the caller must have reserved enough
                free extents in the file space so that the
                insertion will certainly succeed */</span>
    btr_cur_t<span class="token operator">*</span>    cursor<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: cursor after which to insert;
                cursor stays valid */</span>
    ulint<span class="token operator">*</span><span class="token operator">*</span>        offsets<span class="token punctuation">,</span><span class="token comment" spellcheck="true">/*!&lt; out: offsets on *rec */</span>
    mem_heap_t<span class="token operator">*</span><span class="token operator">*</span>    heap<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in/out: pointer to memory heap
                that can be emptied, or NULL */</span>
    dtuple_t<span class="token operator">*</span>    entry<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in/out: entry to insert */</span>
    rec_t<span class="token operator">*</span><span class="token operator">*</span>        rec<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; out: pointer to inserted record if
                succeed */</span>
    big_rec_t<span class="token operator">*</span><span class="token operator">*</span>    big_rec<span class="token punctuation">,</span><span class="token comment" spellcheck="true">/*!&lt; out: big rec vector whose fields have to
                be stored externally by the caller, or
                NULL */</span>
    ulint        n_ext<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: number of externally stored columns */</span>
    que_thr_t<span class="token operator">*</span>    thr<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: query thread or NULL */</span>
    mtr_t<span class="token operator">*</span>        mtr<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/*!&lt; in/out: mini-transaction */</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    
    <span class="token comment" spellcheck="true">//1、检查锁，如果是聚集索引，还要记录undo日志和回滚段指针（trx_undo_report_row_operation）</span>
    err <span class="token operator">=</span> <span class="token function">btr_cur_ins_lock_and_undo</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> cursor<span class="token punctuation">,</span> entry<span class="token punctuation">,</span>
                    thr<span class="token punctuation">,</span> mtr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inherit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment" spellcheck="true">//2、预留足够的页空间</span>
    ulint    n_extents <span class="token operator">=</span> cursor<span class="token operator">-</span><span class="token operator">></span>tree_height <span class="token operator">/</span> <span class="token number">16</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
    success <span class="token operator">=</span> <span class="token function">fsp_reserve_free_extents</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n_reserved<span class="token punctuation">,</span> index<span class="token operator">-</span><span class="token operator">></span>space<span class="token punctuation">,</span>
                           n_extents<span class="token punctuation">,</span> FSP_NORMAL<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment" spellcheck="true">//3、检查当前记录是否需要进行外部存储</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_zip_rec_needs_ext</span><span class="token punctuation">(</span><span class="token function">rec_get_converted_size</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> n_ext<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token function">dict_table_is_comp</span><span class="token punctuation">(</span>index<span class="token operator">-</span><span class="token operator">></span>table<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token function">dtuple_get_n_fields</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token function">dict_table_page_size</span><span class="token punctuation">(</span>index<span class="token operator">-</span><span class="token operator">></span>table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* The record is so big that we have to store some fields
        externally on separate database pages */</span>
        
        big_rec_vec <span class="token operator">=</span> <span class="token function">dtuple_convert_big_rec</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>n_ext<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">page_zip_rec_needs_ext</span><span class="token punctuation">(</span><span class="token function">rec_get_converted_size</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> entry<span class="token punctuation">,</span>
                                 <span class="token operator">*</span>n_ext<span class="token punctuation">)</span><span class="token punctuation">,</span>
                      <span class="token function">dict_table_is_comp</span><span class="token punctuation">(</span>index<span class="token operator">-</span><span class="token operator">></span>table<span class="token punctuation">)</span><span class="token punctuation">,</span>
                      <span class="token function">dict_index_get_n_fields</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
                      <span class="token function">dict_table_page_size</span><span class="token punctuation">(</span>index<span class="token operator">-</span><span class="token operator">></span>table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token function">dict_index_get_n_unique_in_tree</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
             i <span class="token operator">&lt;</span> <span class="token function">dtuple_get_n_fields</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            ulint    savings<span class="token punctuation">;</span>

            dfield <span class="token operator">=</span> <span class="token function">dtuple_get_nth_field</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取数据项的第n个字段</span>
            ifield <span class="token operator">=</span> <span class="token function">dict_index_get_nth_field</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取索引的第n个字段</span>

            <span class="token comment" spellcheck="true">/* Skip fixed-length, NULL, externally stored,
            or short columns 
            跳过固定长度列、空列、外部存储列或者长度小于40字节的列*/</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ifield<span class="token operator">-</span><span class="token operator">></span>fixed_len
                <span class="token operator">||</span> <span class="token function">dfield_is_null</span><span class="token punctuation">(</span>dfield<span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token function">dfield_is_ext</span><span class="token punctuation">(</span>dfield<span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token function">dfield_get_len</span><span class="token punctuation">(</span>dfield<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> local_len
                <span class="token operator">||</span> <span class="token function">dfield_get_len</span><span class="token punctuation">(</span>dfield<span class="token punctuation">)</span>
                <span class="token operator">&lt;=</span> BTR_EXTERN_LOCAL_STORED_MAX_SIZE<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> skip_field<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            savings <span class="token operator">=</span> <span class="token function">dfield_get_len</span><span class="token punctuation">(</span>dfield<span class="token punctuation">)</span> <span class="token operator">-</span> local_len<span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/* Check that there would be savings */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>longest <span class="token operator">>=</span> savings<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> skip_field<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/*在是用DYNAMIC和COMPRESSED格式时，任何最大长度小于256字节的非BLOB列都是本地存储；而对于REDUNDANT和COMPACT类型而言，最大不超过788字节时                都会本地存储。 */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DATA_BIG_COL</span><span class="token punctuation">(</span>ifield<span class="token operator">-</span><span class="token operator">></span>col<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> skip_field<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            longest_i <span class="token operator">=</span> i<span class="token punctuation">;</span>
            longest <span class="token operator">=</span> savings<span class="token punctuation">;</span>

skip_field<span class="token operator">:</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//找不到满足要求的最大列，返回NULL</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>longest<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/* Cannot shorten more */</span>
            <span class="token function">mem_heap_free</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* Move data from field longest_i to big rec vector.
    添加longest_i字段到big rec向量中
        We store the first bytes locally to the record. Then
        we can calculate all ordering fields in all indexes
        from locally stored data. */</span>

        dfield <span class="token operator">=</span> <span class="token function">dtuple_get_nth_field</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> longest_i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ifield <span class="token operator">=</span> <span class="token function">dict_index_get_nth_field</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> longest_i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        local_prefix_len <span class="token operator">=</span> local_len <span class="token operator">-</span> BTR_EXTERN_FIELD_REF_SIZE<span class="token punctuation">;</span>

        vector<span class="token operator">-</span><span class="token operator">></span><span class="token function">append</span><span class="token punctuation">(</span>
            <span class="token function">big_rec_field_t</span><span class="token punctuation">(</span>
                longest_i<span class="token punctuation">,</span>
                <span class="token function">dfield_get_len</span><span class="token punctuation">(</span>dfield<span class="token punctuation">)</span> <span class="token operator">-</span> local_prefix_len<span class="token punctuation">,</span>
                <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token function">dfield_get_data</span><span class="token punctuation">(</span>dfield<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> local_prefix_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* Allocate the locally stored part of the column. */</span>
        data <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>byte<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token function">mem_heap_alloc</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> local_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* Copy the local prefix. */</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token function">dfield_get_data</span><span class="token punctuation">(</span>dfield<span class="token punctuation">)</span><span class="token punctuation">,</span> local_prefix_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* Clear the extern field reference (BLOB pointer). */</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>data <span class="token operator">+</span> local_prefix_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BTR_EXTERN_FIELD_REF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//替换原记录上的外部指针，并存储实际数据。</span>
        <span class="token function">dfield_set_data</span><span class="token punctuation">(</span>dfield<span class="token punctuation">,</span> data<span class="token punctuation">,</span> local_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dfield_set_ext</span><span class="token punctuation">(</span>dfield<span class="token punctuation">)</span><span class="token punctuation">;</span>

        n_fields<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>n_ext<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">ut_ad</span><span class="token punctuation">(</span>n_fields <span class="token operator">&lt;</span> <span class="token function">dtuple_get_n_fields</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>       
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    
        <span class="token comment" spellcheck="true">//4、开始进行索引分裂</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dict_index_get_page</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">btr_cur_get_block</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>page<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">page_no</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* The page is the root page
        如果当前记录的cursor在根Page上，则分裂节点，提升BTREE高度，然后再插入记录*/</span>
        <span class="token operator">*</span>rec <span class="token operator">=</span> <span class="token function">btr_root_raise_and_insert</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> cursor<span class="token punctuation">,</span> offsets<span class="token punctuation">,</span> heap<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> n_ext<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//1、首先为B-TREE分配一个新Page，并进行初始化前后page指针</span>
            <span class="token comment" spellcheck="true">//1.1、给B-Tree分配一个新的Page页</span>
            level <span class="token operator">=</span> <span class="token function">btr_page_get_level</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            new_block <span class="token operator">=</span> <span class="token function">btr_page_alloc</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> FSP_NO_DIR<span class="token punctuation">,</span> level<span class="token punctuation">,</span> mtr<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            new_page <span class="token operator">=</span> <span class="token function">buf_block_get_frame</span><span class="token punctuation">(</span>new_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
            new_page_zip <span class="token operator">=</span> <span class="token function">buf_block_get_page_zip</span><span class="token punctuation">(</span>new_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">btr_page_create</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> new_page_zip<span class="token punctuation">,</span> index<span class="token punctuation">,</span> level<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment" spellcheck="true">/* Set the next node and previous node fields of new page 
            1.2、设置new page 页前后节点指针*/</span>
            <span class="token function">btr_page_set_next</span><span class="token punctuation">(</span>new_page<span class="token punctuation">,</span> new_page_zip<span class="token punctuation">,</span> FIL_NULL<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">btr_page_set_prev</span><span class="token punctuation">(</span>new_page<span class="token punctuation">,</span> new_page_zip<span class="token punctuation">,</span> FIL_NULL<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment" spellcheck="true">//2、将root节点的记录一个个拷贝到new_page中    </span>
            <span class="token comment" spellcheck="true">/* Copy the page byte for byte. 
            2.1、一个字节一个字节地拷贝*/</span>
        <span class="token function">page_zip_copy_recs</span><span class="token punctuation">(</span>new_page_zip<span class="token punctuation">,</span> new_page<span class="token punctuation">,</span> root_page_zip<span class="token punctuation">,</span> root<span class="token punctuation">,</span> index<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//2.2、迁移显式锁到new page上</span>
            <span class="token function">lock_move_rec_list_end</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> root_block<span class="token punctuation">,</span> <span class="token function">page_get_infimum_rec</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">lock_prdt_rec_move</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> root_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//2.3、迁移或者删除hash索引</span>
            <span class="token function">btr_search_move_or_delete_hash_entries</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> root_block<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//2.4、将root页上supremum记录上的锁迁移到新block的supremum记录上</span>
            <span class="token function">lock_update_root_raise</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> root_block<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">lock_rec_move</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> root<span class="token punctuation">,</span> PAGE_HEAP_NO_SUPREMUM<span class="token punctuation">,</span> PAGE_HEAP_NO_SUPREMUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            
            <span class="token comment" spellcheck="true">//3、构建节点指针（node_ptr）</span>
            <span class="token comment" spellcheck="true">//3.1、读取新page上的第一个用户记录，根据rec和new_page_no创建节点指针</span>
            rec <span class="token operator">=</span> <span class="token function">page_rec_get_next</span><span class="token punctuation">(</span><span class="token function">page_get_infimum_rec</span><span class="token punctuation">(</span>new_page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           new_page_no <span class="token operator">=</span> new_block<span class="token operator">-</span><span class="token operator">></span>page<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">page_no</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            node_ptr <span class="token operator">=</span> <span class="token function">dict_index_build_node_ptr</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> rec<span class="token punctuation">,</span> new_page_no<span class="token punctuation">,</span> <span class="token operator">*</span>heap<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//3.2、设置node_ptr的flag为REC_INFO_MIN_REC_FLAG，代表这是该层的最小记录</span>
            <span class="token function">dtuple_set_info_bits</span><span class="token punctuation">(</span>node_ptr<span class="token punctuation">,</span> <span class="token function">dtuple_get_info_bits</span><span class="token punctuation">(</span>node_ptr<span class="token punctuation">)</span> <span class="token operator">|</span> REC_INFO_MIN_REC_FLAG<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment" spellcheck="true">//4、清空重置root节点，并将node_ptr写入root节点       </span>
            <span class="token comment" spellcheck="true">/* Rebuild the root page to get free space 
           4.1、 清空root page*/</span>
            <span class="token function">btr_page_empty</span><span class="token punctuation">(</span>root_block<span class="token punctuation">,</span> root_page_zip<span class="token punctuation">,</span> index<span class="token punctuation">,</span> level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//4.2、设置root page前后page为NULL</span>
            <span class="token function">btr_page_set_next</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> root_page_zip<span class="token punctuation">,</span> FIL_NULL<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">btr_page_set_prev</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> root_page_zip<span class="token punctuation">,</span> FIL_NULL<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//4.3、将node_ptr插入到root page</span>
           page_cursor <span class="token operator">=</span> <span class="token function">btr_cur_get_page_cur</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">page_cur_set_before_first</span><span class="token punctuation">(</span>root_block<span class="token punctuation">,</span> page_cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>
           node_ptr_rec <span class="token operator">=</span> <span class="token function">page_cur_tuple_insert</span><span class="token punctuation">(</span>page_cursor<span class="token punctuation">,</span> node_ptr<span class="token punctuation">,</span> index<span class="token punctuation">,</span> offsets<span class="token punctuation">,</span> heap<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment" spellcheck="true">//5、重置page cursor</span>
            <span class="token comment" spellcheck="true">/* Reposition the cursor to the child node */</span>
            <span class="token function">page_cur_search</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> index<span class="token punctuation">,</span> tuple<span class="token punctuation">,</span> page_cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//对new page进行split</span>
            <span class="token function">btr_page_split_and_insert</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> cursor<span class="token punctuation">,</span> offsets<span class="token punctuation">,</span> heap<span class="token punctuation">,</span> tuple<span class="token punctuation">,</span> n_ext<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//如果当前记录cursor不在根节点page上，走一般的索引分裂逻辑</span>
        <span class="token operator">*</span>rec <span class="token operator">=</span> <span class="token function">btr_page_split_and_insert</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> cursor<span class="token punctuation">,</span> offsets<span class="token punctuation">,</span> heap<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> n_ext<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//1、选择分裂中间点的记录</span>
            <span class="token comment" spellcheck="true">//1.1、已经做过一次split，但记录依然无法插入成功，则继续进行分裂</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n_iterations <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> 
                direction <span class="token operator">=</span> FSP_UP<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//#define    FSP_UP        ((byte)111)    </span><span class="token comment" spellcheck="true">/*!&lt; alphabetically upwards */</span>
                hint_page_no <span class="token operator">=</span> page_no <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                split_rec <span class="token operator">=</span> <span class="token function">btr_page_get_split_rec</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> tuple<span class="token punctuation">,</span> n_ext<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>split_rec <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    insert_left <span class="token operator">=</span> <span class="token function">btr_page_tuple_smaller</span><span class="token punctuation">(</span>
                        cursor<span class="token punctuation">,</span> tuple<span class="token punctuation">,</span> offsets<span class="token punctuation">,</span> n_uniq<span class="token punctuation">,</span> heap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//1.2、推荐往右进行分裂</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">btr_page_get_split_rec_to_right</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token operator">&amp;</span>split_rec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                direction <span class="token operator">=</span> FSP_UP<span class="token punctuation">;</span>
                hint_page_no <span class="token operator">=</span> page_no <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//1.3、推荐往左进行分裂    </span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">btr_page_get_split_rec_to_left</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token operator">&amp;</span>split_rec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                direction <span class="token operator">=</span> FSP_DOWN<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//#define    FSP_DOWN    ((byte)112)    </span><span class="token comment" spellcheck="true">/*!&lt; alphabetically downwards */</span>
                hint_page_no <span class="token operator">=</span> page_no <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//1.4、以上都不满足</span>
                direction <span class="token operator">=</span> FSP_UP<span class="token punctuation">;</span>
                hint_page_no <span class="token operator">=</span> page_no <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">/* If there is only one record in the index page, we
                can't split the node in the middle by default. We need
                to determine whether the new record will be inserted
                to the left or right. */</span>
                <span class="token comment" spellcheck="true">//1.4.1、如果page上记录不止一个，则从中间开始分裂</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_get_n_recs</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    split_rec <span class="token operator">=</span> <span class="token function">page_get_middle_rec</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//1.4.2、如果当前插入记录比page上记录要小，则插到最左边</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">btr_page_tuple_smaller</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> tuple<span class="token punctuation">,</span>
                                  offsets<span class="token punctuation">,</span> n_uniq<span class="token punctuation">,</span> heap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    split_rec <span class="token operator">=</span> <span class="token function">page_rec_get_next</span><span class="token punctuation">(</span>
                        <span class="token function">page_get_infimum_rec</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    split_rec <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            
            
           <span class="token comment" spellcheck="true">//2、给索引分配一个new page </span>
            new_block <span class="token operator">=</span> <span class="token function">btr_page_alloc</span><span class="token punctuation">(</span>cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span> hint_page_no<span class="token punctuation">,</span> direction<span class="token punctuation">,</span>
                   <span class="token function">btr_page_get_level</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">,</span> mtr<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            new_page <span class="token operator">=</span> <span class="token function">buf_block_get_frame</span><span class="token punctuation">(</span>new_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
            new_page_zip <span class="token operator">=</span> <span class="token function">buf_block_get_page_zip</span><span class="token punctuation">(</span>new_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">btr_page_create</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> new_page_zip<span class="token punctuation">,</span> cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span>
                    <span class="token function">btr_page_get_level</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            
            <span class="token comment" spellcheck="true">//3、计算上半部分的page的第一个记录，以及在原始page上的第一个记录</span>
            <span class="token comment" spellcheck="true">//3.1、如果split_rec不为空</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>split_rec<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            first_rec <span class="token operator">=</span> move_limit <span class="token operator">=</span> split_rec<span class="token punctuation">;</span>
            <span class="token operator">*</span>offsets <span class="token operator">=</span> <span class="token function">rec_get_offsets</span><span class="token punctuation">(</span>split_rec<span class="token punctuation">,</span> cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span> <span class="token operator">*</span>offsets<span class="token punctuation">,</span> n_uniq<span class="token punctuation">,</span> heap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            insert_left <span class="token operator">=</span> <span class="token function">cmp_dtuple_rec</span><span class="token punctuation">(</span>tuple<span class="token punctuation">,</span> split_rec<span class="token punctuation">,</span> <span class="token operator">*</span>offsets<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//表示当前记录是插入到split_rec的左边还是右边</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>insert_left <span class="token operator">&amp;&amp;</span> new_page_zip <span class="token operator">&amp;&amp;</span> n_iterations <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">/* If a compressed page has already been split,
                    avoid further splits by inserting the record
                    to an empty page. */</span>
                    split_rec <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> insert_empty<span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//3.2、insert_left为TRUE</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>insert_left<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  
                <span class="token function">ut_a</span><span class="token punctuation">(</span>n_iterations <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//只有在n_iterations>0时才会发生</span>
                first_rec <span class="token operator">=</span> <span class="token function">page_rec_get_next</span><span class="token punctuation">(</span><span class="token function">page_get_infimum_rec</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                move_limit <span class="token operator">=</span> <span class="token function">page_rec_get_next</span><span class="token punctuation">(</span><span class="token function">btr_cur_get_rec</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//以上都不满足（split_rec为空）</span>
                insert_empty<span class="token operator">:</span>
                buf <span class="token operator">=</span> <span class="token function">UT_NEW_ARRAY_NOKEY</span><span class="token punctuation">(</span>byte<span class="token punctuation">,</span> <span class="token function">rec_get_converted_size</span><span class="token punctuation">(</span>cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span> tuple<span class="token punctuation">,</span> n_ext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                first_rec <span class="token operator">=</span> <span class="token function">rec_convert_dtuple_to_rec</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span> tuple<span class="token punctuation">,</span> n_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//当前插入的记录</span>
                move_limit <span class="token operator">=</span> <span class="token function">page_rec_get_next</span><span class="token punctuation">(</span><span class="token function">btr_cur_get_rec</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//当前插入的记录下一条</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            
            <span class="token comment" spellcheck="true">//4、修改B树结构</span>
            <span class="token comment" spellcheck="true">//4.1、将新page attach到b-tree上对应的层次上，并向上层节点插入node指针，更新当前层次的节点链表指针</span>
            <span class="token function">btr_attach_half_pages</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span> block<span class="token punctuation">,</span> first_rec<span class="token punctuation">,</span> new_block<span class="token punctuation">,</span> direction<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//4.2、判断新记录是否能够满足插入</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>split_rec<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//对于压缩表，new_page_zip为true，因此insert_will_fit总为false</span>
                insert_will_fit <span class="token operator">=</span> <span class="token operator">!</span>new_page_zip
                    <span class="token operator">&amp;&amp;</span> <span class="token function">btr_page_insert_fits</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> split_rec<span class="token punctuation">,</span>
                                offsets<span class="token punctuation">,</span> tuple<span class="token punctuation">,</span> n_ext<span class="token punctuation">,</span> heap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//split_rec为空，表示分裂记录就是当前插入记录</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>insert_left<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">UT_DELETE_ARRAY</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    buf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
               <span class="token comment" spellcheck="true">//同样的insert_will_fit对于压缩表而言，总是为FALSE。这意味着在索引分裂的过程中，会一直持有索引上的排他锁，这会导致压缩表分裂的开销非常大</span>
                insert_will_fit <span class="token operator">=</span> <span class="token operator">!</span>new_page_zip
                    <span class="token operator">&amp;&amp;</span> <span class="token function">btr_page_insert_fits</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                                offsets<span class="token punctuation">,</span> tuple<span class="token punctuation">,</span> n_ext<span class="token punctuation">,</span> heap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//4.3、判断是否释放索引上的排他锁（x lock）</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>srv_read_only_mode
            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">dict_table_is_intrinsic</span><span class="token punctuation">(</span>cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token operator">-</span><span class="token operator">></span>table<span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> insert_will_fit
            <span class="token operator">&amp;&amp;</span> <span class="token function">page_is_leaf</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">dict_index_is_online_ddl</span><span class="token punctuation">(</span>cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                mtr<span class="token operator">-</span><span class="token operator">></span><span class="token function">memo_release</span><span class="token punctuation">(</span><span class="token function">dict_index_get_lock</span><span class="token punctuation">(</span>cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> MTR_MEMO_X_LOCK <span class="token operator">|</span> MTR_MEMO_SX_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            
             <span class="token comment" spellcheck="true">//5、迁移记录到new page上</span>
            <span class="token comment" spellcheck="true">//5.1、迁移记录到new block上</span>
            <span class="token function">page_move_rec_list_end</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> block<span class="token punctuation">,</span> move_limit<span class="token punctuation">,</span> cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//将block上从move_limit(包含该记录)开始拷贝到new_block中。</span>
                <span class="token function">page_copy_rec_list_end</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> block<span class="token punctuation">,</span> split_rec<span class="token punctuation">,</span> index<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//删除转移的记录</span>
                <span class="token function">page_delete_rec_list_end</span><span class="token punctuation">(</span>split_rec<span class="token punctuation">,</span> block<span class="token punctuation">,</span> index<span class="token punctuation">,</span> new_n_recs <span class="token operator">-</span> old_n_recs<span class="token punctuation">,</span> new_data_size <span class="token operator">-</span> old_data_size<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//5.2、将原page中的记录按字节拷到new page中</span>
            <span class="token function">page_zip_copy_recs</span><span class="token punctuation">(</span>new_page_zip<span class="token punctuation">,</span> new_page<span class="token punctuation">,</span> page_zip<span class="token punctuation">,</span> page<span class="token punctuation">,</span> cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//5.3、从新page上删除从move_limit开始的记录，不包括move_limit记录本身以及Infimum和Supremum Records</span>
            <span class="token function">page_delete_rec_list_start</span><span class="token punctuation">(</span>move_limit <span class="token operator">-</span> page <span class="token operator">+</span> new_page<span class="token punctuation">,</span> new_block<span class="token punctuation">,</span> cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//5.4、更新锁表和AHI</span>
            <span class="token function">lock_move_rec_list_end</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> block<span class="token punctuation">,</span> move_limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">btr_search_move_or_delete_hash_entries</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> block<span class="token punctuation">,</span> cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//5.5、从源表上删除从move_limit（包括move_limit）开始的记录</span>
            <span class="token function">page_delete_rec_list_end</span><span class="token punctuation">(</span>move_limit<span class="token punctuation">,</span> block<span class="token punctuation">,</span> cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span> ULINT_UNDEFINED<span class="token punctuation">,</span> ULINT_UNDEFINED<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//5.6、更新记录锁</span>
             left_block <span class="token operator">=</span> block<span class="token punctuation">;</span>
            right_block <span class="token operator">=</span> new_block<span class="token punctuation">;</span>
            <span class="token function">lock_update_split_right</span><span class="token punctuation">(</span>right_block<span class="token punctuation">,</span> left_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment" spellcheck="true">//6、到了这一步，索引树的分裂和修改已经结束了，这时根据insert_left来选择把记录插入到哪个block中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>insert_left<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
               insert_block <span class="token operator">=</span> left_block<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                insert_block <span class="token operator">=</span> right_block<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            
            <span class="token comment" spellcheck="true">//7、开始尝试插入</span>
            page_cursor <span class="token operator">=</span> <span class="token function">btr_cur_get_page_cur</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">page_cur_search</span><span class="token punctuation">(</span>insert_block<span class="token punctuation">,</span> cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span> tuple<span class="token punctuation">,</span> page_cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rec <span class="token operator">=</span> <span class="token function">page_cur_tuple_insert</span><span class="token punctuation">(</span>page_cursor<span class="token punctuation">,</span> tuple<span class="token punctuation">,</span> cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span>
                    offsets<span class="token punctuation">,</span> heap<span class="token punctuation">,</span> n_ext<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment" spellcheck="true">//8、如果插入失败，则重新reorgnize page，n_iterations++;然后从头开始继续分裂</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_cur_get_page_zip</span><span class="token punctuation">(</span>page_cursor<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">btr_page_reorganize</span><span class="token punctuation">(</span>page_cursor<span class="token punctuation">,</span> cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> insert_failed<span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            insert_failed<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">/* We play safe and reset the free bits for new_page */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dict_index_is_clust</span><span class="token punctuation">(</span>cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">dict_table_is_temporary</span><span class="token punctuation">(</span>cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token operator">-</span><span class="token operator">></span>table<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">ibuf_reset_free_bits</span><span class="token punctuation">(</span>new_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">ibuf_reset_free_bits</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                n_iterations<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token function">ut_ad</span><span class="token punctuation">(</span>n_iterations <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">||</span> <span class="token function">buf_block_get_page_zip</span><span class="token punctuation">(</span>insert_block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">ut_ad</span><span class="token punctuation">(</span><span class="token operator">!</span>insert_will_fit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> func_start<span class="token punctuation">;</span>
            
            <span class="token comment" spellcheck="true">//9、对于辅助索引，更新insert buffer</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dict_index_is_clust</span><span class="token punctuation">(</span>cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">dict_table_is_temporary</span><span class="token punctuation">(</span>cursor<span class="token operator">-</span><span class="token operator">></span>index<span class="token operator">-</span><span class="token operator">></span>table<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">page_is_leaf</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">ibuf_update_free_bits_for_two_pages_low</span><span class="token punctuation">(</span>left_block<span class="token punctuation">,</span> right_block<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    
    
    <span class="token comment" spellcheck="true">//5、更新AHI</span>
    <span class="token function">btr_search_update_hash_on_insert</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//6、更新记录锁信息</span>
    <span class="token function">lock_update_insert</span><span class="token punctuation">(</span><span class="token function">btr_cur_get_block</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>rec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment" spellcheck="true">//7、如果之前分配了extend,则更新space->n_reserved_extents计数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n_reserved <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">fil_space_release_free_extents</span><span class="token punctuation">(</span>index<span class="token operator">-</span><span class="token operator">></span>space<span class="token punctuation">,</span> n_reserved<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            space <span class="token operator">=</span> <span class="token function">fil_space_get_by_id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            space<span class="token operator">-</span><span class="token operator">></span>n_reserved_extents <span class="token operator">-</span><span class="token operator">=</span> n_reserved<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于往右进行分裂，在<code>btr_page_get_split_rec_to_right</code>中进行了实现，源码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/*************************************************************/</span><span class="token comment" spellcheck="true">/**
决定是否向右分裂
@return TRUE if split recommended */</span>
ibool
<span class="token function">btr_page_get_split_rec_to_right</span><span class="token punctuation">(</span>
<span class="token comment" spellcheck="true">/*============================*/</span>
    btr_cur_t<span class="token operator">*</span>    cursor<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: cursor at which to insert */</span>
    rec_t<span class="token operator">*</span><span class="token operator">*</span>        split_rec<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/*!&lt; out: if split recommended,
                the first record on upper half page,
                or NULL if tuple to be inserted should
                be first */</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    page_t<span class="token operator">*</span>    page<span class="token punctuation">;</span>
    rec_t<span class="token operator">*</span>    insert_point<span class="token punctuation">;</span>

    page <span class="token operator">=</span> <span class="token function">btr_cur_get_page</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    insert_point <span class="token operator">=</span> <span class="token function">btr_cur_get_rec</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//判断是否是向右顺序插入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_header_get_ptr</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> PAGE_LAST_INSERT<span class="token punctuation">)</span> <span class="token operator">==</span> insert_point<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        rec_t<span class="token operator">*</span>    next_rec<span class="token punctuation">;</span>
        next_rec <span class="token operator">=</span> <span class="token function">page_rec_get_next</span><span class="token punctuation">(</span>insert_point<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//insert_point后面不足两条用户记录（if和else），则将split_rec赋值为NULL，即为insert_point</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_rec_is_supremum</span><span class="token punctuation">(</span>next_rec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
split_at_new<span class="token operator">:</span>
            <span class="token comment" spellcheck="true">/* Split at the new record to insert */</span>
            <span class="token operator">*</span>split_rec <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            rec_t<span class="token operator">*</span>    next_next_rec <span class="token operator">=</span> <span class="token function">page_rec_get_next</span><span class="token punctuation">(</span>next_rec<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_rec_is_supremum</span><span class="token punctuation">(</span>next_next_rec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> split_at_new<span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/* 否则（insert_point后面不少于两条记录），则将其赋值为insert_point后的第二条记录，*/</span>
            <span class="token operator">*</span>split_rec <span class="token operator">=</span> next_next_rec<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span><span class="token punctuation">(</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于<code>insert_point</code>后面有不少于<code>2</code>条用户记录，<code>split_rec</code>赋值为第二条记录</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210309153130890.png" alt="image-20210309153130890"></p>
<p>对于不足<code>2</code>条记录的，赋值<code>split_rec</code>为<code>NULL</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210309155001462.png" alt="image-20210309155001462"></p>
<p>往左进行分裂，则在<code>btr_page_get_split_rec_to_left</code>中进行了实现，源码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/*************************************************************/</span><span class="token comment" spellcheck="true">/**
决定是否向左分裂
@return TRUE if split recommended */</span>
ibool
<span class="token function">btr_page_get_split_rec_to_left</span><span class="token punctuation">(</span>
<span class="token comment" spellcheck="true">/*===========================*/</span>
    btr_cur_t<span class="token operator">*</span>    cursor<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*!&lt; in: cursor at which to insert */</span>
    rec_t<span class="token operator">*</span><span class="token operator">*</span>        split_rec<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/*!&lt; out: if split recommended,
                the first record on upper half page,
                or NULL if tuple to be inserted should
                be first */</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    page_t<span class="token operator">*</span>    page<span class="token punctuation">;</span>
    rec_t<span class="token operator">*</span>    insert_point<span class="token punctuation">;</span>
    rec_t<span class="token operator">*</span>    infimum<span class="token punctuation">;</span>

    page <span class="token operator">=</span> <span class="token function">btr_cur_get_page</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    insert_point <span class="token operator">=</span> <span class="token function">btr_cur_get_rec</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//判断是否是向左顺序插入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_header_get_ptr</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> PAGE_LAST_INSERT<span class="token punctuation">)</span>
        <span class="token operator">==</span> <span class="token function">page_rec_get_next</span><span class="token punctuation">(</span>insert_point<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        infimum <span class="token operator">=</span> <span class="token function">page_get_infimum_rec</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//insert_point不为Infimum并且不为第一个用户记录，将split_rec赋值为insert_point</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>infimum <span class="token operator">!=</span> insert_point
            <span class="token operator">&amp;&amp;</span> <span class="token function">page_rec_get_next</span><span class="token punctuation">(</span>infimum<span class="token punctuation">)</span> <span class="token operator">!=</span> insert_point<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>split_rec <span class="token operator">=</span> insert_point<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//insert_point为Infimum或者第一个用户记录，将则split_rec赋值为insert_point下一个记录</span>
            <span class="token operator">*</span>split_rec <span class="token operator">=</span> <span class="token function">page_rec_get_next</span><span class="token punctuation">(</span>insert_point<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span><span class="token punctuation">(</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于<code>if</code>的情况，如下图</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210309160330729.png" alt="image-20210309160330729"></p>
<p>对于<code>else</code>的情况，如下图</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210309160443960.png" alt="image-20210309160443960"></p>
<h1 id="2、构造分裂场景"><a href="#2、构造分裂场景" class="headerlink" title="2、构造分裂场景"></a>2、构造分裂场景</h1><p>首先创建如下<code>test_split</code>表</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>test_split<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>test_split<span class="token punctuation">`</span>  <span class="token punctuation">(</span>
  <span class="token punctuation">`</span><span class="token number">a</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token number">b</span><span class="token punctuation">`</span> <span class="token keyword">blob</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token number">c</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">a</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">INDEX</span> <span class="token punctuation">`</span>idx_c<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">c</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">CHARACTER SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意到每个<code>page</code>大小默认为<code>16KB</code>，我们构造每条<code>record</code>记录大小大约在<code>5K</code>，可以推算出在插入第<code>4</code>条记录时，会发生分裂</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210310102331937.png" alt="image-20210310102331937"></p>
<p>对于前<code>3</code>次插入，在<code>vs</code>里跟踪源码可以发现都是走乐观插入(<code>btr_cur_optimistic_insert</code>)，并且都成功了，即没有发生索引分裂</p>
<p>对于第<code>4</code>次插入，在<code>vs</code>里跟踪源码，也能发现首先尝试乐观插入，失败之后进行悲观插入(<code>btr_cur_pessimistic_insert</code>)，会发生索引分裂</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210310103704919.png" alt="image-20210310103704919"></p>
<p>让程序在<code>btr_cur_pessimistic_insert</code>里继续往下运行，直到走到上述第<code>4</code>步进行索引分裂的地方</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210310104143763.png" alt="image-20210310104143763"></p>
<p>因为当前表只有一个<code>root page</code>，即当前记录的<code>cursor</code>在<code>root page</code>上，则会先走<code>btr_root_raise_and_insert</code>方法，分裂节点，然后再插入记录，我们进入<code>btr_root_raise_and_insert</code>方法去看一下，会发现最后调用了<code>btr_page_split_and_insert</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210310105256861.png" alt="image-20210310105256861"></p>
<p>然后在<code>btr_page_split_and_insert</code>里进行分裂和插入，走完上述<code>9</code>步流程</p>

            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《20210310》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2021/04/08/20210310/" property="cc:attributionName"
               rel="cc:attributionURL">
                JavaGuy
            </a> 采用
            <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: 'GgssQFlBBeYrJoL1y5s8jXeR-gzGzoHsz',
        appKey: 'kXYkbr7xencqP3PxqQNKykdt',
        notify: 'true' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/04/08/20210317/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="20210317">
                        
                        <span class="card-title">20210317</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            任务
具体看B+树分裂这一个事务过程中，内部事务mtr是如何组成的，redo日志和undo日志是如何写的。

源码调试分析注意到MySQL5.7默认是没有开启binlog，也就不支持内部XA，进而看不到两阶段提交，所以我们先开启binlog
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-04-08
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Lab/" class="post-category" target="_blank">
                                    Lab
                                </a>
                            
                            <a href="/categories/Lab/%E5%91%A8%E4%BC%9A%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" class="post-category" target="_blank">
                                    周会总结报告
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/B-%E6%A0%91/" target="_blank">
                        <span class="chip bg-color">B+树</span>
                    </a>
                    
                    <a href="/tags/%E7%B4%A2%E5%BC%95%E5%88%86%E8%A3%82/" target="_blank">
                        <span class="chip bg-color">索引分裂</span>
                    </a>
                    
                    <a href="/tags/binlog/" target="_blank">
                        <span class="chip bg-color">binlog</span>
                    </a>
                    
                    <a href="/tags/mtr/" target="_blank">
                        <span class="chip bg-color">mtr</span>
                    </a>
                    
                    <a href="/tags/redo/" target="_blank">
                        <span class="chip bg-color">redo</span>
                    </a>
                    
                    <a href="/tags/undo/" target="_blank">
                        <span class="chip bg-color">undo</span>
                    </a>
                    
                    <a href="/tags/lsn/" target="_blank">
                        <span class="chip bg-color">lsn</span>
                    </a>
                    
                    <a href="/tags/XA%E4%BA%8B%E5%8A%A1/" target="_blank">
                        <span class="chip bg-color">XA事务</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/04/08/20210408/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="20210408">
                        
                        <span class="card-title">20210408</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            本周工作总结一、概述1、搭建多SE自动测试环境2、进一步学习Quorum+Gossip相关代码二、具体内容1、搭建多SE自动测试环境



2、Quorum+Gossip源码进一步学习2.1、线程梳理2.1.1、CEthread-1 mai
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-04-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Lab/" class="post-category" target="_blank">
                                    Lab
                                </a>
                            
                            <a href="/categories/Lab/%E5%91%A8%E4%BC%9A%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" class="post-category" target="_blank">
                                    周会总结报告
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MSE/" target="_blank">
                        <span class="chip bg-color">MSE</span>
                    </a>
                    
                    <a href="/tags/Quorum/" target="_blank">
                        <span class="chip bg-color">Quorum</span>
                    </a>
                    
                    <a href="/tags/Gossip/" target="_blank">
                        <span class="chip bg-color">Gossip</span>
                    </a>
                    
                    <a href="/tags/Socket/" target="_blank">
                        <span class="chip bg-color">Socket</span>
                    </a>
                    
                    <a href="/tags/%E8%87%AA%E5%8A%A8%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83/" target="_blank">
                        <span class="chip bg-color">自动测试环境</span>
                    </a>
                    
                    <a href="/tags/Shell/" target="_blank">
                        <span class="chip bg-color">Shell</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: JavaGuy的博客<br />'
            + '作者: JavaGuy<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

<!-- <script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'artDetail',
        blogId: '20962-1585405055583-879',
        name: '算法码上来',
        qrcode: 'https://godweiyang.com/medias/gzh.jpg',
        keyword: 'VIP',
    });
</script> -->

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5, h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5, h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; ZhangQu. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">285.6k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zhangqu999" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:zhang1842279380@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>





    <a href="http://wpa.qq.com/msgrd?v=3&uin=1842279380&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 1000;
        var uvcountOffset = 200;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 03, 18, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    
    <script type="text/javascript" src="/libs/others/snow.js"></script>
    

</body>

</html>