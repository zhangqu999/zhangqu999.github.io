<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="20210324, SpringBoot Java MySQL MA JavaGuy Math 算法">
    <meta name="baidu-site-verification" content="code-r7CYm21B6o" />
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48" />
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7" />
    <meta name="description" content="任务合力学习多SE版本，包括：

多SE版的安装、分布式部署、测试
Quorum+Gossip原理解读
多SE设计文档学习和源码解读

1、搭建多SE环境和简单测试1.1、CLion编译build代码1.1.1、cmake参数配置在file">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>20210324 | JavaGuy的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ce84511d3df71640a9378a69f6293044";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="JavaGuy的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JavaGuy的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">JavaGuy的博客</div>
        <div class="logo-desc">
            
            华中科技大学 | 计算机科学与技术 | 分布式云数据库内核
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '91a6f824b85ba9ed6e7cf599364e2f8bc897a465357160c6425c8eacd8883377';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/4.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        20210324
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/MSE/" target="_blank">
                            <span class="chip bg-color">MSE</span>
                        </a>
                        
                        <a href="/tags/Quorum/" target="_blank">
                            <span class="chip bg-color">Quorum</span>
                        </a>
                        
                        <a href="/tags/Gossip/" target="_blank">
                            <span class="chip bg-color">Gossip</span>
                        </a>
                        
                        <a href="/tags/Aurora/" target="_blank">
                            <span class="chip bg-color">Aurora</span>
                        </a>
                        
                        <a href="/tags/CAP/" target="_blank">
                            <span class="chip bg-color">CAP</span>
                        </a>
                        
                        <a href="/tags/ACID/" target="_blank">
                            <span class="chip bg-color">ACID</span>
                        </a>
                        
                        <a href="/tags/BASE/" target="_blank">
                            <span class="chip bg-color">BASE</span>
                        </a>
                        
                        <a href="/tags/NWR/" target="_blank">
                            <span class="chip bg-color">NWR</span>
                        </a>
                        
                        <a href="/tags/%E6%97%A5%E5%BF%97%E5%8D%B3%E6%95%B0%E6%8D%AE%E5%BA%93/" target="_blank">
                            <span class="chip bg-color">日志即数据库</span>
                        </a>
                        
                        <a href="/tags/%E9%80%9A%E4%BF%A1/" target="_blank">
                            <span class="chip bg-color">通信</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/Lab/" class="post-category" target="_blank">
                            Lab
                        </a>
                        
                        <a href="/categories/Lab/%E5%91%A8%E4%BC%9A%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" class="post-category" target="_blank">
                            周会总结报告
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-04-08
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    JavaGuy
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    23 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h1><p>合力学习多SE版本，包括：</p>
<ul>
<li>多SE版的安装、分布式部署、测试</li>
<li>Quorum+Gossip原理解读</li>
<li>多SE设计文档学习和源码解读</li>
</ul>
<h1 id="1、搭建多SE环境和简单测试"><a href="#1、搭建多SE环境和简单测试" class="headerlink" title="1、搭建多SE环境和简单测试"></a>1、搭建多SE环境和简单测试</h1><h2 id="1-1、CLion编译build代码"><a href="#1-1、CLion编译build代码" class="headerlink" title="1.1、CLion编译build代码"></a>1.1、CLion编译build代码</h2><h3 id="1-1-1、cmake参数配置"><a href="#1-1-1、cmake参数配置" class="headerlink" title="1.1.1、cmake参数配置"></a>1.1.1、cmake参数配置</h3><p>在<code>file -&gt; settings -&gt; Build,Execution,Deployment -&gt; cmake</code>目录下，配置如下 <code>cmake options</code></p>
<pre class="line-numbers language-shell"><code class="language-shell">-DDOWNLOAD_BOOST=1 -DWITH_BOOST=/home/zhangqu/source-code/MA_CSE/boost/boost_1_59_0
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323110039534.png" alt="image-20210323110039534"></p>
<h3 id="1-1-2、build"><a href="#1-1-2、build" class="headerlink" title="1.1.2、build"></a>1.1.2、build</h3><p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323111427814.png" alt="image-20210323111427814"></p>
<h2 id="1-2、启动"><a href="#1-2、启动" class="headerlink" title="1.2、启动"></a>1.2、启动</h2><h3 id="1-2-1、修改json配置文件"><a href="#1-2-1、修改json配置文件" class="headerlink" title="1.2.1、修改json配置文件"></a>1.2.1、修改json配置文件</h3><p>修改<code>/home/zhangqu/source-code/MA_CSE/ma_se</code>下的<code>ma_se_config.json</code>文件如下（三台机器的<code>current_id</code>分别是0,1,2）：</p>
<pre class="line-numbers language-json"><code class="language-json">&amp;#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token property">"qg_protocol"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token property">"quorum_protocol"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token property">"node_num"</span><span class="token operator">:</span> <span class="token number">3</span>   
    &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>
    <span class="token property">"gossip_protocol"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token property">"node_num"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token property">"current_id"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"push"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"pull"</span><span class="token operator">:</span> <span class="token number">1</span>
    &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>
    <span class="token property">"node0"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"192.168.100.128"</span><span class="token punctuation">,</span>
      <span class="token property">"quorum_port"</span><span class="token operator">:</span> <span class="token number">33306</span><span class="token punctuation">,</span>
      <span class="token property">"gossip_port"</span><span class="token operator">:</span> <span class="token number">33307</span>
    &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>
    <span class="token property">"node1"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"192.168.100.133"</span><span class="token punctuation">,</span>
      <span class="token property">"quorum_port"</span><span class="token operator">:</span> <span class="token number">33306</span><span class="token punctuation">,</span>
      <span class="token property">"gossip_port"</span><span class="token operator">:</span> <span class="token number">33307</span>
    &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>
    <span class="token property">"node2"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"192.168.100.134"</span><span class="token punctuation">,</span>
      <span class="token property">"quorum_port"</span><span class="token operator">:</span> <span class="token number">33306</span><span class="token punctuation">,</span>
      <span class="token property">"gossip_port"</span><span class="token operator">:</span> <span class="token number">33307</span>
    &amp;#<span class="token number">125</span><span class="token punctuation">;</span>
  &amp;#<span class="token number">125</span><span class="token punctuation">;</span>
&amp;#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-2-2、设置启动参数"><a href="#1-2-2、设置启动参数" class="headerlink" title="1.2.2、设置启动参数"></a>1.2.2、设置启动参数</h3><p>三台机器的<code>SE</code>的启动参数如下：</p>
<pre class="line-numbers language-shell"><code class="language-shell">--datadir=/home/zhangqu/source-code/basedir/data
--sehost=192.168.100.128
--seuser=root
--sepassword=root
--se=on
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>CE</code>的启动参数如下：</p>
<pre class="line-numbers language-shell"><code class="language-shell">--datadir=/home/zhangqu/source-code/basedir/data
--sehost=192.168.100.128
--seuser=root
--sepassword=root
--ce=on
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-2-3、按序部署启动"><a href="#1-2-3、按序部署启动" class="headerlink" title="1.2.3、按序部署启动"></a>1.2.3、按序部署启动</h3><p>按 <strong>主SE-&gt;两台从SE-&gt;主CE</strong> 的顺序依次启动</p>
<p>成功启动三个<code>SE</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323113211963.png" alt="image-20210323113211963"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323113314719.png" alt="image-20210323113314719"></p>
<p>再启动<code>主CE</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323113747490.png" alt="image-20210323113747490"></p>
<p><code>CE</code>启动成功之后，<code>SE</code>会在控制台一直打印下面一段日志</p>
<pre class="line-numbers language-shell"><code class="language-shell">hot log read from_file buffer lsn is consistency with hot log lsn
check lost segment : occur completed repeat block
check log segment : ---hot log list information: 
------------------------------------------------------------------
number         start lsn           end lsn               state             
------------------------------------------------------------------
0              0                   0xad37e75             None              
0x1            0x1039d675          0xffffffffffffffff    None          
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="1-3、客户端简单测试"><a href="#1-3、客户端简单测试" class="headerlink" title="1.3、客户端简单测试"></a>1.3、客户端简单测试</h2><h3 id="1-3-1、添加一条数据"><a href="#1-3-1、添加一条数据" class="headerlink" title="1.3.1、添加一条数据"></a>1.3.1、添加一条数据</h3><p>首先看下<code>sbtest1</code>的表结构</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">desc</span> sbtest1<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323115319688.png" alt="image-20210323115319688"></p>
<p>然后再插入一条数据，并查询进行验证</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> sbtest1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">,</span><span class="token number">43782</span><span class="token punctuation">,</span><span class="token string">'64837264-324792379'</span><span class="token punctuation">,</span><span class="token string">'4368746328732784'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sbtest1 <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">10001</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323115417304.png" alt="image-20210323115417304"></p>
<h3 id="1-3-2、修改数据"><a href="#1-3-2、修改数据" class="headerlink" title="1.3.2、修改数据"></a>1.3.2、修改数据</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">update</span> sbtest1 <span class="token keyword">set</span> k <span class="token operator">=</span> <span class="token number">20000</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">10001</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sbtest1 <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">10001</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323115652569.png" alt="image-20210323115652569"></p>
<h3 id="1-3-3、删除数据"><a href="#1-3-3、删除数据" class="headerlink" title="1.3.3、删除数据"></a>1.3.3、删除数据</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">delete</span> <span class="token keyword">from</span> sbtest1 <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">10001</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sbtest1 <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">10001</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323115828040.png" alt="image-20210323115828040"></p>
<h1 id="2、Quorum-Gossip原理解读"><a href="#2、Quorum-Gossip原理解读" class="headerlink" title="2、Quorum+Gossip原理解读"></a>2、Quorum+Gossip原理解读</h1><h2 id="2-1、Aurora-Quorum-Gossip协议应用概述"><a href="#2-1、Aurora-Quorum-Gossip协议应用概述" class="headerlink" title="2.1、Aurora Quorum+Gossip协议应用概述"></a>2.1、Aurora Quorum+Gossip协议应用概述</h2><h3 id="2-1-1、复制和容错处理"><a href="#2-1-1、复制和容错处理" class="headerlink" title="2.1.1、复制和容错处理"></a>2.1.1、复制和容错处理</h3><p><code>Aurora</code>存储层的复制基于<code>Quorum</code>协议，假设复制拓扑中有<code>V</code>个节点，每个节点有一个投票权，读 或 写 必须拿到<code>Vr</code> 或 <code>Vw</code>个投票才能返回。为了满足一致性，需要满足两个条件：</p>
<ul>
<li><code>Vr + Vw &gt; V</code></li>
<li><code>Vw &gt; V/2</code></li>
</ul>
<p><code>Aurora</code>的数据库实例部署在3个不同AZ(<code>AvailablityZone</code>)，每个<code>AZ</code>包含了2个副本，总共6个副本。结合<code>Quorum</code>模型以及前面提到的两条规则， <code>V=6，Vw=4，Vr=3</code>，<code>Aurora</code>可以容忍任何一个<code>AZ</code>出现故障，不会影响写服务；任何一个<code>AZ</code>出现故障，以及另外一个<code>AZ</code>中的一个节点出现故障，不会影响读服务且不会丢失数据。</p>
<h3 id="2-1-2、日志处理下推到存储层"><a href="#2-1-2、日志处理下推到存储层" class="headerlink" title="2.1.2、日志处理下推到存储层"></a>2.1.2、日志处理下推到存储层</h3><p> <code>Aurora</code>由跨<code>AZ</code>的一个主实例和多个副本实例组成，主实例与副本实例或者存储节点间只传递<strong>redo日志和元信息</strong>。主实例并发向6个存储节点和副本实例发送日志。由<code>Quorum</code>协议，当<strong>4/6</strong>的存储节点应答后，则认为日志已经持久化，对于副本实例，则不依赖其应答时间点。</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323152633194.png" alt="image-20210323152633194"></p>
<h3 id="2-1-3、Aurora存储服务设计要点"><a href="#2-1-3、Aurora存储服务设计要点" class="headerlink" title="2.1.3、Aurora存储服务设计要点"></a>2.1.3、Aurora存储服务设计要点</h3><p>一个关键原则是<strong>减少前台用户写的响应时间</strong>，因此将尽可能多的操作移到<strong>后台异步执行</strong>，并且存储节点会根据前台的请求压力，<strong>自适应</strong>分配资源做不同的工作。</p>
<p> 对于<code>Aurora</code>而言，分离的存储服务层使得后台线程推进检查点动作完全不影响数据库实例，并且是推进地越快，越有利于前台的磁盘<code>IO</code>读操作(减少了回放日志过程)。</p>
<p><code>Aurora</code>写基于<code>Quorum</code>模型，存储分片后，按片达成多数派即可返回，由于分布足够离散，少数的磁盘<code>IO</code>压力大也不会影响到整体的写性能。</p>
<p>下图详细介绍了<code>Aurora</code>写的流程：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323153939337.png" alt="image-20210323153939337"></p>
<h3 id="2-1-4、Write和Read"><a href="#2-1-4、Write和Read" class="headerlink" title="2.1.4、Write和Read"></a>2.1.4、Write和Read</h3><h4 id="2-1-4-1、Write"><a href="#2-1-4-1、Write" class="headerlink" title="2.1.4.1、Write"></a>2.1.4.1、Write</h4><p>在<code>Aurora</code>中，数据库实例向存储节点传递<code>redo</code>日志，达成多数派后将事务标记为提交状态，然后推进<code>VDL</code>（<code>Volumn Durable LSN</code>，已持久化的最大LSN），使数据库进入一个新的一致状态。 </p>
<p>为了确保各个分片日志的完整性，每条日志都记录前一条日志的链接，通过前向链接确保分片拥有了完整的日志。<code>SCL</code>(<code>Segment Complete LSN</code>)表示分片拥有完整日志的位点，存储节点相互间通过<code>gossip</code>协议来弥补本地日志空洞，推进<code>SCL</code> 。</p>
<h4 id="2-1-4-2、Read"><a href="#2-1-4-2、Read" class="headerlink" title="2.1.4.2、Read"></a>2.1.4.2、Read</h4><p>在正常情况下，进行读操作时并不需要达成<code>Quorum</code>协议。当数据库实例需要读磁盘<code>IO</code>时，将当前最新的<code>VDL</code>作为一致性位点<code>read-point</code>，并选择一个拥有所有<code>VDL</code>位点的日志的节点作为请求节点，这样只需要访问这一个节点即可得到数据页的最新版本。</p>
<p>数据库实例接收客户端的读请求，以<code>PG</code>（<code>per-Group</code>）为单位计算<code>Minimum Read Point LSN</code>，在有读副本实例的情况下，每个实例都都可以作类似的计算得到位点，实例之间通过<code>gossip</code>协议得到全局的<code>per-Group MRPL</code>，称之为<code>PGMRPL</code>。<code>PGMRPL</code>是全局<code>read-point</code>的低水位，每个存储节点根据<code>PGMRPL</code>，不断推进数据页版本，并回收不再使用的日志。</p>
<h2 id="2-2、Quorum-Gossip原理分析"><a href="#2-2、Quorum-Gossip原理分析" class="headerlink" title="2.2、Quorum+Gossip原理分析"></a>2.2、Quorum+Gossip原理分析</h2><h3 id="2-2-1、分布式基本原则和理论"><a href="#2-2-1、分布式基本原则和理论" class="headerlink" title="2.2.1、分布式基本原则和理论"></a>2.2.1、分布式基本原则和理论</h3><h4 id="2-2-1-1、CAP"><a href="#2-2-1-1、CAP" class="headerlink" title="2.2.1.1、CAP"></a>2.2.1.1、CAP</h4><p><strong>CAP</strong>理论（即<code>Consistency</code>一致性，<code>Availability</code>可用性，<code>Partition tolerance</code>分区容错性），是当前分布式系统公认的理论，亦即一个分布式系统不可能同时满足这三个特性，只能三求其二。其中<code>P</code>是基本要求，如果没有<code>P</code>就不是分布式系统了，所以一般都是在满足<code>P</code>的情况下，在<code>C</code>和<code>A</code>之间寻求平衡。</p>
<h4 id="2-2-1-2、ACID"><a href="#2-2-1-2、ACID" class="headerlink" title="2.2.1.2、ACID"></a>2.2.1.2、ACID</h4><p><strong>ACID</strong>（<code>Atomicity</code>原子性，<code>Consistency</code>一致性，<code>Isolation</code>隔离性，<code>Durability</code>持久性）是事务的特点，具有<strong>强一致性</strong>，一般用于单机事务，分布式事务若采用这个原则会丧失一定的可用性，属于<code>CP</code>系统。</p>
<h4 id="2-2-1-3、BASE"><a href="#2-2-1-3、BASE" class="headerlink" title="2.2.1.3、BASE"></a>2.2.1.3、BASE</h4><p><strong>BASE</strong>理论（即<code>Basically Availabe</code>基本可用，<code>Soft state</code>软状态，<code>Eventually consistency</code>最终一致性）是对大规模的互联网分布式系统实践的总结，<strong>用弱一致性来换取可用性</strong>，不同于<code>ACID</code>，属于<code>AP</code>系统。</p>
<h4 id="2-2-1-4、NWR机制"><a href="#2-2-1-4、NWR机制" class="headerlink" title="2.2.1.4、NWR机制"></a>2.2.1.4、NWR机制</h4><p>N：有多少份数据副本<br>W：一次成功的写操作至少有w份数据写入成功<br>R：一次成功的读操作至少有R份数据读取成功</p>
<p><code>NWR</code>值的不同组合会产生不同的一致性效果。当<code>W+R&gt;N</code>的时候，读取操作和写入操作成功的数据一定会有交集，这样就可以保证<strong>一定能够读取到最新版本</strong>的更新数据，数据的<strong>强一致性</strong>得到了保证；反之，<code>R+W&lt;=N</code>，则无法保证数据的强一致性，因为成功写和成功读集合可能不存在交集，这样读操作无法读取到最新的更新数值，也就<strong>无法保证数据的强一致性</strong>。</p>
<p>版本的新旧需要版本控制算法来判别，比如<strong>向量时钟</strong>。</p>
<h3 id="2-2-2、Quorum机制"><a href="#2-2-2、Quorum机制" class="headerlink" title="2.2.2、Quorum机制"></a>2.2.2、Quorum机制</h3><h4 id="2-2-2-1、简介"><a href="#2-2-2-1、简介" class="headerlink" title="2.2.2.1、简介"></a>2.2.2.1、简介</h4><p><code>Quorom</code>机制，是一种分布式系统中常用的，用来<strong>保证数据冗余和最终一致性</strong>的投票算法，主要思想来源于<strong>抽屉原理</strong>。在有冗余数据的分布式存储系统当中，冗余数据对象会在不同的机器之间存放多份拷贝。但是<strong>同一时刻一个数据对象的多份拷贝只能用于读或者用于写</strong>。<br>分布式系统中的每一份数据拷贝对象都被赋予一票。每一个操作必须要获得最小的读票数（<code>Vr</code>）或者最小的写票数(<code>Vw</code>）才能读或者写。如果一个系统有<code>V</code>票（意味着一个数据对象有<code>V</code>份冗余拷贝），那么这最小读写票必须满足：</p>
<ul>
<li><code>Vr + Vw &gt; V</code></li>
<li><code>Vw &gt; V/2</code></li>
</ul>
<p><strong>第一条规则</strong>保证了一个数据<strong>不会被同时读写</strong>。当一个写操作请求过来的时候，它必须要获得<code>Vw</code>个冗余拷贝的许可。而剩下的数量是<code>V-Vw</code> 不够<code>Vr</code>，因此不能再接受读请求。同理，当读请求已经获得了<code>Vr</code>个冗余拷贝的许可时，写请求就无法获得许可了。<br><strong>第二条规则</strong>保证了<strong>数据的串行化修改</strong>。一份数据的冗余拷贝不可能同时被两个写请求修改。</p>
<p><code>Quorum</code>机制其实就类似于<code>NWR</code>机制。</p>
<h4 id="2-2-2-2、MA中的实现"><a href="#2-2-2-2、MA中的实现" class="headerlink" title="2.2.2.2、MA中的实现"></a>2.2.2.2、MA中的实现</h4><p><strong>第一阶段</strong>：（所有的存储层节点在一定的时间内都能收到日志）只需要大于一半的存储 层节点返回成功（这里每个节点还需要返回当前节点的 <code>VDL</code>），整个写日志过程就算成功。 </p>
<p><strong>第二阶段</strong>：利用 <code>gossip</code> 协议来保证空缺的日志得以补全，其检查时机是<strong>下次日志写入时</strong>检查前面的日志是否有空洞，如果存储空洞则向其他的节点取空缺的日志。</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323204733832.png" alt="image-20210323204733832"></p>
<h3 id="2-2-3、Gossip协议"><a href="#2-2-3、Gossip协议" class="headerlink" title="2.2.3、Gossip协议"></a>2.2.3、Gossip协议</h3><h4 id="2-2-3-1、六度分割理论"><a href="#2-2-3-1、六度分割理论" class="headerlink" title="2.2.3.1、六度分割理论"></a>2.2.3.1、六度分割理论</h4><p>1967年，哈佛大学的心理学教授Stanley Milgram想要描绘一个连结人与社区的人际连系网。做过一次连锁信实验，结果发现了“六度分隔”现象。简单地说：“<strong>你和任何一个陌生人之间所间隔的人不会超过六个，也就是说，最多通过六个人你就能够认识任何一个陌生人</strong>。”</p>
<p>数学解释该理论：依据<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%82%93%E5%B7%B4%E6%95%B0">邓巴数(150定律)</a>，若每个人认识150人，其六度就是<br>$$<br>150^6 ＝11,390,625,000,000<br>$$<br>（约11.4万亿）。消除一些节点重复，那也几乎覆盖了整个地球人口数倍以上。</p>
<p>这也是<strong>Gossip协议的雏形</strong></p>
<h4 id="2-2-3-2、Gossip基本原理"><a href="#2-2-3-2、Gossip基本原理" class="headerlink" title="2.2.3.2、Gossip基本原理"></a>2.2.3.2、Gossip基本原理</h4><p><code>Gossip</code>协议与<code>Paxos</code>，<code>Raft</code>协议最大的区别就是它是<strong>去中心化</strong>的，即没有<code>Leader</code>，每个节点都是平等的。</p>
<p>每个节点存放了一个（<code>key,value,version</code>）构成的列表，每隔一定的时间，节点都会主动挑选一个在线节点进行下图的过程（不在线的也会挑一个尝试），两个节点各自修改自己较为落后的数据，<strong>最终数据达成一致并且都较新</strong>。</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323173409190.png" alt="image-20210323173409190"></p>
<h4 id="2-2-3-3、MA中的实现"><a href="#2-2-3-3、MA中的实现" class="headerlink" title="2.2.3.3、MA中的实现"></a>2.2.3.3、MA中的实现</h4><p>步骤 1，当 <code>se</code> 节点收到 <code>ce</code> 节点的 <code>redo</code>，如果检查到当前节点的 <code>redo</code> 日志有空缺，随机 地向另外<code>⌈ ݊n/2 ⌉</code>个节点中的一个请求空缺的日志（肯定有一个节点有对应空缺的日志） </p>
<p>步骤 2，当 <code>se</code> 节点收到其他节点的 <code>redo</code> 日志请求，发送对应的 <code>redo</code> 日志。</p>
<p>伪代码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//active thread </span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">wait</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>redo log is <span class="token operator">not</span> intergrity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        send update request to other nodes<span class="token punctuation">;</span> 
            receive updata respon<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> 
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//passive thread </span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    request <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>have redo log in request<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        send redo log<span class="token punctuation">;</span> 
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-2-3-4、Gossip协议优缺点"><a href="#2-2-3-4、Gossip协议优缺点" class="headerlink" title="2.2.3.4、Gossip协议优缺点"></a>2.2.3.4、Gossip协议优缺点</h4><p><strong>优点</strong>：</p>
<ul>
<li><strong>可扩展性</strong></li>
</ul>
<p>如下表格所示，假定<code>fanout=4</code>（一个节点将信息传给4个节点），那么在节点数<code>N</code>分别是20、40、80、160时，消息传播到所有节点需要的理论循环次数对比图如下：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323171629506.png" alt="image-20210323171629506"></p>
<p>其中，理论循环次数<code>count</code>计算公式如下：<br>$$<br>count = log (fanout) N<br>$$<br>我们发现，在节点成倍扩大的情况下，循环次数并没有增加很多。所以，<code>Gossip</code>协议具备可扩展性。</p>
<ul>
<li><strong>失败容错</strong></li>
</ul>
<p>即使因为网络故障等原因，某些节点没有收到信息，这对最终所有节点接收到消息是没有任何影响的。因为一个节点会<strong>多次</strong>分享某个需要传播的信息，即使不能连通某个节点，其他被感染的节点也会尝试向这个节点传播信息。</p>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>拜占庭问题</strong></li>
</ul>
<p>即如果有一个恶意传播消息的节点，<code>Gossip</code>协议的分布式系统就会出问题。</p>
<h1 id="3、多SE设计文档学习和源码解读"><a href="#3、多SE设计文档学习和源码解读" class="headerlink" title="3、多SE设计文档学习和源码解读"></a>3、多SE设计文档学习和源码解读</h1><h2 id="3-1、SE日志模块"><a href="#3-1、SE日志模块" class="headerlink" title="3.1、SE日志模块"></a>3.1、SE日志模块</h2><p>日志即数据库主要由四个子模块组成，整体方案图如下：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210324115048165.png" alt="image-20210324115048165"></p>
<h3 id="3-1-1、hot-log-buffer（日志缓冲区）"><a href="#3-1-1、hot-log-buffer（日志缓冲区）" class="headerlink" title="3.1.1、hot log buffer（日志缓冲区）"></a>3.1.1、hot log buffer（日志缓冲区）</h3><p><code>hot log buffer</code> 实现的思路是：将 <code>hot log buffer</code> 分为两部分(<code>first buf&amp;&amp;second buf</code>)分别进行管理，一部分用于日志的收集，另一部分由于日志的解析，两部分交替使用。例如，<code>first buf</code> 收集日志后交由日志解析使用，<code>second buf</code> 用于继续收集日志，待 <code>first buf</code> 中的日志解析 完成之后，再使用 <code>second buf</code> 进行解析，<code>first buf</code> 再次用于收集日志。这样日志收集和解析可以并行进行，提高效率。</p>
<p><code>hot log buffer</code>，设置为两部分（<code>first buf</code> 和 <code>second buf</code>），每部分大小均设置为 32MB (<code>HOT_LOG_BUFFER_SIZE</code>)，其结构示意图见图 3-11。</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210324120145291.png" alt="image-20210324120145291"></p>
<p>主要接口如下：</p>
<ul>
<li><code>hot_log_t</code></li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/** Hot log buffer to storage log records accept from computing
engine, which is a circular buffer */</span>
<span class="token keyword">struct</span> hot_log_t <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    ib_mutex_t  mutex<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*!&lt; mutex protecting the hot log buffer */</span>
    byte<span class="token operator">*</span>        buf_ptr<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*!&lt; unaligned log buffer, which should
                    be of double of buf_size */</span>
    byte<span class="token operator">*</span>        buf<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*!&lt; hot log buffer currently in use;
                    this could point to either the first half of
                    the aligned(buf_ptr) or the second half in
                    turns, so that log parse to hash table don't
                    block concurrent operation which will write
                    log to this buffer */</span>
    <span class="token keyword">bool</span>        first_in_use<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*!&lt; true if buf points to the
                    first half of the aligned(buf_ptr), false
                    if the second half */</span>
    ulint   buf_free_block<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*!&lt; first free block offset within
                    the hot log buffer, it must accommodate
                    OS_FILE_LOG_BLOCK_SIZE many times */</span>
    lsn_t   last_log_file_offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*!&lt; last offset of the log
                    files for log write */</span>
    ulint   last_n_bytes<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*!&lt; the size of logs received last
                    time */</span>
    ulint   buf_size<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*!&lt; hot log buffer size in bytes */</span>

    <span class="token comment" spellcheck="true">/*ulint       next_to_parse; !&lt; first offset of log records
                    that are not parsed */</span>
  lsn_t            buf_lsn<span class="token punctuation">;</span>
    ib_mutex_t       list_mutex<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*!&lt; mutex protecting the lost_log_list */</span>
    lost_log_list_t<span class="token operator">*</span> lost_log_list<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/*!&lt; list of lost log */</span>

  std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>lsn_t<span class="token operator">></span> vdl<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>log_read_thread</code></li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/******************************************************/</span><span class="token comment" spellcheck="true">/**
Log read thread, read log from log files to hot log buffer.
@return a dummy parameter */</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span>
os_thread_ret_t
<span class="token function">DECLARE_THREAD</span><span class="token punctuation">(</span>log_read_thread<span class="token punctuation">)</span><span class="token punctuation">(</span>
<span class="token comment" spellcheck="true">/*==============================*/</span>
    <span class="token keyword">void</span><span class="token operator">*</span>    arg <span class="token function">MY_ATTRIBUTE</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unused<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>hot_log_read_from_file</code></li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">hot_log_read_from_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token function">ut_ad</span><span class="token punctuation">(</span><span class="token function">hot_log_list_mutex_own</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  log_group_t<span class="token operator">*</span> group <span class="token operator">=</span> <span class="token function">UT_LIST_GET_FIRST</span><span class="token punctuation">(</span>log_sys<span class="token operator">-</span><span class="token operator">></span>log_groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
  lsn_t align_start_lsn <span class="token operator">=</span> <span class="token function">lsn_align_down</span><span class="token punctuation">(</span>hot_log_sys<span class="token operator">-</span><span class="token operator">></span>buf_lsn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  lsn_t align_end_lsn <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  lsn_t current_vdl <span class="token operator">=</span> hot_log_sys<span class="token operator">-</span><span class="token operator">></span>vdl<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hot_log_lsn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> current_vdl<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    align_end_lsn <span class="token operator">=</span> <span class="token function">lsn_align_down</span><span class="token punctuation">(</span>current_vdl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    align_end_lsn <span class="token operator">=</span> <span class="token function">lsn_align_up</span><span class="token punctuation">(</span><span class="token function">hot_log_lsn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>hot_log_sys<span class="token operator">-</span><span class="token operator">></span>buf_lsn <span class="token operator">&lt;</span> <span class="token function">hot_log_lsn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> hot_log_sys<span class="token operator">-</span><span class="token operator">></span>buf_lsn <span class="token operator">&lt;</span> align_end_lsn<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> 
    lsn_t read_len <span class="token operator">=</span> align_end_lsn <span class="token operator">-</span> align_start_lsn<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>read_len <span class="token operator">></span> HOT_LOG_READ_SIZE<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      align_end_lsn <span class="token operator">=</span> HOT_LOG_READ_SIZE <span class="token operator">+</span> align_start_lsn<span class="token punctuation">;</span>
      read_len <span class="token operator">=</span> HOT_LOG_READ_SIZE<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    byte <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token keyword">new</span> byte<span class="token punctuation">[</span>read_len<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">log_mutex_enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">log_group_read_log_seg</span><span class="token punctuation">(</span>
      buffer<span class="token punctuation">,</span> group<span class="token punctuation">,</span> align_start_lsn<span class="token punctuation">,</span> align_end_lsn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">log_mutex_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">hot_log_mutex_enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log_range_t range <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> LOST_LOG_NONE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token function">get_ce_log_range</span><span class="token punctuation">(</span>hot_log_sys<span class="token operator">-</span><span class="token operator">></span>buf_lsn<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token punctuation">(</span>ulint<span class="token punctuation">)</span>read_len<span class="token punctuation">,</span> range<span class="token punctuation">,</span> <span class="token string">"$from file$"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hot_log_write_buffer</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token punctuation">(</span>ulint<span class="token punctuation">)</span>read_len<span class="token punctuation">,</span> range<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hot_log_mutex_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer<span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> UNIV_DEBUG</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"hot log read from_file buffer lsn is "</span>
            <span class="token string">"consistency with hot log lsn"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-1-2、日志持久化"><a href="#3-1-2、日志持久化" class="headerlink" title="3.1.2、日志持久化"></a>3.1.2、日志持久化</h3><p>分三步：</p>
<p>（1）将刚接收到的日志写入磁盘；</p>
<p>（2）将日志写入 hot log buffer； </p>
<p>（3）向 CE 发送确认消息。</p>
<p>日志写入<code>hot log buffer</code>流程：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210324125639060.png" alt="image-20210324125639060"></p>
<p>主要接口如下：</p>
<ul>
<li><p><code>write_from_log</code>：响应 <code>CE</code> 端写请求，将 <code>CE</code> 端传来的日志持久化</p>
</li>
<li><p><code>hot_log_buf_write_into</code> ：将日志写到 <code>hot log buffer</code></p>
</li>
<li><p><code>log_block_no_check</code>：检查日志的连续性</p>
</li>
</ul>
<h2 id="3-2、网络通信模块"><a href="#3-2、网络通信模块" class="headerlink" title="3.2、网络通信模块"></a>3.2、网络通信模块</h2><h3 id="3-2-1、网络监听模块"><a href="#3-2-1、网络监听模块" class="headerlink" title="3.2.1、网络监听模块"></a>3.2.1、网络监听模块</h3><p>监听模块的主要功能是监听客户端（计算层），是否有新的连接过来，并创建新的连接。 </p>
<p>其设计主要的模块是 <code>vio</code> 模块和 <code>sql/conn_handler</code>模块。</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210323213438536.png" alt="image-20210323213438536"></p>
<p><code>vio</code> 是底层通信模块，对上面封装了大部分与系统交互的细节，而 <code>sql/conn_handler</code> 是上层主要的监听模块。</p>
<p>我们知道，连接<code>MySQL</code>的方式有如下四种，类图中我们只列出了最常见的<code>TCP/IP</code>连接方式</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210324091707415.png" alt="image-20210324091707415"></p>
<p>下面是监听模块类图</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210324090128086.png" alt="image-20210324090128086"></p>
<p>这里主要分为两层：上面一层是<strong>处理监听信息</strong>，下面是<strong>对新的连接的处理</strong>。其中，上面的结构使用了工厂方法模式，不同 <code>listener</code> 监听不同系统端口的状态信息，并生成该次监听的 <code>Channel_info</code> 信息。 下面是简单的工厂模式以面对处理新的连接时，选择不同处理方式： </p>
<ul>
<li><p><code>Per_thread_connection_handler</code> ：每当有一个连接建立时，便创建一个新的线程  </p>
</li>
<li><p><code>One_thread_connection_handler</code>：一个线程处理所有的链接请求。</p>
</li>
</ul>
<p>这里我们暂时只讨论 <code>Per_thread_connection_handler</code>。</p>
<p>在 <code>Per_thread_connection_handler</code> 模式并且采用 <code>tcp/ip</code> 通信情况下，每创建一个新的客户端线程，都会将之前的监听得到的连接信息传给新创建的 <code>work</code> 线程，其中包括与客户端连接的 <code>socket</code> ，<code>work</code> 线程通过持有该 <code>socket</code> 做进一步的初始化动作。</p>
<p>以 <code>Socket</code> 监听为例，之后就转到 <code>socket_conn_event_handler_s()</code> 方法来监听所有通过 <code>tcp/ip</code> 连接到存储层的计算层。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">socket_conn_event_handler_s</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> Acceptor <span class="token operator">=</span> Connection_acceptor<span class="token operator">&lt;</span>Mysqld_socket_listener<span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> conn_event_handler<span class="token operator">&lt;</span>Acceptor<span class="token operator">></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">conn_event_handler</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">my_thread_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//给线程分配内存</span>
    st_wrap_thread_arg <span class="token operator">*</span>thread_arg <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">struct</span> st_wrap_thread_arg<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    T <span class="token operator">*</span>conn_acceptor <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>T <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>thread_arg<span class="token operator">-</span><span class="token operator">></span>acceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    conn_acceptor<span class="token operator">-</span><span class="token operator">></span><span class="token function">connection_event_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Connection acceptor循环监听来自客户端的连接</span>
        Connection_handler_manager <span class="token operator">*</span>mgr<span class="token operator">=</span> Connection_handler_manager<span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>abort_loop<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
          Channel_info <span class="token operator">*</span>channel_info<span class="token operator">=</span> m_listener<span class="token operator">-</span><span class="token operator">></span><span class="token function">listen_for_connection_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>channel_info <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
            mgr<span class="token operator">-</span><span class="token operator">></span><span class="token function">process_new_connection</span><span class="token punctuation">(</span>channel_info<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//处理新接收到的连接</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    conn_acceptor<span class="token operator">-</span><span class="token operator">></span><span class="token function">close_listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> conn_acceptor<span class="token punctuation">;</span>
    thread_arg<span class="token operator">-</span><span class="token operator">></span>conn_mgr<span class="token operator">-</span><span class="token operator">></span><span class="token function">remove_handler</span><span class="token punctuation">(</span>thread_arg<span class="token operator">-</span><span class="token operator">></span>acceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_thread_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-2-2、通信模块"><a href="#3-2-2、通信模块" class="headerlink" title="3.2.2、通信模块"></a>3.2.2、通信模块</h3><p>监听模块监听到有新的连接，并将该连接信息传到 <code>work</code> 线程，之后便由 <code>work</code> 线程和 <code>client</code> 进行通信，<code>work</code> 线程和 <code>client</code> 通信一般分为如下几个层次，其层次之间的关系类似于 <code>tcp/ip</code> 的四层模型之间的逻辑关系</p>
<p>(1) <code>THD</code>：控制该次连接所有的信息； </p>
<p>(2) <code>Protocol</code>：针对不同的连接方式，和处理的数据，其 Protocol 可能不同； </p>
<p>(3) <code>NET</code>：控制网络包的有序和相关网络通信的正确性； </p>
<p>(4) <code>VIO</code>：封装了 socket，named_pipe，shared_memory，以及不同平台的实现方式。 </p>
<p>(5) <code>Conn</code>：socket，named_pipe，shared_memory 等不同通信方式，基于操作系统的不同可能略有不同。</p>
<p><code>NET</code> 层主要负责 <code>Protocol</code> 层和 <code>VIO</code> 层的包的转发，当向下转发 <code>Protocol</code> 到 <code>VIO</code> 层的， <code>NET</code> 层会控制每个发送到 <code>VIO</code> 层 <code>Packet</code>（这里指要 发送到网络的数据包）的序号，并对大于 16M 的包会进行拆分成多个 <code>Packet</code>，直至其拆分之后的 <code>Packet</code> 的大小小于 16M；当向<code>Protocol</code> 提供服务时，<code>NET</code> 会先从 <code>VIO</code> 读取接受的 <code>Packet</code>，之后组装这些 <code>Packet</code>，以保持有序，<code>Protocol</code> 由此从 <code>NET</code> 获取完整的数据 服务。其中 <code>NET</code> 中比较重要的接口有:</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">my_bool <span class="token function">my_net_write</span><span class="token punctuation">(</span>NET <span class="token operator">*</span>net<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>packet<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//写数据到VIO层</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">my_net_read</span><span class="token punctuation">(</span>NET <span class="token operator">*</span>net<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//从VIO层读数据</span>
my_bool <span class="token function">net_write_command</span><span class="token punctuation">(</span>NET <span class="token operator">*</span>net<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> command<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>header<span class="token punctuation">,</span> size_t head_len<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>packet<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//提供对命令数据的发送</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>VIO</code> 层是调用系统底层的模块，但是系统底层的模块又被 <code>PSI</code> 所封装，这在之前的监听模块也会遇到 <code>PSI</code> 的代码和我们要移植的代码混在一起的情况，这里对我们如何处理原有的 <code>PSI</code> 模块提出了要求。</p>
<p><code>Protocol</code> 层提供各种接口来对上层提供服务，以<code>send_ok</code> 接口为例，被组装之后，发送给 <code>VIO</code> 层的信息格式如图 3-23 所示。 </p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210324131927429.png" alt="image-20210324131927429"></p>
<p>从协议格式来看，0 是一个标志位，用于表示为 <code>OK</code> 信息； <code>affect_rows</code> 是 SQL 执行影响的记录行数； <code>id</code> 为查询 id 值； <code>server_status</code> 表示 SQL 执行后，server 的状态值； <code>warn_count</code> 是 SQL 执行产生的警告信息数，最大值为 65535，大于这个数存储 65535；<code>msg</code> 表示传输的信息，没有长度限制，如果信息过长，会进行分包传输。</p>
<p><code>Redo</code> 线程和 <code>Page</code> 线程是由存储层 <code>work</code> 线程开启时初始化的两个网络 <code>IO</code> 线程，下面介绍下这两个线程异步通信的方式</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210324132502452.png" alt="image-20210324132502452"></p>
<p>异步通信流程为：首先 boffer pool 发送异步 IO 请求，异步 IO 模块分配 slot，并将 IO 请求发送到 page 线程，page 线程随后向存储层的 page 线程发送 read page 请求（上面的虚 线），同时 read thread0 等待，直到 page 线程读到 slot 30 的请求的页面数据，之后 read thread0 将页面数据写入 buffer pool 并设置相关 buffer pool 参数，该次异步 IO 完毕。 </p>
<p>在存储层，则是由 1 个 <code>page</code> 线程和 4 个 <code>write</code> 线程组成的异步页面读取线程， </p>
<p>其工作方式类似于计算层，异步页面读取如图 3-25 所示。</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210324132713083.png" alt="image-20210324132713083"></p>
<p>当存储层收到来自计算层的页面请求，首先在 <code>buffer pool</code> 中查找该页面，如果该页面在存储层的 <code>buffer pool</code> 中，则直接取出来 发送给计算层 <code>page</code> 线程。如果不在则首先利用<code>异步IO</code> 从文件中取出该页面，然后发送给计算层 <code>page</code> 线程和存储层的 <code>buffer pool</code>。</p>
<p>主要接口设计：</p>
<p>(1) <code>num,num_text,num_binary</code> ：将整型和浮点型转为字节类型可网络传输的类型，这里有两种转换方式：转换为字符串的类： <code>num_text</code> ，转换为二进制传输的类：<code>num_binary</code> ，这两个类在 <code>MySQL</code> 中有对应的库直接用即可； </p>
<p>(2) <code>basic_io,basic_in_protocol, basic_out_protocol, basic_protocol</code> ：<strong>负责对外提供 IO 接口</strong>，其中 </p>
<p><code>basic_io</code>： 负责基本的 IO 功能：负责 num 的转换方式是 num_text 类型 还是 num_binary 类型， 负责数据转 换的格式如 浮点型 的转换精度 等； </p>
<p><code>basic_out_protocol</code> ：负责将某种协议（从某种情况来看： int , double 也可视作协 议）转换为 IO 流，并输出到 net 上去，并提供拓展的接口（借助 Command 模式，即仿函数）；</p>
<p><code>basic_in_protocol</code> ：负责将网络 IO 流转换为我们所需要的某种协议； </p>
<p><code>basic_protocol</code> ：提供 IO 的输入与输出。</p>
<p>(3) <code>net_io</code> ：这一层是 <code>NET</code> 层和 <code>Vio</code> 层封装，封装所有的底层操作，主要是由于 <code>MySQL</code> 对这两层的设计比较糟糕，使得层次与层次之间的区分得并不是太好。</p>
<h3 id="3-2-3、多线程通信"><a href="#3-2-3、多线程通信" class="headerlink" title="3.2.3、多线程通信"></a>3.2.3、多线程通信</h3><p>多线程通信的连接数= 1（独立的写日志的连接）+ n（数据页连接） </p>
<p><code>CE</code> 层架构限制 <code>Redo</code> 日志不支持并发传输，所以只对所有读页面和创建文件（建表）的请求采用多线程通信的方式。架构限制最多 <code>n</code> 个线程和 <code>redo</code> 日志并行传输。当第 n+1 个线程请求发生，流程如图 3-26 所示</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210324133547725.png" alt="image-20210324133547725"></p>
<p><code>MA</code> 项目在原本<code>Mysql</code> 通信报文的基础上添加了两种报文类型 ： <code>CE_INNOBASE_MESSAGE</code> 和 <code>SE_ADD_SLAVE</code>。</p>
<h3 id="3-2-4、常用接口"><a href="#3-2-4、常用接口" class="headerlink" title="3.2.4、常用接口"></a>3.2.4、常用接口</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/*1.向网络写数据 @file: net_serve.cc*/</span> <span class="token function">net_write_raw</span><span class="token punctuation">(</span>NET <span class="token operator">*</span>net<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>packet<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/*2.从网络读数据 @file: net_serve.cc*/</span> <span class="token function">net_read_raw</span><span class="token punctuation">(</span>NET <span class="token operator">*</span> net<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment" spellcheck="true">/*3.向SE发起数据传输连接 @file: client.c*/</span> <span class="token function">mysql_real_connect_with_se</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment" spellcheck="true">/*4.向SE发起同步vdl的连接 @file: client.c */</span> <span class="token function">mysql_real_connect_with_se_for_vdl_sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment" spellcheck="true">/*5.建立监听 @file: socket_connection.cc*/</span> <span class="token function">setup_listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment" spellcheck="true">/*6.监听过程 @file: socket_connection.cc */</span> <span class="token function">listen_for_connection_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment" spellcheck="true">/*7.处理具体连接请求 @file:os0doc.cc*/</span> <span class="token function">ha_ma_se</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment" spellcheck="true">/*8.整理和写入数据包 @sql_class.cc*/</span> <span class="token function">ma_se</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment" spellcheck="true">/*9.向SE每0.2秒发送read_point @os0doc.**/</span> <span class="token function">sync_slave_lsn_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《20210324》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2021/04/08/20210324/" property="cc:attributionName"
               rel="cc:attributionURL">
                JavaGuy
            </a> 采用
            <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: 'GgssQFlBBeYrJoL1y5s8jXeR-gzGzoHsz',
        appKey: 'kXYkbr7xencqP3PxqQNKykdt',
        notify: 'true' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/04/15/20210415/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="20210415">
                        
                        <span class="card-title">20210415</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            本周工作总结一、概述1、静态阅读gossip代码2、尝试改动代码，构造第二台SE收包缺失，动态跟踪gossip部分代码二、具体内容1、gossip部分代码梳理1.1、get_lost_log_information首先会遍历lost_log
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-04-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Lab/" class="post-category" target="_blank">
                                    Lab
                                </a>
                            
                            <a href="/categories/Lab/%E5%91%A8%E4%BC%9A%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" class="post-category" target="_blank">
                                    周会总结报告
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MSE/" target="_blank">
                        <span class="chip bg-color">MSE</span>
                    </a>
                    
                    <a href="/tags/Quorum/" target="_blank">
                        <span class="chip bg-color">Quorum</span>
                    </a>
                    
                    <a href="/tags/Gossip/" target="_blank">
                        <span class="chip bg-color">Gossip</span>
                    </a>
                    
                    <a href="/tags/Socket/" target="_blank">
                        <span class="chip bg-color">Socket</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/04/08/20210317/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="20210317">
                        
                        <span class="card-title">20210317</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            任务
具体看B+树分裂这一个事务过程中，内部事务mtr是如何组成的，redo日志和undo日志是如何写的。

源码调试分析注意到MySQL5.7默认是没有开启binlog，也就不支持内部XA，进而看不到两阶段提交，所以我们先开启binlog
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-04-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Lab/" class="post-category" target="_blank">
                                    Lab
                                </a>
                            
                            <a href="/categories/Lab/%E5%91%A8%E4%BC%9A%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" class="post-category" target="_blank">
                                    周会总结报告
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/B-%E6%A0%91/" target="_blank">
                        <span class="chip bg-color">B+树</span>
                    </a>
                    
                    <a href="/tags/%E7%B4%A2%E5%BC%95%E5%88%86%E8%A3%82/" target="_blank">
                        <span class="chip bg-color">索引分裂</span>
                    </a>
                    
                    <a href="/tags/binlog/" target="_blank">
                        <span class="chip bg-color">binlog</span>
                    </a>
                    
                    <a href="/tags/mtr/" target="_blank">
                        <span class="chip bg-color">mtr</span>
                    </a>
                    
                    <a href="/tags/redo/" target="_blank">
                        <span class="chip bg-color">redo</span>
                    </a>
                    
                    <a href="/tags/undo/" target="_blank">
                        <span class="chip bg-color">undo</span>
                    </a>
                    
                    <a href="/tags/lsn/" target="_blank">
                        <span class="chip bg-color">lsn</span>
                    </a>
                    
                    <a href="/tags/XA%E4%BA%8B%E5%8A%A1/" target="_blank">
                        <span class="chip bg-color">XA事务</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: JavaGuy的博客<br />'
            + '作者: JavaGuy<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

<!-- <script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'artDetail',
        blogId: '20962-1585405055583-879',
        name: '算法码上来',
        qrcode: 'https://godweiyang.com/medias/gzh.jpg',
        keyword: 'VIP',
    });
</script> -->

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5, h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5, h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; ZhangQu. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">285.6k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zhangqu999" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:zhang1842279380@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>





    <a href="http://wpa.qq.com/msgrd?v=3&uin=1842279380&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 1000;
        var uvcountOffset = 200;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 03, 18, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    
    <script type="text/javascript" src="/libs/others/snow.js"></script>
    

</body>

</html>