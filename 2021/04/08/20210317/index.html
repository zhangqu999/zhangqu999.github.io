<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="20210317, SpringBoot Java MySQL MA JavaGuy Math 算法">
    <meta name="baidu-site-verification" content="code-r7CYm21B6o" />
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48" />
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7" />
    <meta name="description" content="任务
具体看B+树分裂这一个事务过程中，内部事务mtr是如何组成的，redo日志和undo日志是如何写的。

源码调试分析注意到MySQL5.7默认是没有开启binlog，也就不支持内部XA，进而看不到两阶段提交，所以我们先开启binlog">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>20210317 | JavaGuy的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ce84511d3df71640a9378a69f6293044";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="JavaGuy的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JavaGuy的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">JavaGuy的博客</div>
        <div class="logo-desc">
            
            华中科技大学 | 计算机科学与技术 | 分布式云数据库内核
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '91a6f824b85ba9ed6e7cf599364e2f8bc897a465357160c6425c8eacd8883377';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/3.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        20210317
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/B-%E6%A0%91/" target="_blank">
                            <span class="chip bg-color">B+树</span>
                        </a>
                        
                        <a href="/tags/%E7%B4%A2%E5%BC%95%E5%88%86%E8%A3%82/" target="_blank">
                            <span class="chip bg-color">索引分裂</span>
                        </a>
                        
                        <a href="/tags/binlog/" target="_blank">
                            <span class="chip bg-color">binlog</span>
                        </a>
                        
                        <a href="/tags/mtr/" target="_blank">
                            <span class="chip bg-color">mtr</span>
                        </a>
                        
                        <a href="/tags/redo/" target="_blank">
                            <span class="chip bg-color">redo</span>
                        </a>
                        
                        <a href="/tags/undo/" target="_blank">
                            <span class="chip bg-color">undo</span>
                        </a>
                        
                        <a href="/tags/lsn/" target="_blank">
                            <span class="chip bg-color">lsn</span>
                        </a>
                        
                        <a href="/tags/XA%E4%BA%8B%E5%8A%A1/" target="_blank">
                            <span class="chip bg-color">XA事务</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/Lab/" class="post-category" target="_blank">
                            Lab
                        </a>
                        
                        <a href="/categories/Lab/%E5%91%A8%E4%BC%9A%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" class="post-category" target="_blank">
                            周会总结报告
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-04-08
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    JavaGuy
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    3.3k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    15 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="任务"><a href="#任务" class="headerlink" title="任务"></a><strong>任务</strong></h1><ul>
<li>具体看<code>B+树</code>分裂这一个事务过程中，内部事务<code>mtr</code>是如何组成的，<code>redo</code>日志和<code>undo</code>日志是如何写的。</li>
</ul>
<h1 id="源码调试分析"><a href="#源码调试分析" class="headerlink" title="源码调试分析"></a>源码调试分析</h1><p>注意到<code>MySQL5.7</code>默认是没有开启<code>binlog</code>，也就不支持<strong>内部XA</strong>，进而看不到两阶段提交，所以我们先开启<code>binlog</code></p>
<p>修改<code>my.ini</code>配置文件，添加下面三行配置</p>
<pre class="line-numbers language-ini"><code class="language-ini"><span class="token constant">log-bin</span><span class="token attr-value"><span class="token punctuation">=</span>mysql-bin</span>
<span class="token constant">binlog-format</span><span class="token attr-value"><span class="token punctuation">=</span>Row</span>
<span class="token constant">server-id</span><span class="token attr-value"><span class="token punctuation">=</span>1</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>重启<code>mysqld</code>，执行<code>show binary logs;</code>检查<code>binlog</code>是否开启成功</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315233645193.png" alt="image-20210315233645193"></p>
<p>该文件在<code>data</code>目录下</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315233729710.png" alt="image-20210315233729710"></p>
<p>这样<code>MySQL</code>就可以利用<strong>内部XA</strong>来保证<code>redo log</code>和<code>binlog</code>之间的一致性，进而就能看到<code>2pc</code></p>
<p>接着我们来回顾下<code>mtr</code>的关键数据结构<code>mtr_t</code></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> mtr_t <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** Impl是mtr_t的内部类用以描述mtr状态 */</span>
<span class="token keyword">struct</span> Impl <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** memo stack for locks etc.
mtr 持有锁的栈 */</span>
mtr_buf_t m_memo<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** mini-transaction log，
即redo日志*/</span>
mtr_buf_t m_log<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** true if mtr has made at least one buffer pool page dirty
是否产生buffer pool脏页*/</span>
<span class="token keyword">bool</span> m_made_dirty<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** true if inside ibuf changes
insert buffer 是否修改 */</span>
<span class="token keyword">bool</span> m_inside_ibuf<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** true if the mini-transaction modified buffer pool pages 
是否修改buffer pool pages*/</span>
<span class="token keyword">bool</span> m_modifications<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** Count of how many page initial log records have been written to the mtr log 
log 记录数*/</span>
ib_uint32_t m_n_log_recs<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** specifies which operations should be logged; default value MTR_LOG_ALL 
日志模式，默认MTR_LOG_ALL*/</span>
mtr_log_t m_log_mode<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> UNIV_DEBUG</span>
<span class="token comment" spellcheck="true">/** Persistent user tablespace associated with the mini-transaction, or 0 (TRX_SYS_SPACE) if none yet 
用户表空间id*/</span>
ulint m_user_space_id<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">/* UNIV_DEBUG */</span>
<span class="token comment" spellcheck="true">/** User tablespace that is being modified by the
mini-transaction 
用户表空间 */</span>
fil_space_t<span class="token operator">*</span> m_user_space<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** Undo tablespace that is being modified by the
mini-transaction
undo表空间*/</span>
fil_space_t<span class="token operator">*</span> m_undo_space<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** System tablespace if it is being modified by the
mini-transaction
系统表空间*/</span>
fil_space_t<span class="token operator">*</span> m_sys_space<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** State of the transaction
事务状态*/</span>
mtr_state_t m_state<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** Owning mini-transaction */</span>
mtr_t<span class="token operator">*</span> m_mtr<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** Start a mini-transaction.*/</span>
<span class="token comment" spellcheck="true">//@param sync true if it is a synchronous mini-transaction</span>
<span class="token comment" spellcheck="true">//@param read_only true if read only mini-transaction */</span>
<span class="token comment" spellcheck="true">//mtr的start函数对mtr_t进行了初始化。</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">bool</span> sync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">bool</span> read_only <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
 <span class="token comment" spellcheck="true">/** Commit the mini-transaction. */</span>
 <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token keyword">private</span><span class="token operator">:</span>
<span class="token comment" spellcheck="true">/** Look up the system tablespace. */</span>
<span class="token keyword">void</span> <span class="token function">lookup_sys_space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** Look up the user tablespace.*/</span>
<span class="token comment" spellcheck="true">//@param[in] space_id tablespace ID</span>
<span class="token keyword">void</span> <span class="token function">lookup_user_space</span><span class="token punctuation">(</span>ulint space_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Command</span><span class="token punctuation">;</span>
<span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">Command</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
Impl m_impl<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** LSN at commit time */</span>
<span class="token keyword">volatile</span> lsn_t m_commit_lsn<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** true if it is synchronous mini-transaction */</span>
<span class="token keyword">bool</span> m_sync<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在整个<code>B+树</code>索引分裂这一个事务过程中，据调试分析应该是有<code>5</code>个<code>mtr</code>，下面我们来详细看看</p>
<p>我们从<code>row_ins_clust_index_entry_low</code>入口函数开始看起，第<code>2477</code>行我们能看到下面代码，即开启一个<code>mtr</code>，我们记之为<code>mtr-1</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315215852584.png" alt="image-20210315215852584"></p>
<blockquote>
<p>mtr_start主要包括：</p>
<ol>
<li>初始化mtr的各个<strong>状态变量</strong></li>
<li>默认模式为<strong>MTR_LOG_ALL</strong>，表示记录所有的数据变更</li>
<li>mtr状态设置为<strong>ACTIVE</strong>状态（MTR_STATE_ACTIVE）</li>
<li>为锁管理对象和日志管理对象<strong>初始化内存</strong>（mtr_buf_t）,<strong>初始化对象链表</strong></li>
</ol>
</blockquote>
<p>然后会执行下面一行代码：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    mtr<span class="token punctuation">.</span><span class="token function">set_named_space</span><span class="token punctuation">(</span>index<span class="token operator">-</span><span class="token operator">></span>space<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该方法是<code>MySQL5.7</code>新增的逻辑，将当前修改的表空间对象<code>fil_space_t</code>保存下来：如果是系统表空间，则赋值给<code>m_impl.m_sys_space</code>, 否则赋值给<code>m_impl.m_user_space</code></p>
<p>接着会对<code>index</code>加一个<code>S锁</code>（首先会尝试乐观插入）</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315220334295.png" alt="image-20210315220334295"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210317104223521.png" alt="image-20210317104223521"></p>
<p>接着找到预插入<code>page</code>对应的<code>block</code>将<code>block锁</code> <code>RW_S_LATCH</code> 入栈（m_memo）</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315220500299.png" alt="image-20210315220500299"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315220635936.png" alt="image-20210315220635936"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210317104547971.png" alt="image-20210317104547971"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210317104520539.png" alt="image-20210317104520539"></p>
<p>查看<code>memo_push</code>源码可以发现加锁入栈思路挺简单，就是根据锁类型和锁对象构建<code>mtr_memo_slot_t</code>然后加入到<code>m_impl.m_memo</code>中</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">==</span> MTR_MEMO_PAGE_X_FIX <span class="token operator">||</span> type <span class="token operator">==</span> MTR_MEMO_PAGE_SX_FIX<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> MTR_MEMO_BUF_FIX <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>m_impl<span class="token punctuation">.</span>m_made_dirty<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    mtr_memo_slot_t<span class="token operator">*</span>    slot<span class="token punctuation">;</span>
    slot <span class="token operator">=</span> m_impl<span class="token punctuation">.</span>m_memo<span class="token punctuation">.</span>push<span class="token operator">&lt;</span>mtr_memo_slot_t<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    slot<span class="token operator">-</span><span class="token operator">></span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
    slot<span class="token operator">-</span><span class="token operator">></span>object <span class="token operator">=</span> object<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>往下走，一直走到<code>trx_undo_report_row_operation</code>方法</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315221200846.png" alt="image-20210315221200846"></p>
<p>继续往下走，我们能看到开启了一个<code>mtr</code>，我们记之为<code>mtr-2</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315204722389.png" alt="image-20210315204722389"></p>
<p>主要用来记录<code>undo log</code>，接下往下走，会走到<code>trx_undo_assign_undo</code>方法</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315204922343.png" alt="image-20210315204922343"></p>
<p>我们跟进去看下，发现里面又开启了一个<code>mtr</code>，我们记之为<code>mtr-3</code>，它主要用来分配或者复用一个<code>undo log</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315205050182.png" alt="image-20210315205050182"></p>
<p>然后我们接着往下走，直到<code>trx_undo_reuse_cached</code>方法</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315205407084.png" alt="image-20210315205407084"></p>
<p>这里表示我们会先尝试复用<code>undo log</code>，复用失败的话，就分配新的<code>undo log</code>，我们跟到<code>trx_undo_reuse_cached</code>方法里面去，往下走，直到<code>trx_undo_page_get</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315205702300.png"></p>
<p>这里表示会去获取<code>undo log</code>和一个<code>x-latch</code>，最终会调用<code>buf_page_get_gen</code>方法，我们继续往下走，直到<code>mtr_memo_push</code>方法</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315210157470.png" alt="image-20210315210157470"></p>
<p>此时我们观察<code>fix_type</code>的值是<code>MTR_MEMO_PAGE_X_FIX</code>，对应的<code>rw_latch</code> 为 <code>RW_X_LATCH</code>，即我们把<code>undo log page</code>加<code>RW_X_LATCH</code>入栈</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315210239042.png" alt="image-20210315210239042"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315210441460.png" alt="image-20210315210441460"></p>
<p>接着，我们回溯至<code>trx_undo_reuse_cached</code>方法，接着往下走，直到<code>trx_undo_insert_header_reuse</code>方法</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315210649237.png" alt="image-20210315210649237"></p>
<p>该方法主要是用来写<code>undo log header</code>，就不细看了，然后我们接着往下走，直到<code>trx_undo_header_add_space_for_xid</code>方法</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315210919594.png" alt="image-20210315210919594"></p>
<p>该方法主要用来在<code>undo log header</code>中预留<code>XA事务</code>的<code>xid</code>空间</p>
<p><code>trx_undo_reuse_cached</code>至此关键代码都走完了，接着回溯至<code>trx_undo_assign_undo</code>方法，提交<code>mtr-3</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315211237454.png" alt="image-20210315211237454"></p>
<p>然后我们接着回溯至<code>trx_undo_report_row_operation</code>方法，接着往下走，直到<code>buf_page_get_gen</code>方法</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315212604618.png" alt="image-20210315212604618"></p>
<p>跟进去然后走到<code>mtr_memo_push</code>方法</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315221736270.png" alt="image-20210315221736270"></p>
<p>即将写入的 <code>undo log page</code> 加 <code>RW_X_LATCH</code> 入栈，接着回溯至<code>trx_undo_report_row_operation</code>，然后往下走，直到<code>trx_undo_page_report_insert</code>方法<img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315213348452.png" alt="image-20210315213348452"></p>
<p>该方法主要是<code>undo log</code>记录<code>insert</code>操作，接着往下走，提交<code>mtr-2</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315214123709.png" alt="image-20210315214123709"></p>
<p><code>mtr-2</code>提交完之后，回溯至<code>btr_cur_pessimistic_insert</code>方法，开始分裂，最后尝试插入记录<code>page_cur_tuple_insert</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315225322127.png" alt="image-20210315225322127"></p>
<p>我们跟进去，走到<code>page_cur_insert_rec_low</code>，执行具体<code>insert</code>操作</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315225601780.png" alt="image-20210315225601780"></p>
<p>跟进去，走到<code>page_cur_insert_rec_write_log</code>方法，写<code>insert</code>操作的<code>redo log</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315230014265.png" alt="image-20210315230014265"></p>
<p>接下来我们跟到<code>page_cur_insert_rec_write_log</code>方法里去看看<code>redo log</code>到底怎么写的</p>
<p><strong>第一步</strong>：会调用方法<code>mlog_open_and_write_index</code>记录索引相关信息</p>
<p>1）调用<code>mlog_open</code>，分配足够日志写入的内存地址，并返回内存指针</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">ulint    n    <span class="token operator">=</span> <span class="token function">dict_index_get_n_fields</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
ulint    total    <span class="token operator">=</span> <span class="token number">11</span> <span class="token operator">+</span> size <span class="token operator">+</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
ulint    alloc    <span class="token operator">=</span> total<span class="token punctuation">;</span>
log_start <span class="token operator">=</span> log_ptr <span class="token operator">=</span> <span class="token function">mlog_open</span><span class="token punctuation">(</span>mtr<span class="token punctuation">,</span> alloc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）调用<code>mlog_write_initial_log_record_fast</code>，初始化日志记录</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">log_ptr <span class="token operator">=</span> <span class="token function">mlog_write_initial_log_record_fast</span><span class="token punctuation">(</span>rec<span class="token punctuation">,</span> type<span class="token punctuation">,</span> log_ptr<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3)存储当前索引列数<code>n</code>到<code>log_ptr</code>里面，占两个字节</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">mach_write_to_2</span><span class="token punctuation">(</span>log_ptr<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
log_ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>4)写入行记录上决定唯一性的列的个数，占两个字节</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_is_leaf</span><span class="token punctuation">(</span><span class="token function">page_align</span><span class="token punctuation">(</span>rec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//对于聚集索引，就是PK上的列数</span>
    <span class="token function">mach_write_to_2</span><span class="token punctuation">(</span>log_ptr<span class="token punctuation">,</span> <span class="token function">dict_index_get_n_unique_in_tree</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//对于二级索引，就是二级索引列 + PK列个数</span>
    <span class="token function">mach_write_to_2</span><span class="token punctuation">(</span>log_ptr<span class="token punctuation">,</span> <span class="token function">dict_index_get_n_unique_in_tree_nonleaf</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
log_ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>5)写入每个列的长度信息，每个列占两个字节</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">mach_write_to_2</span><span class="token punctuation">(</span>log_ptr<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
log_ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>第二步</strong>：写入记录在<code>page</code>上的偏移量，占两个字节</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210317113611064.png" alt="image-20210317113611064"></p>
<p><strong>第三步</strong>：写入记录其它相关信息，包括<code>rec size、info bits、extra_size</code></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token comment" spellcheck="true">/* Write the record end segment length and the extra info storage flag */</span>
        log_ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">mach_write_compressed</span><span class="token punctuation">(</span>log_ptr<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>rec_size <span class="token operator">-</span> i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* Write the info bits */</span>
        <span class="token function">mach_write_to_1</span><span class="token punctuation">(</span>log_ptr<span class="token punctuation">,</span>
                <span class="token function">rec_get_info_and_status_bits</span><span class="token punctuation">(</span>
                    insert_rec<span class="token punctuation">,</span>
                    <span class="token function">page_rec_is_comp</span><span class="token punctuation">(</span>insert_rec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log_ptr<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* Write the record origin offset */</span>
        log_ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">mach_write_compressed</span><span class="token punctuation">(</span>log_ptr<span class="token punctuation">,</span> extra_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* Write the mismatch index */</span>
        log_ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">mach_write_compressed</span><span class="token punctuation">(</span>log_ptr<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们发现这里采用了压缩写入的方法<code>mach_write_compressed</code>，我们阅读<code>mach_write_compressed</code>源码可以发现，它是根据写入数字<code>n</code>的大小来选定1到4个字节来记录整数，从而可以节省<code>redo log</code>空间</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* 0nnnnnnn (7 bits) */</span>
    <span class="token function">mach_write_to_1</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0x4000</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* 10nnnnnn nnnnnnnn (14 bits) */</span>
    <span class="token function">mach_write_to_2</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> n <span class="token operator">|</span> <span class="token number">0x8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0x200000</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* 110nnnnn nnnnnnnn nnnnnnnn (21 bits) */</span>
    <span class="token function">mach_write_to_3</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> n <span class="token operator">|</span> <span class="token number">0xC00000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0x10000000</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* 1110nnnn nnnnnnnn nnnnnnnn nnnnnnnn (28 bits) */</span>
    <span class="token function">mach_write_to_4</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> n <span class="token operator">|</span> <span class="token number">0xE0000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* 11110000 nnnnnnnn nnnnnnnn nnnnnnnn nnnnnnnn (32 bits) */</span>
    <span class="token function">mach_write_to_1</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0xF0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mach_write_to_4</span><span class="token punctuation">(</span>b <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>第四步</strong>： 将插入的记录拷贝到<code>redo</code>文件，同时关闭<code>mlog</code></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">memcpy</span><span class="token punctuation">(</span>log_ptr<span class="token punctuation">,</span> ins_ptr<span class="token punctuation">,</span> rec_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mlog_close</span><span class="token punctuation">(</span>mtr<span class="token punctuation">,</span> log_ptr <span class="token operator">+</span> rec_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>接下来我们来看看<code>mtr</code>的提交过程，入口函数为<code>mtr_t::commit()</code>，当修改产生脏页或者日志记录时，调用<code>mtr_t::Command::execute</code></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/** Write the redo log record, add dirty pages to the flush list and release
the resources. 
写redo log，添加脏页到flush list，释放资源*/</span>
<span class="token keyword">void</span> mtr_t<span class="token operator">::</span>Command<span class="token operator">::</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">ut_ad</span><span class="token punctuation">(</span>m_impl<span class="token operator">-</span><span class="token operator">></span>m_log_mode <span class="token operator">!=</span> MTR_LOG_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">const</span> ulint len <span class="token operator">=</span> <span class="token function">prepare_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">finish_write</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_impl<span class="token operator">-</span><span class="token operator">></span>m_made_dirty<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">log_flush_order_mutex_enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* It is now safe to release the log mutex because the
    flush_order mutex will ensure that we are the first one
    to insert into the flush list. */</span>
    <span class="token function">log_mutex_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_impl<span class="token operator">-</span><span class="token operator">></span>m_mtr<span class="token operator">-</span><span class="token operator">></span>m_commit_lsn <span class="token operator">=</span> m_end_lsn<span class="token punctuation">;</span>
    <span class="token function">release_blocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_impl<span class="token operator">-</span><span class="token operator">></span>m_made_dirty<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">log_flush_order_mutex_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token function">release_latches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">release_resources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行过程如下：</p>
<p><strong>第一步</strong>：调用<code>mtr_t::Command::prepare_write()</code>，准备写<code>m_log</code>到<code>redo log buffer</code></p>
<p>1）若当前<code>m_log_mode</code>为<code>MTR_LOG_NO_REDO</code>或者<code>MTR_LOG_NONE</code>，则获取<code>log_sys-&gt;mutex</code>，然后返回</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">case</span> MTR_LOG_NO_REDO<span class="token operator">:</span>
<span class="token keyword">case</span> MTR_LOG_NONE<span class="token operator">:</span>
    <span class="token function">ut_ad</span><span class="token punctuation">(</span>m_impl<span class="token operator">-</span><span class="token operator">></span>m_log<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">log_mutex_enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_end_lsn <span class="token operator">=</span> m_start_lsn <span class="token operator">=</span> log_sys<span class="token operator">-</span><span class="token operator">></span>lsn<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）若当前要写入<code>redo log</code>记录大小超过<code>log buffer</code>的一半，将<code>log buffer</code>扩大为原来两倍</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">></span> log_sys<span class="token operator">-</span><span class="token operator">></span>buf_size <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">log_buffer_extend</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>3）获取<code>log_sys-&gt;mutex</code>锁</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">log_mutex_enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>4）调用函数<code>fil_names_write_if_was_clean</code>检查本次修改的表空间是否是上次<code>checkpoint</code>后第一次修改</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">bool</span>    was_clean <span class="token operator">=</span> space<span class="token operator">-</span><span class="token operator">></span>max_lsn <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">ut_ad</span><span class="token punctuation">(</span>space<span class="token operator">-</span><span class="token operator">></span>max_lsn <span class="token operator">&lt;=</span> log_sys<span class="token operator">-</span><span class="token operator">></span>lsn<span class="token punctuation">)</span><span class="token punctuation">;</span>
space<span class="token operator">-</span><span class="token operator">></span>max_lsn <span class="token operator">=</span> log_sys<span class="token operator">-</span><span class="token operator">></span>lsn<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//首先会将space->max_lsn赋值为log_sys->lsn</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>was_clean<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//即space->max_lsn == 0，表示自上次checkpoint后第一次修改该表空间，调用fil_names_dirty_and_write将该tablespace加入到fil_system->named_spaces链表上，同时调用fil_names_write写入一条类型为MLOG_FILE_NAME的日志</span>
    <span class="token function">fil_names_dirty_and_write</span><span class="token punctuation">(</span>space<span class="token punctuation">,</span> mtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* This was not the first time of dirtying a
        tablespace since the latest checkpoint. 
        不是从上一次checkpoint后第一次修改该表，则根据mtr中log的个数，选择标识日志头最高位为MLOG_SINGLE_REC_FLAG，或者附加一个1字节的        MLOG_MULTI_REC_END日志。*/</span>
        <span class="token function">ut_ad</span><span class="token punctuation">(</span>n_recs <span class="token operator">==</span> m_impl<span class="token operator">-</span><span class="token operator">></span>m_n_log_recs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n_recs <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">ut_ad</span><span class="token punctuation">(</span>n_recs <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/* Flag the single log record as the
            only record in this mini-transaction. */</span>
            <span class="token operator">*</span>m_impl<span class="token operator">-</span><span class="token operator">></span>m_log<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">|</span><span class="token operator">=</span> MLOG_SINGLE_REC_FLAG<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/* Because this mini-transaction comprises
            multiple log records, append MLOG_MULTI_REC_END
            at the end. */</span>
            <span class="token function">mlog_catenate_ulint</span><span class="token punctuation">(</span>
                <span class="token operator">&amp;</span>m_impl<span class="token operator">-</span><span class="token operator">></span>m_log<span class="token punctuation">,</span> MLOG_MULTI_REC_END<span class="token punctuation">,</span>
                MLOG_1BYTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            len<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>5）调用函数<code>log_margin_checkpoint_age</code>检查本次写入</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/* check and attempt a checkpoint if exceeding capacity */</span>
<span class="token function">log_margin_checkpoint_age</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    ulint    margin <span class="token operator">=</span> <span class="token function">log_calculate_actual_len</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>margin <span class="token operator">></span> log_sys<span class="token operator">-</span><span class="token operator">></span>log_group_capacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* return with warning output to avoid deadlock 
        如果margin size超过redo log文件capacity，则打印一条错误信息*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>log_has_printed_chkp_margine_warning
            <span class="token operator">||</span> <span class="token function">difftime</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                log_last_margine_warning_time<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            log_has_printed_chkp_margine_warning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            log_last_margine_warning_time <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ib<span class="token operator">::</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"The transaction log files are too"</span>
                <span class="token string">" small for the single transaction log (size="</span>
                <span class="token operator">&lt;&lt;</span> len <span class="token operator">&lt;&lt;</span> <span class="token string">"). So, the last checkpoint age"</span>
                <span class="token string">" might exceed the log group capacity "</span>
                <span class="token operator">&lt;&lt;</span> log_sys<span class="token operator">-</span><span class="token operator">></span>log_group_capacity <span class="token operator">&lt;&lt;</span> <span class="token string">"."</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Our margin check should ensure that we never reach this condition.
    Try to do checkpoint once. We cannot keep waiting here as it might
    result in hang in case the current mtr has latch on oldest lsn */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>log_sys<span class="token operator">-</span><span class="token operator">></span>lsn <span class="token operator">-</span> log_sys<span class="token operator">-</span><span class="token operator">></span>last_checkpoint_lsn <span class="token operator">+</span> margin
        <span class="token operator">></span> log_sys<span class="token operator">-</span><span class="token operator">></span>log_group_capacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* The log write of 'len' might overwrite the transaction log
        after the last checkpoint. Makes checkpoint. 
        若本次写入可能覆盖检查点，还需要去强制做一次同步checkpoint*/</span>
        <span class="token keyword">bool</span>    flushed_enough <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>log_sys<span class="token operator">-</span><span class="token operator">></span>lsn <span class="token operator">-</span> <span class="token function">log_buf_pool_get_oldest_modification</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">+</span> margin
            <span class="token operator">&lt;=</span> log_sys<span class="token operator">-</span><span class="token operator">></span>log_group_capacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            flushed_enough <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        log_sys<span class="token operator">-</span><span class="token operator">></span>check_flush_or_checkpoint <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">log_mutex_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">DEBUG_SYNC_C</span><span class="token punctuation">(</span><span class="token string">"margin_checkpoint_age_rescue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushed_enough<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">os_thread_sleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token function">log_checkpoint</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">log_mutex_enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>第二步</strong>：调用<code>mtr_t::Command::finish_write</code>，将日志从mtr中拷贝到公共<code>log buffer</code>，这里有两种方式</p>
<p>1）如果<code>mtr</code>中日志较小，则调用函数<code>log_reserve_and_write_fast</code>尝试将日志拷贝到<code>log buffer</code>最近的一个<code>block</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210317131225532.png" alt="image-20210317131225532"></p>
<p>2）检查是否有足够的空闲空间后，返回当前的<code>lsn</code>赋值给<code>m_start_lsn</code>（<code>log_reserve_and_open(len)</code>），随后将日志记录写入到<code>log buffer</code>中</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token comment" spellcheck="true">/* Open the database log for log_write_low */</span>
    m_start_lsn <span class="token operator">=</span> <span class="token function">log_reserve_and_open</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mtr_write_log_t    write_log<span class="token punctuation">;</span>
    m_impl<span class="token operator">-</span><span class="token operator">></span>m_log<span class="token punctuation">.</span><span class="token function">for_each_block</span><span class="token punctuation">(</span>write_log<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）在完成将<code>redo</code> 拷贝到<code>log buffer</code>后，需要调用<code>log_close</code>, 如果最后一个<code>block</code>未写满，则设置该<code>block</code>头部的<code>LOG_BLOCK_FIRST_REC_GROUP</code>信息</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">first_rec_group <span class="token operator">=</span> <span class="token function">log_block_get_first_rec_group</span><span class="token punctuation">(</span>log_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>first_rec_group <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* We initialized a new log block which was not written
        full by the current mtr: the next mtr log record group
        will start within this block at the offset data_len */</span>
        <span class="token function">log_block_set_first_rec_group</span><span class="token punctuation">(</span>
            log_block<span class="token punctuation">,</span> <span class="token function">log_block_get_data_len</span><span class="token punctuation">(</span>log_block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token operator">-</span><span class="token operator">></span>buf_free <span class="token operator">></span> log<span class="token operator">-</span><span class="token operator">></span>max_buf_free<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        log<span class="token operator">-</span><span class="token operator">></span>check_flush_or_checkpoint <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    checkpoint_age <span class="token operator">=</span> lsn <span class="token operator">-</span> log<span class="token operator">-</span><span class="token operator">></span>last_checkpoint_lsn<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>checkpoint_age <span class="token operator">>=</span> log<span class="token operator">-</span><span class="token operator">></span>log_group_capacity<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>log_has_printed_chkp_warning
            <span class="token operator">||</span> <span class="token function">difftime</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> log_last_warning_time<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            log_has_printed_chkp_warning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            log_last_warning_time <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ib<span class="token operator">::</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"The age of the last checkpoint is "</span>
                <span class="token operator">&lt;&lt;</span> checkpoint_age <span class="token operator">&lt;&lt;</span> <span class="token string">", which exceeds the log"</span>
                <span class="token string">" group capacity "</span> <span class="token operator">&lt;&lt;</span> log<span class="token operator">-</span><span class="token operator">></span>log_group_capacity
                <span class="token operator">&lt;&lt;</span> <span class="token string">"."</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>checkpoint_age <span class="token operator">&lt;=</span> log<span class="token operator">-</span><span class="token operator">></span>max_modified_age_sync<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> function_exit<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    oldest_lsn <span class="token operator">=</span> <span class="token function">buf_pool_get_oldest_modification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/*
满足如下情况时，设置log_sys->check_flush_or_checkpoint为true：
1、当前bp中最老lsn为0 （没有脏页）
2、bp中最老lsn和当前lsn的距离超过log_sys->max_modified_age_sync
3、当前未checkpoint的lsn age超过log_sys->max_checkpoint_age_async

当check_flush_or_checkpoint被设置时，用户线程在每次修改数据前调用log_free_check时，会根据该标记决定是否刷redo日志或者脏页
*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldest_lsn
        <span class="token operator">||</span> lsn <span class="token operator">-</span> oldest_lsn <span class="token operator">></span> log<span class="token operator">-</span><span class="token operator">></span>max_modified_age_sync
        <span class="token operator">||</span> checkpoint_age <span class="token operator">></span> log<span class="token operator">-</span><span class="token operator">></span>max_checkpoint_age_async<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        log<span class="token operator">-</span><span class="token operator">></span>check_flush_or_checkpoint <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>第三步</strong>：如果本次修改产生了脏页，获取<code>log_sys-&gt;log_flush_order_mutex</code>，随后释放<code>log_sys-&gt;mutex</code></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>m_impl<span class="token operator">-</span><span class="token operator">></span>m_made_dirty<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">log_flush_order_mutex_enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* It is now safe to release the log mutex because the
    flush_order mutex will ensure that we are the first one
    to insert into the flush list. */</span>
<span class="token function">log_mutex_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>第四步</strong>： 将当前<code>mtr</code>修改的脏页加入到<code>flush list</code>上，<strong>脏页上记录的lsn为当前mtr写入的结束点lsn</strong>。基于上述加锁逻辑，能够保证<code>flush list</code>上的脏页总是以<code>lsn</code>排序。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">m_impl<span class="token operator">-</span><span class="token operator">></span>m_mtr<span class="token operator">-</span><span class="token operator">></span>m_commit_lsn <span class="token operator">=</span> m_end_lsn<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>第五步</strong>：释放<code>log_sys-&gt;log_flush_order_mutex</code>锁</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>m_impl<span class="token operator">-</span><span class="token operator">></span>m_made_dirty<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">log_flush_order_mutex_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>第六步</strong>：释放当前mtr持有的锁和相关资源</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">release_latches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">release_resources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后回溯到<code>row_ins_clust_index_entry_low</code>方法，提交<code>mtr-1</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315230229786.png" alt="image-20210315230229786"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315230413641.png" alt="image-20210315230413641"></p>
<p>这样<code>insert</code>语句就执行完毕了，接下来进行事务提交，会有两个<code>mtr</code></p>
<p>第一个<code>mtr</code>从<code>trx_prepare_low</code>开始</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315234300639.png" alt="image-20210315234300639"></p>
<p>走到<code>mtr_start_sync</code>会启动一个<code>mtr</code>，我们记之为<code>mtr-4</code>，主要用于<code>prepare</code>事务</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315234335143.png" alt="image-20210315234335143"></p>
<p>接着往下走，会走到<code>trx_undo_set_state_at_prepare</code>方法</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315234544943.png" alt="image-20210315234544943"></p>
<p>我们跟进去，最后会走到<code>buf_page_get_gen</code>方法</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315234844001.png" alt="image-20210315234844001"></p>
<p>再次给<code>undo page</code> 加 <code>RW_X_LATCH</code> 入栈</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315235008175.png" alt="image-20210315235008175"></p>
<p>接着回溯至<code>trx_undo_set_state_at_prepare</code>方法，继续往下走，会依次写入<code>TRX_UNDO_STATE、TRX_UNDO_XID_EXISTS、xid</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315235321267.png" alt="image-20210315235321267"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315235345755.png" alt="image-20210315235345755"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315235405534.png" alt="image-20210315235405534"></p>
<p>然后，返回回溯至<code>trx_prepare_low</code>方法，提交<code>mtr-4</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315235523933.png" alt="image-20210315235523933"></p>
<p>至此，<code>prepare</code>阶段就结束了，接下来会进入<code>commit</code>阶段</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315235916346.png" alt="image-20210315235916346"></p>
<p>进入<code>trx_commit</code>方法，往下走到<code>mtr_start_sync</code>方法，会开启一个<code>mtr</code>，我们记之为<code>mtr-5</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210315235929716.png" alt="image-20210315235929716"></p>
<p>之后我们走到<code>trx_undo_set_state_at_finish</code>，其调用链如下：</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210316000231627.png" alt="image-20210316000231627"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210316000258827.png" alt="image-20210316000258827"></p>
<p>最后会调用<code>mtr_memo_push</code>方法给<code>undo log</code>加<code>RW_X_LATCH</code>入栈</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210316000713076.png" alt="image-20210316000713076"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210316000725973.png" alt="image-20210316000725973"></p>
<p>接着我们回溯到<code>trx_write_serialisation_history</code>方法</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210316001238065.png" alt="image-20210316001238065"></p>
<p>往下走，直到<code>trx_sys_update_mysql_binlog_offset</code>方法，该方法主要用来更新偏移量信息到系统表空间</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210316001356451.png" alt="image-20210316001356451"></p>
<p>跟进去，往下走，最后会通过<code>mtr_memo_push</code>将系统表空间 <code>transaction system header page</code> 加 <code>RW_X_LATCH</code> 入栈</p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210316001739088.png" alt="image-20210316001739088"></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210316001855609.png" alt="image-20210316001855609"></p>
<p>然后回溯至<code>trx_commit_low</code>方法，提交<code>mtr-5</code></p>
<p><img src="https://zhangqu-oss.oss-cn-zhangjiakou.aliyuncs.com/img/image-20210316002049765.png" alt="image-20210316002049765"></p>
<p>至此，本次<code>insert</code>导致<code>B+树</code>索引分裂涉及的<code>mtr</code>全部结束了</p>

            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《20210317》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2021/04/08/20210317/" property="cc:attributionName"
               rel="cc:attributionURL">
                JavaGuy
            </a> 采用
            <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: 'GgssQFlBBeYrJoL1y5s8jXeR-gzGzoHsz',
        appKey: 'kXYkbr7xencqP3PxqQNKykdt',
        notify: 'true' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/04/08/20210324/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="20210324">
                        
                        <span class="card-title">20210324</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            任务合力学习多SE版本，包括：

多SE版的安装、分布式部署、测试
Quorum+Gossip原理解读
多SE设计文档学习和源码解读

1、搭建多SE环境和简单测试1.1、CLion编译build代码1.1.1、cmake参数配置在file
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-04-08
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Lab/" class="post-category" target="_blank">
                                    Lab
                                </a>
                            
                            <a href="/categories/Lab/%E5%91%A8%E4%BC%9A%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" class="post-category" target="_blank">
                                    周会总结报告
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MSE/" target="_blank">
                        <span class="chip bg-color">MSE</span>
                    </a>
                    
                    <a href="/tags/Quorum/" target="_blank">
                        <span class="chip bg-color">Quorum</span>
                    </a>
                    
                    <a href="/tags/Gossip/" target="_blank">
                        <span class="chip bg-color">Gossip</span>
                    </a>
                    
                    <a href="/tags/Aurora/" target="_blank">
                        <span class="chip bg-color">Aurora</span>
                    </a>
                    
                    <a href="/tags/CAP/" target="_blank">
                        <span class="chip bg-color">CAP</span>
                    </a>
                    
                    <a href="/tags/ACID/" target="_blank">
                        <span class="chip bg-color">ACID</span>
                    </a>
                    
                    <a href="/tags/BASE/" target="_blank">
                        <span class="chip bg-color">BASE</span>
                    </a>
                    
                    <a href="/tags/NWR/" target="_blank">
                        <span class="chip bg-color">NWR</span>
                    </a>
                    
                    <a href="/tags/%E6%97%A5%E5%BF%97%E5%8D%B3%E6%95%B0%E6%8D%AE%E5%BA%93/" target="_blank">
                        <span class="chip bg-color">日志即数据库</span>
                    </a>
                    
                    <a href="/tags/%E9%80%9A%E4%BF%A1/" target="_blank">
                        <span class="chip bg-color">通信</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/04/08/20210310/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/10.jpg" class="responsive-img" alt="20210310">
                        
                        <span class="card-title">20210310</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            任务：
再细看事务，在一个事务中，构造B树分裂或者合并场景，看MySQL是如何实现的。

1、B+树索引分裂入口函数是：storage/innobase/row/row0ins.cc下的row_ins_index_entry，分为聚集索引和
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-04-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Lab/" class="post-category" target="_blank">
                                    Lab
                                </a>
                            
                            <a href="/categories/Lab/%E5%91%A8%E4%BC%9A%E6%80%BB%E7%BB%93%E6%8A%A5%E5%91%8A/" class="post-category" target="_blank">
                                    周会总结报告
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/B-%E6%A0%91/" target="_blank">
                        <span class="chip bg-color">B+树</span>
                    </a>
                    
                    <a href="/tags/%E7%B4%A2%E5%BC%95%E5%88%86%E8%A3%82/" target="_blank">
                        <span class="chip bg-color">索引分裂</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: JavaGuy的博客<br />'
            + '作者: JavaGuy<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

<!-- <script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'artDetail',
        blogId: '20962-1585405055583-879',
        name: '算法码上来',
        qrcode: 'https://godweiyang.com/medias/gzh.jpg',
        keyword: 'VIP',
    });
</script> -->

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5, h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5, h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; ZhangQu. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">285.4k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zhangqu999" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:zhang1842279380@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>





    <a href="http://wpa.qq.com/msgrd?v=3&uin=1842279380&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 1000;
        var uvcountOffset = 200;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 03, 18, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    
    <script type="text/javascript" src="/libs/others/snow.js"></script>
    

</body>

</html>